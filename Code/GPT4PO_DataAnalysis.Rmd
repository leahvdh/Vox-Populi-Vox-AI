---
title: 'GPT for Public Opinion: Data Analysis'
author: "Leah von der Heyde, Alexander Wenz, Carolina Haensch"
date: "`r Sys.Date()`"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
library(nnet)
library(ggstats)
library(ggtext)
#library(coefplot)
#library(stargazer)
library(vtable)
library(ggh4x)
library(marginaleffects)
options(scipen = 999)

#load("GPT4PO_data_complete_2017.Rdata")
```

# Data Transformation

For regression analyses:
- Excluded 78 NAs (missing GPT predictions) from regression models for comparability
- Treated variables with min. 5 categories as numeric
- partyid_degree*partyid, as strength and direction of partisanship logically interact

```{r}
data_final_factors <- mc_GLES2017_final %>%
                      mutate(
    female = factor(female,
                    levels = c("männlich","weiblich"),
                    labels = c("männlich","weiblich")),
    edu = factor(edu,
                 levels = c("keinen Schulabschluss",
                            "einen Hauptschulabschluss",
                            "einen Realschulabschluss",
                            "Abitur",
                            "einen Hochschulabschluss"), 
                 labels = c("keinen Schulabschluss",
                            "einen Hauptschulabschluss",
                            "einen Realschulabschluss",
                            "Abitur",
                            "einen Hochschulabschluss"),
                 ordered = FALSE),
    emp = factor(emp,
                 levels = c("berufstätig",
                            "nicht berufstätig",
                            "in Ausbildung"),
                 labels = c("berufstätig",
                            "nicht berufstätig",
                            "in Ausbildung")),
    hhincome = factor(hhincome,
                      levels = c("niedriges", "mittleres", "hohes"), 
                      labels = c("niedriges", "mittleres", "hohes"),
                      ordered = FALSE),
    east = factor(east,
                  levels = c("Westdeutschland",
                             "Ostdeutschland"),
                  labels = c("Westdeutschland",
                             "Ostdeutschland")),
    religious = factor(religious,
                       levels = c("überhaupt nicht religiös",
                                  "nicht sehr religiös",
                                  "etwas religiös",
                                  "sehr religiös"), 
                       labels = c("überhaupt nicht religiös",
                                  "nicht sehr religiös",
                                  "etwas religiös",
                                  "sehr religiös"),
                       ordered = FALSE),
    leftright = factor(leftright,
                       levels = c("stark links",
                                  "mittig links",
                                  "in der Mitte",
                                  "mittig rechts",
                                  "stark rechts"),
                       labels = c("stark links",
                                  "mittig links",
                                  "in der Mitte",
                                  "mittig rechts",
                                  "stark rechts"),
                       ordered = FALSE),
    partyid = factor(partyid,
                     levels = c("mit der Partei CDU/CSU",
                                "mit der Partei SPD", 
                                "mit der Partei FDP",
                                "mit der Partei Bündnis 90/Die Grünen",
                                "mit der Partei Die Linke",
                                "mit der Partei AfD",
                                "mit einer Kleinpartei",
                                "mit keiner Partei"),
                     labels = c("CDU/CSU",
                                "SPD", 
                                "FDP",
                                "Die Grünen",
                                "Die Linke",
                                "AfD",
                                "Kleinpartei",
                                "keine Partei")),
    partyid_degree = ifelse(partyid_degree == "", "überhaupt nicht", partyid_degree), # NAs to zero
    partyid_degree = factor(partyid_degree,
                            levels = c("überhaupt nicht",
                                       "sehr schwach ",
                                       "ziemlich schwach ",
                                       "mäßig ",
                                       "ziemlich stark ",
                                       "sehr stark "),
                            labels = c("überhaupt nicht",
                                       "sehr schwach",
                                       "ziemlich schwach",
                                       "mäßig",
                                       "ziemlich stark",
                                       "sehr stark"),
                            ordered = FALSE),
    inequality = factor(inequality,
                        levels = c("Maßnahmen ergreifen",
                                   "habe keine Meinung dazu, ob die Regierung Maßnahmen ergreifen sollte",
                                   "keine Maßnahmen ergreifen"),
                        labels = c("Maßnahmen ergreifen",
                                   "habe keine Meinung dazu",
                                   "keine Maßnahmen ergreifen"),
                        ordered = FALSE),
    immigration = factor(immigration,
                         levels = c("erleichtern",
                                    "weder erleichtern noch einschränken",
                                    "einschränken"), 
                         labels = c("erleichtern",
                                    "weder erleichtern noch einschränken",
                                    "einschränken"),
                         ordered = FALSE),
    vote = factor(vote,
                  levels = c("CDU/CSU",
                             "SPD",
                             "Bündnis 90/Die Grünen",
                             "FDP",
                             "Die Linke",
                             "AfD",
                             "Andere Partei",
                             "Ungültig gewählt",
                             "Nicht gewählt"),
                  labels = c("CDU/CSU",
                             "SPD",
                             "Bündnis 90/Die Grünen",
                             "FDP",
                             "Die Linke",
                             "AfD",
                             "Andere Partei",
                             "Ungültig gewählt",
                             "Nicht gewählt")),
    vote_gpt = factor(vote_gpt,
                      levels = c("CDU/CSU",
                             "SPD",
                             "Bündnis 90/Die Grünen",
                             "FDP",
                             "Die Linke",
                             "AfD",
                             "Andere Partei",
                             "Ungültig gewählt",
                             "Nicht gewählt"),
                      labels = c("CDU/CSU",
                             "SPD",
                             "Bündnis 90/Die Grünen",
                             "FDP",
                             "Die Linke",
                             "AfD",
                             "Andere Partei",
                             "Ungültig gewählt",
                             "Nicht gewählt"))
                      )
# Transform variables with 5 categories to numeric
data_final_numeric <- data_final_factors %>%
                      mutate(
                        edu = ifelse(edu == "keinen Schulabschluss", 0,
                                     ifelse(edu == "einen Hauptschulabschluss", 1,
                                            ifelse(edu == "einen Realschulabschluss", 2,
                                                   ifelse(edu == "Abitur", 3,
                                                          ifelse(edu == "einen Hochschulabschluss", 4,
                                                                 NA))))),
                        leftright = ifelse(leftright == "stark links", -2,
                                           ifelse(leftright == "mittig links", -1,
                                                  ifelse(leftright == "in der Mitte", 0,
                                                         ifelse(leftright == "mittig rechts", 1,
                                                                ifelse(leftright == "stark rechts", 2,
                                                                       NA))))),
                        partyid_degree = ifelse(partyid_degree == "überhaupt nicht", 0,
                                                ifelse(partyid_degree == "sehr schwach", 1,
                                                       ifelse(partyid_degree == "ziemlich schwach", 2,
                                                              ifelse(partyid_degree == "mäßig", 3,
                                                                     ifelse(partyid_degree == "ziemlich stark", 4,
                                                                            ifelse(partyid_degree == "sehr stark", 5,
                                                                                   NA))))))
                      )

# Removing respondents that have at least one NA in gpt_vote (for comparability between samples)

data_final_numeric_noNA <- data_final_numeric %>%
                           drop_na("vote_gpt") %>% 
                           group_by(id) %>%
                           filter(sum(id)/5==id) %>%
                           ungroup()
```

# MATCHING: Prediction between GPT and GLES

Can LLMs accurately emulate response distributions of population subgroups?

## Aggregate: Shares of correct and incorrect matches overall

### Tables

```{r}
# Overall
table_matches_overall_c <- table(mc_GLES2017_final$match_vote_outcome)
table_matches_overall_s <- prop.table(table_matches_overall_c)

data_matches_overall_s <- as.data.frame(table_matches_overall_s)
data_matches_overall_s <- data_matches_overall_s %>%
                          mutate(sample = "Overall") %>%
                          rename(match = Var1)

# Per sample
table_matches_counts <- table(mc_GLES2017_final$match_vote_outcome, mc_GLES2017_final$sample_no)
table_matches_shares <- prop.table(table_matches_counts, 2)

data_matches_shares <- as.data.frame(table_matches_shares)
data_matches_shares <- data_matches_shares %>%
                       rename(sample = Var2) %>%
                       rename(match = Var1)
# Together
data_matches_shares_all <- bind_rows(data_matches_overall_s, data_matches_shares)
data_matches_shares_all <- data_matches_shares_all %>%
                           mutate(sample = factor(sample, 
                                  levels = c("Overall", "1", "2", "3", "4", "5"),
                                  labels = c("Overall", "1", "2", "3", "4", "5")))
```

### Plot

```{r}
plot_matches <- ggplot(data_matches_shares_all,
                       aes(x = sample,
                           y = Freq,
                           fill = match)) +
                      geom_bar(stat = "identity", position = "stack") +
                      geom_text(aes(label = paste0(round(Freq*100,1),"%")), 
                                position = position_fill(0.5), color = c(rep(c("white", "black"), 6))) +
                      xlab("Sample") +
                      ylab("") +
                      scale_fill_manual(values = c("FALSE" = "#012340", "TRUE" = "#03A63C"), 
                                        labels = c("different", "match"),
                                        name = "GPT Prediction") +
                      scale_y_continuous(labels = scales::percent) +
                      ggtitle("") +
                      theme_minimal()

ggsave("matches.png", plot_matches, height = 6, width = 8)
```

```{r}
plot_matches
```

### Variance Estimation

```{r}
# Calculate proportions and its variance for each iteration
sample_proportions_match <- mc_GLES2017_final %>%
    group_by(sample_no, match_vote_outcome) %>%
    summarise(n = n(), .groups = "keep") %>%
    ungroup(match_vote_outcome) %>%
    mutate(prop_estimate = n / sum(n)) %>%
    mutate(prop_variance = prop_estimate * (1 - prop_estimate) / sum(n))

# Calculate the between-iteration variance and total variance
mean_proportions_match <- sample_proportions_match %>%
    group_by(match_vote_outcome) %>%
    summarise(W = mean(prop_variance), # Within variance (mean)
              mean_prop = mean(prop_estimate),
              B = var(prop_estimate)) %>% # Between variance
    mutate(m = 5,
           T = W + (1 + 1/m) * B,
           T_stderr= sqrt(T)) %>% # total variance (Rubin's rules) 
    arrange(desc(mean_prop))
```

- There is very little variance across samples
- In 54% of cases, the GPT prediction does not match the person's GLES vote
- No need to plot variance estimation as there is so little variance (see above)

## Aggregate: Recall - Shares of correct and incorrect matches by GLES party vote

### Tables

```{r}
# Across samples
table_matches_parties_s <- prop.table(table(mc_GLES2017_final$vote, mc_GLES2017_final$match_vote_outcome), 1)

# Sample 1
table_matches_parties_s_1 <- prop.table(table(mc_GLES2017_final$vote[mc_GLES2017_final$sample_no == 1], mc_GLES2017_final$match_vote_outcome[mc_GLES2017_final$sample_no == 1]), 1)

# Sample 2
table_matches_parties_s_2 <- prop.table(table(mc_GLES2017_final$vote[mc_GLES2017_final$sample_no == 2], mc_GLES2017_final$match_vote_outcome[mc_GLES2017_final$sample_no == 2]), 1)

# Sample 3
table_matches_parties_s_3 <- prop.table(table(mc_GLES2017_final$vote[mc_GLES2017_final$sample_no == 3], mc_GLES2017_final$match_vote_outcome[mc_GLES2017_final$sample_no == 3]), 1)

# Sample 4
table_matches_parties_s_4 <- prop.table(table(mc_GLES2017_final$vote[mc_GLES2017_final$sample_no == 4], mc_GLES2017_final$match_vote_outcome[mc_GLES2017_final$sample_no == 4]), 1)

# Sample 5
table_matches_parties_s_5 <- prop.table(table(mc_GLES2017_final$vote[mc_GLES2017_final$sample_no == 5], mc_GLES2017_final$match_vote_outcome[mc_GLES2017_final$sample_no == 5]), 1)

```

### Plot

```{r}
data_matches_parties_s <- as.data.frame(table_matches_parties_s)
data_matches_parties_s <- data_matches_parties_s %>%
                            rename(match = Var2) %>%
                            rename(party = Var1)

data_matches_overall_parties_s <- data_matches_overall_s %>%
                                  rename(party = sample) %>%
                                  mutate(party = factor(party))


data_matches_parties_all <- bind_rows(data_matches_overall_parties_s, data_matches_parties_s) %>%
                            mutate(party = ifelse(party == "Bündnis 90/Die Grünen", "Greens",
                                         ifelse(party == "Die Linke", "Left",
                                         ifelse(party == "Andere Partei", "Small party",
                                         ifelse(party == "Ungültig gewählt", "Invalid vote",
                                         ifelse(party == "Nicht gewählt", "No vote",
                                         ifelse(party == "CDU/CSU", "CDU/CSU",
                                         ifelse(party == "FDP", "FDP",
                                         ifelse(party == "SPD", "SPD",
                                         ifelse(party == "AfD", "AfD", 
                                         ifelse(party == "Overall", "Overall", party)))))))))))

plot_matches_parties <- ggplot(data_matches_parties_all,
                       aes(x = party,
                           y = Freq,
                           fill = match)) +
                      geom_bar(stat = "identity", position = "stack") +
                      geom_text(aes(label = paste0(round(Freq*100,1),"%")),
                                # TO DO: fix colors white/black
                                position = position_fill(0.5), color = "white") +
                      xlab("Vote Choice (GLES)") +
                      ylab("") +
                      scale_x_discrete(limits = c("Overall", "Greens", "CDU/CSU", "Left",
                                                  "SPD", "FDP", "AfD", "Small party", "No vote",
                                                  "Invalid vote")) + # reorder categories
                      scale_y_continuous(labels = scales::percent) +
                      scale_fill_manual(values = c("FALSE" = "#012340", "TRUE" = "#03A63C"), 
                                        labels = c("different", "match"),
                                        name = "GPT Prediction") +
                      ggtitle("") +
                      theme_minimal() +
                      theme(panel.grid.minor = element_blank(),
                            panel.grid.major = element_blank())

ggsave("matches_parties.png", plot_matches_parties, height = 4, width = 8)

```

```{r}
plot_matches_parties
```

- GPT and GLES match less for voters of parties that received fewer votes according to GLES! (Except Left)
--> It's easier for GPT to predict popular / people's parties as it is more clear who will vote for them, historically (training data / evidence)?

## Aggregate: Precision: Share of correct and incorrect matches by GPT party vote

### Tables

```{r}
table_matches_gpt_s <- prop.table(table(mc_GLES2017_final$vote_gpt, mc_GLES2017_final$match_vote_outcome), 1)

# Sample 1
table_matches_gpt_s_1 <- prop.table(table(mc_GLES2017_final$vote_gpt[mc_GLES2017_final$sample_no == 1], mc_GLES2017_final$match_vote_outcome[mc_GLES2017_final$sample_no == 1]), 1)

# Sample 2
table_matches_gpt_s_2 <- prop.table(table(mc_GLES2017_final$vote_gpt[mc_GLES2017_final$sample_no == 2], mc_GLES2017_final$match_vote_outcome[mc_GLES2017_final$sample_no == 2]), 1)

# Sample 3
table_matches_gpt_s_3 <- prop.table(table(mc_GLES2017_final$vote_gpt[mc_GLES2017_final$sample_no == 3], mc_GLES2017_final$match_vote_outcome[mc_GLES2017_final$sample_no == 3]), 1)

# Sample 4
table_matches_gpt_s_4 <- prop.table(table(mc_GLES2017_final$vote_gpt[mc_GLES2017_final$sample_no == 4], mc_GLES2017_final$match_vote_outcome[mc_GLES2017_final$sample_no == 4]), 1)

# Sample 5
table_matches_gpt_s_5 <- prop.table(table(mc_GLES2017_final$vote_gpt[mc_GLES2017_final$sample_no == 5], mc_GLES2017_final$match_vote_outcome[mc_GLES2017_final$sample_no == 5]), 1)
```

### Plot

```{r}
data_matches_gpt_s <- as.data.frame(table_matches_gpt_s)
data_matches_gpt_s <- data_matches_gpt_s %>%
                            rename(match = Var2) %>%
                            rename(party = Var1)

data_matches_gpt_all <- bind_rows(data_matches_overall_parties_s, data_matches_gpt_s) %>%
                            mutate(party = ifelse(party == "Bündnis 90/Die Grünen", "Greens",
                                         ifelse(party == "Die Linke", "Left",
                                         ifelse(party == "Andere Partei", "Small party",
                                         ifelse(party == "Ungültig gewählt", "Invalid vote",
                                         ifelse(party == "Nicht gewählt", "No vote",
                                         ifelse(party == "CDU/CSU", "CDU/CSU",
                                         ifelse(party == "FDP", "FDP",
                                         ifelse(party == "SPD", "SPD",
                                         ifelse(party == "AfD", "AfD", 
                                         ifelse(party == "Overall", "Overall", party)))))))))))

plot_matches_gpt <- ggplot(data_matches_gpt_all,
                       aes(x = party,
                           y = Freq,
                           fill = match)) +
                      geom_bar(stat = "identity", position = "stack") +
                      geom_text(aes(label = paste0(round(Freq*100,1),"%")),
                                # TO DO: fix colors white/black
                                position = position_fill(0.5), color = "white") +
                      xlab("Vote Choice (GPT)") +
                      ylab("") +
                      scale_x_discrete(limits = c("Overall", "CDU/CSU", "Small party", "SPD",
                                                  "Greens", "AfD", "FDP", "Left",
                                                  "No vote", "Invalid vote")) + # reorder categories
                      scale_y_continuous(labels = scales::percent) +
                      scale_fill_manual(values = c("FALSE" = "#012340", "TRUE" = "#03A63C"), 
                                        labels = c("different", "match"),
                                        name = "GLES-Vote") +
                      ggtitle("") +
                      theme_minimal() +
                      theme(panel.grid.minor = element_blank(),
                            panel.grid.major = element_blank())

ggsave("matches_gpt.png", plot_matches_gpt, height = 4, width = 8)
```

```{r}
plot_matches_gpt
```

## F1 Scores per party across samples

Precision refers to the number of correct predictions for a given party (true positives) divided by the number of all predicted votes for that party (positives), measuring the share of predicted vote choices for a given party that were correct. --> matches_gpt

Recall refers to the number of correct predictions for a given party (true positives) divided by the number of actual votes for that party, measuring the share of votes for a party that were correctly identified. --> matches_parties

F1 = 2 * precision * recall / precision + recall

```{r}
data_precision <- data_matches_gpt_all %>%
                  filter(match == TRUE) %>%
                  rename(precision = Freq) %>%
                  select(precision, party)

data_recall <- data_matches_parties_all %>%
               filter(match == TRUE) %>%
               rename(recall = Freq) %>%
               select(recall, party)

data_f1 <- merge(data_precision, data_recall, by = "party")

data_f1 <- data_f1 %>%
           mutate(f1 = (2*precision*recall) / (precision + recall))

```

## Variance Estimation

### Recall

```{r}
# Calculate proportions and its variance for each iteration
sample_proportions_match_party <- mc_GLES2017_final %>%
    group_by(sample_no, match_vote_outcome, vote) %>%
    summarise(n = n(), .groups = "keep") %>%
    ungroup(match_vote_outcome) %>%
    mutate(prop_estimate = n / sum(n)) %>%
    mutate(prop_variance = prop_estimate * (1 - prop_estimate) / sum(n))

# Calculate the between-iteration variance and total variance
mean_proportions_match_party <- sample_proportions_match_party %>%
    group_by(match_vote_outcome, vote) %>%
    summarise(W = mean(prop_variance), # Within variance (mean)
              mean_prop = mean(prop_estimate),
              B = var(prop_estimate)) %>% # Between variance
    mutate(m = 5,
           T = W + (1 + 1/m) * B,
           T_stderr= sqrt(T)) %>% # total variance (Rubin's rules) 
    arrange(desc(mean_prop))

data_recall_varest <- mean_proportions_match_party %>%
                         filter(match_vote_outcome == TRUE) %>%
                         select(vote, W, mean_prop, B, T_stderr) %>%
                         rename(recall = mean_prop,
                                recall_W = W,
                                recall_B = B,
                                recall_totalse = T_stderr,
                                party = vote)
```

### Precision

```{r}
# Calculate proportions and its variance for each iteration
sample_proportions_match_gpt <- mc_GLES2017_final %>%
    group_by(sample_no, match_vote_outcome, vote_gpt) %>%
    summarise(n = n(), .groups = "keep") %>%
    ungroup(match_vote_outcome) %>%
    mutate(prop_estimate = n / sum(n)) %>%
    mutate(prop_variance = prop_estimate * (1 - prop_estimate) / sum(n))

# Calculate the between-iteration variance and total variance
mean_proportions_match_gpt <- sample_proportions_match_gpt %>%
    group_by(match_vote_outcome, vote_gpt) %>%
    summarise(W = mean(prop_variance), # Within variance (mean)
              mean_prop = mean(prop_estimate),
              B = var(prop_estimate)) %>% # Between variance
    mutate(m = 5,
           T = W + (1 + 1/m) * B,
           T_stderr= sqrt(T)) %>% # total variance (Rubin's rules) 
    arrange(desc(mean_prop))

data_precision_varest <- mean_proportions_match_gpt %>%
                         filter(match_vote_outcome == TRUE) %>%
                         select(vote_gpt, W, mean_prop, B, T_stderr) %>%
                         rename(precision = mean_prop,
                                precision_W = W,
                                precision_B = B,
                                precision_totalse = T_stderr,
                                party = vote_gpt)
```

### F1

```{r}
data_f1_varest <- merge(data_precision_varest, data_recall_varest, by = "party")

data_f1_varest <- data_f1_varest %>%
                  mutate(f1 = (2*precision*recall) / (precision + recall)) %>%
                  select(!c(match_vote_outcome.x, match_vote_outcome.y))
```


## OMITTED: Individual level: Shares of correct and incorrect matches by persona (not treating 5 samples as Var.Est.)

```{r}
table_matches_ids_s <- prop.table(table(mc_GLES2017_final$id, mc_GLES2017_final$match_vote_outcome), 1)

data_matches_ids_s <- as.data.frame(table_matches_ids_s)
data_matches_ids_s <- data_matches_ids_s %>%
                            rename(match = Var2) %>%
                            rename(id = Var1) %>%
                            pivot_wider(names_from = match,
                                        values_from = Freq,
                                        names_prefix = "match")

prop.table(table(data_matches_ids_s$matchTRUE))

plot_dist_matches <- hist(data_matches_ids_s$matchTRUE,
                                   breaks = c(0, 0.2, 0.4, 0.6, 0.8, 1),
                                   main = "Distribution of matching predictions per persona",
                                   xlab = "Share of matches in 5 samples",
                                   ylab = "Frequency")

ggsave("dist_matches.png", plot_dist_matches, height = 6, width = 8)

```

```{r}
plot_dist_matches
```

- In 34% of cases, GPT is consistently wrong; in 24% of cases, it's consistently correct
- In the remaining 42% of cases, it gets a majority of votes right 57% of the time (i.e. for over half of the cases/personas, 3 or 4 out of 5 predictions are correct).

## Individual level: Heatmap of % matches per subgroup

### Variance Estimation

Note:
- Aggregated age to 3 groups: 18-34, 35-64, 65+ (range in data: 18-95)
- There are no "Invalid vote" & Match == TRUE groups!

```{r}
# Gender

## Calculate proportions and its variance for each iteration
sample_proportions_match_party_gender <- mc_GLES2017_final %>%
    group_by(sample_no, match_vote_outcome, vote, female) %>%
    summarise(n = n(), .groups = "keep") %>%
    ungroup(match_vote_outcome) %>%
    mutate(prop_estimate = n / sum(n)) %>%
    mutate(prop_variance = prop_estimate * (1 - prop_estimate) / sum(n))

## Calculate the between-iteration variance and total variance
mean_proportions_match_party_gender <- sample_proportions_match_party_gender %>%
    group_by(match_vote_outcome, vote, female) %>%
    summarise(W = mean(prop_variance), # Within variance (mean)
              mean_prop = mean(prop_estimate),
              B = var(prop_estimate)) %>% # Between variance
    mutate(m = 5,
           T = W + (1 + 1/m) * B,
           T_stderr= sqrt(T)) %>% # total variance (Rubin's rules)
    rename(variable = female) %>%
    arrange(desc(mean_prop))

# Education

## Calculate proportions and its variance for each iteration
sample_proportions_match_party_edu <- mc_GLES2017_final %>%
    group_by(sample_no, match_vote_outcome, vote, edu) %>%
    summarise(n = n(), .groups = "keep") %>%
    ungroup(match_vote_outcome) %>%
    mutate(prop_estimate = n / sum(n)) %>%
    mutate(prop_variance = prop_estimate * (1 - prop_estimate) / sum(n))

## Calculate the between-iteration variance and total variance
mean_proportions_match_party_edu <- sample_proportions_match_party_edu %>%
    group_by(match_vote_outcome, vote, edu) %>%
    summarise(W = mean(prop_variance), # Within variance (mean)
              mean_prop = mean(prop_estimate),
              B = var(prop_estimate)) %>% # Between variance
    mutate(m = 5,
           T = W + (1 + 1/m) * B,
           T_stderr= sqrt(T)) %>% # total variance (Rubin's rules)
    rename(variable = edu) %>%
    arrange(desc(mean_prop))

# Employment Status

## Calculate proportions and its variance for each iteration
sample_proportions_match_party_emp <- mc_GLES2017_final %>%
    group_by(sample_no, match_vote_outcome, vote, emp) %>%
    summarise(n = n(), .groups = "keep") %>%
    ungroup(match_vote_outcome) %>%
    mutate(prop_estimate = n / sum(n)) %>%
    mutate(prop_variance = prop_estimate * (1 - prop_estimate) / sum(n))

## Calculate the between-iteration variance and total variance
mean_proportions_match_party_emp <- sample_proportions_match_party_emp %>%
    group_by(match_vote_outcome, vote, emp) %>%
    summarise(W = mean(prop_variance), # Within variance (mean)
              mean_prop = mean(prop_estimate),
              B = var(prop_estimate)) %>% # Between variance
    mutate(m = 5,
           T = W + (1 + 1/m) * B,
           T_stderr= sqrt(T)) %>% # total variance (Rubin's rules) 
    rename(variable = emp) %>%
    arrange(desc(mean_prop))

# Income

## Calculate proportions and its variance for each iteration
sample_proportions_match_party_inc <- mc_GLES2017_final %>%
    group_by(sample_no, match_vote_outcome, vote, hhincome) %>%
    summarise(n = n(), .groups = "keep") %>%
    ungroup(match_vote_outcome) %>%
    mutate(prop_estimate = n / sum(n)) %>%
    mutate(prop_variance = prop_estimate * (1 - prop_estimate) / sum(n))

## Calculate the between-iteration variance and total variance
mean_proportions_match_party_inc <- sample_proportions_match_party_inc %>%
    group_by(match_vote_outcome, vote, hhincome) %>%
    summarise(W = mean(prop_variance), # Within variance (mean)
              mean_prop = mean(prop_estimate),
              B = var(prop_estimate)) %>% # Between variance
    mutate(m = 5,
           T = W + (1 + 1/m) * B,
           T_stderr= sqrt(T)) %>% # total variance (Rubin's rules)
    rename(variable = hhincome) %>%
    arrange(desc(mean_prop))

# East/West

## Calculate proportions and its variance for each iteration
sample_proportions_match_party_east <- mc_GLES2017_final %>%
    group_by(sample_no, match_vote_outcome, vote, east) %>%
    summarise(n = n(), .groups = "keep") %>%
    ungroup(match_vote_outcome) %>%
    mutate(prop_estimate = n / sum(n)) %>%
    mutate(prop_variance = prop_estimate * (1 - prop_estimate) / sum(n))

## Calculate the between-iteration variance and total variance
mean_proportions_match_party_east <- sample_proportions_match_party_east %>%
    group_by(match_vote_outcome, vote, east) %>%
    summarise(W = mean(prop_variance), # Within variance (mean)
              mean_prop = mean(prop_estimate),
              B = var(prop_estimate)) %>% # Between variance
    mutate(m = 5,
           T = W + (1 + 1/m) * B,
           T_stderr= sqrt(T)) %>% # total variance (Rubin's rules)
    rename(variable = east) %>%
    arrange(desc(mean_prop))

# Religiosity

## Calculate proportions and its variance for each iteration
sample_proportions_match_party_relig <- mc_GLES2017_final %>%
    group_by(sample_no, match_vote_outcome, vote, religious) %>%
    summarise(n = n(), .groups = "keep") %>%
    ungroup(match_vote_outcome) %>%
    mutate(prop_estimate = n / sum(n)) %>%
    mutate(prop_variance = prop_estimate * (1 - prop_estimate) / sum(n))

## Calculate the between-iteration variance and total variance
mean_proportions_match_party_relig <- sample_proportions_match_party_relig %>%
    group_by(match_vote_outcome, vote, religious) %>%
    summarise(W = mean(prop_variance), # Within variance (mean)
              mean_prop = mean(prop_estimate),
              B = var(prop_estimate)) %>% # Between variance
    mutate(m = 5,
           T = W + (1 + 1/m) * B,
           T_stderr= sqrt(T)) %>% # total variance (Rubin's rules)
    rename(variable = religious) %>%
    arrange(desc(mean_prop))

# LR-Ideology

## Calculate proportions and its variance for each iteration
sample_proportions_match_party_leftright <- mc_GLES2017_final %>%
    group_by(sample_no, match_vote_outcome, vote, leftright) %>%
    summarise(n = n(), .groups = "keep") %>%
    ungroup(match_vote_outcome) %>%
    mutate(prop_estimate = n / sum(n)) %>%
    mutate(prop_variance = prop_estimate * (1 - prop_estimate) / sum(n))

## Calculate the between-iteration variance and total variance
mean_proportions_match_party_leftright <- sample_proportions_match_party_leftright %>%
    group_by(match_vote_outcome, vote, leftright) %>%
    summarise(W = mean(prop_variance), # Within variance (mean)
              mean_prop = mean(prop_estimate),
              B = var(prop_estimate)) %>% # Between variance
    mutate(m = 5,
           T = W + (1 + 1/m) * B,
           T_stderr= sqrt(T)) %>% # total variance (Rubin's rules)
    rename(variable = leftright) %>%
    arrange(desc(mean_prop))

# Party ID

## Calculate proportions and its variance for each iteration
sample_proportions_match_party_partyid <- mc_GLES2017_final %>%
    group_by(sample_no, match_vote_outcome, vote, partyid) %>%
    summarise(n = n(), .groups = "keep") %>%
    ungroup(match_vote_outcome) %>%
    mutate(prop_estimate = n / sum(n)) %>%
    mutate(prop_variance = prop_estimate * (1 - prop_estimate) / sum(n))

## Calculate the between-iteration variance and total variance
mean_proportions_match_party_partyid <- sample_proportions_match_party_partyid %>%
    group_by(match_vote_outcome, vote, partyid) %>%
    summarise(W = mean(prop_variance), # Within variance (mean)
              mean_prop = mean(prop_estimate),
              B = var(prop_estimate)) %>% # Between variance
    mutate(m = 5,
           T = W + (1 + 1/m) * B,
           T_stderr= sqrt(T)) %>% # total variance (Rubin's rules)
    rename(variable = partyid) %>%
    arrange(desc(mean_prop))

# Strength of Party ID

## Calculate proportions and its variance for each iteration
sample_proportions_match_party_piddegree <- mc_GLES2017_final %>%
    group_by(sample_no, match_vote_outcome, vote, partyid_degree) %>%
    summarise(n = n(), .groups = "keep") %>%
    ungroup(match_vote_outcome) %>%
    mutate(prop_estimate = n / sum(n)) %>%
    mutate(prop_variance = prop_estimate * (1 - prop_estimate) / sum(n))

## Calculate the between-iteration variance and total variance
mean_proportions_match_party_piddegree <- sample_proportions_match_party_piddegree %>%
    group_by(match_vote_outcome, vote, partyid_degree) %>%
    summarise(W = mean(prop_variance), # Within variance (mean)
              mean_prop = mean(prop_estimate),
              B = var(prop_estimate)) %>% # Between variance
    mutate(m = 5,
           T = W + (1 + 1/m) * B,
           T_stderr= sqrt(T)) %>% # total variance (Rubin's rules)
    rename(variable = partyid_degree) %>%
    filter(variable != "") %>%
    arrange(desc(mean_prop))

# Att. Inequality

## Calculate proportions and its variance for each iteration
sample_proportions_match_party_ineq <- mc_GLES2017_final %>%
    group_by(sample_no, match_vote_outcome, vote, inequality) %>%
    summarise(n = n(), .groups = "keep") %>%
    ungroup(match_vote_outcome) %>%
    mutate(prop_estimate = n / sum(n)) %>%
    mutate(prop_variance = prop_estimate * (1 - prop_estimate) / sum(n))

## Calculate the between-iteration variance and total variance
mean_proportions_match_party_ineq <- sample_proportions_match_party_ineq %>%
    group_by(match_vote_outcome, vote, inequality) %>%
    summarise(W = mean(prop_variance), # Within variance (mean)
              mean_prop = mean(prop_estimate),
              B = var(prop_estimate)) %>% # Between variance
    mutate(m = 5,
           T = W + (1 + 1/m) * B,
           T_stderr= sqrt(T)) %>% # total variance (Rubin's rules) 
    rename(variable = inequality) %>%
    arrange(desc(mean_prop))

# Att. Immigration

## Calculate proportions and its variance for each iteration
sample_proportions_match_party_immig <- mc_GLES2017_final %>%
    group_by(sample_no, match_vote_outcome, vote, immigration) %>%
    summarise(n = n(), .groups = "keep") %>%
    ungroup(match_vote_outcome) %>%
    mutate(prop_estimate = n / sum(n)) %>%
    mutate(prop_variance = prop_estimate * (1 - prop_estimate) / sum(n))

## Calculate the between-iteration variance and total variance
mean_proportions_match_party_immig <- sample_proportions_match_party_immig %>%
    group_by(match_vote_outcome, vote, immigration) %>%
    summarise(W = mean(prop_variance), # Within variance (mean)
              mean_prop = mean(prop_estimate),
              B = var(prop_estimate)) %>% # Between variance
    mutate(m = 5,
           T = W + (1 + 1/m) * B,
           T_stderr= sqrt(T)) %>% # total variance (Rubin's rules)
    rename(variable = immigration) %>%
    arrange(desc(mean_prop))

# Age: Too many catgeories --> Aggregate to 3 groups

## Calculate proportions and its variance for each iteration
sample_proportions_match_party_age <- mc_GLES2017_final %>%
    mutate(age_grp = ifelse(age < 35, "18-34",
                            ifelse(age >=35 & age < 65, "35-64",
                                   ifelse(age >= 65, "65+", age)))) %>%
    group_by(sample_no, match_vote_outcome, vote, age_grp) %>%
    summarise(n = n(), .groups = "keep") %>%
    ungroup(match_vote_outcome) %>%
    mutate(prop_estimate = n / sum(n)) %>%
    mutate(prop_variance = prop_estimate * (1 - prop_estimate) / sum(n))

## Calculate the between-iteration variance and total variance
mean_proportions_match_party_age <- sample_proportions_match_party_age %>%
    group_by(match_vote_outcome, vote, age_grp) %>%
    summarise(W = mean(prop_variance), # Within variance (mean)
              mean_prop = mean(prop_estimate),
              B = var(prop_estimate)) %>% # Between variance
    mutate(m = 5,
           T = W + (1 + 1/m) * B,
           T_stderr= sqrt(T)) %>% # total variance (Rubin's rules)
    rename(variable = age_grp) %>%
    arrange(desc(mean_prop))


mean_proportions_match_party_all <- bind_rows(mean_proportions_match_party_gender, mean_proportions_match_party_edu, mean_proportions_match_party_emp, mean_proportions_match_party_inc, mean_proportions_match_party_east, mean_proportions_match_party_relig, mean_proportions_match_party_leftright, mean_proportions_match_party_partyid, mean_proportions_match_party_piddegree, mean_proportions_match_party_ineq, mean_proportions_match_party_immig, mean_proportions_match_party_age)

```

### Plot

```{r}
data_heatmap_match <- mean_proportions_match_party_all %>%
                      select(match_vote_outcome, vote, variable, mean_prop) %>%
                      filter(match_vote_outcome == TRUE) %>%
                      mutate(vote = ifelse(vote == "Bündnis 90/Die Grünen", "Greens",
                                        ifelse(vote == "Die Linke", "Left",
                                        ifelse(vote == "Andere Partei", "Small party",
                                        ifelse(vote == "Ungültig gewählt", "Invalid vote",
                                        ifelse(vote == "Nicht gewählt", "No vote", vote)))))) %>%
                      rename(category = variable) %>%
                      mutate(variable = ifelse(category == "18-34" | category == "35-64"| category == "65+", "Age",
                                        ifelse(category == "weiblich" | category == "männlich", "Gender",
                                        ifelse(category == "keinen Schulabschluss" | category == "einen Hauptschulabschluss" | category == "einen Realschulabschluss"| category == "Abitur" | category == "einen Hochschulabschluss", "Education",
                                        ifelse(category == "nicht berufstätig" | category == "in Ausbildung" | category == "berufstätig", "Employment",
                                        ifelse(category == "niedriges" | category == "mittleres" | category == "hohes", "Income",
                                        ifelse(category == "Ostdeutschland" | category == "Westdeutschland", "Residence",
                                        ifelse(category == "überhaupt nicht religiös" | category == "nicht sehr religiös" | category == "etwas religiös" | category == "sehr religiös", "Religiosity",
                                        ifelse(category == "stark links" | category == "mittig links"| category == "in der Mitte"| category == "mittig rechts" | category == "stark rechts", "Ideology",
                                        ifelse(category == "mit der Partei CDU/CSU" | category == "mit der Partei SPD"| category == "mit der Partei FDP" | category == "mit der Partei Bündnis 90/Die Grünen" | category == "mit der Partei Die Linke" | category == "mit der Partei AfD" | category == "mit einer Kleinpartei"| category == "mit keiner Partei", "Party ID",
                                        ifelse(category == "sehr stark " | category == "ziemlich stark " | category == "mäßig " | category == "ziemlich schwach " | category == "sehr schwach ", "Strength of Party ID",
                                        ifelse(category == "Maßnahmen ergreifen" | category == "habe keine Meinung dazu, ob die Regierung Maßnahmen ergreifen sollte" | category == "keine Maßnahmen ergreifen", "Att. Inequality",
                                               
                                        ifelse(category == "erleichtern" | category == "weder erleichtern noch einschränken" | category == "einschränken", "Att. Immigration", category))))))))))))) %>%
                      mutate(category = ifelse(category == "weiblich", "female",
                                        ifelse(category == "männlich", "male",
                                        ifelse(category == "keinen Schulabschluss", "no degree",
                                        ifelse(category == "einen Hauptschulabschluss", "Hauptschule",
                                        ifelse(category == "einen Realschulabschluss", "Realschule",
                                        ifelse(category == "Abitur", "Abitur",
                                        ifelse(category == "einen Hochschulabschluss", "College",
                                        ifelse(category == "nicht berufstätig", "not working",
                                        ifelse(category == "in Ausbildung", "studying",
                                        ifelse(category == "berufstätig", "working",
                                        ifelse(category == "niedriges", "low",
                                        ifelse(category == "mittleres", "medium",
                                        ifelse(category == "hohes", "high",
                                        ifelse(category == "Ostdeutschland", "East Germany",
                                        ifelse(category == "Westdeutschland", "West Germany",
                                        ifelse(category == "überhaupt nicht religiös", "not at all",
                                        ifelse(category == "nicht sehr religiös", "not very",
                                        ifelse(category == "etwas religiös", "somewhat",
                                        ifelse(category == "sehr religiös", "very",
                                        ifelse(category == "stark links", "left",
                                        ifelse(category == "mittig links", "center-left",
                                        ifelse(category == "in der Mitte", "center",
                                        ifelse(category == "mittig rechts", "center-right",
                                        ifelse(category == "stark rechts", "right",
                                        ifelse(category == "mit der Partei CDU/CSU", "CDU/CSU",
                                        ifelse(category == "mit der Partei SPD", "SPD",
                                        ifelse(category == "mit der Partei FDP", "FDP",
                                        ifelse(category == "mit der Partei Bündnis 90/Die Grünen", "Greens",
                                        ifelse(category == "mit der Partei Die Linke", "Left",
                                        ifelse(category == "mit der Partei AfD", "AfD",
                                        ifelse(category == "mit einer Kleinpartei", "Small party",
                                        ifelse(category == "mit keiner Partei", "none",
                                        ifelse(category == "sehr stark ", "very strong",
                                        ifelse(category == "ziemlich stark ", "rather strong",
                                        ifelse(category == "mäßig ", "medium",
                                        ifelse(category == "ziemlich schwach ", "rather weak",
                                        ifelse(category == "sehr schwach ", "very weak",
                                        ifelse(category == "Maßnahmen ergreifen", "take measures",
                                        ifelse(category == "habe keine Meinung dazu, ob die Regierung Maßnahmen ergreifen sollte", "no opinion",
                                        ifelse(category == "keine Maßnahmen ergreifen", "don't take measures",
                                               
                                        ifelse(category == "erleichtern", "facilitate",
                                        ifelse(category == "weder erleichtern noch einschränken", "neither nor",
                                        ifelse(category == "einschränken", "limit", category))))))))))))))))))))))))))))))))))))))))))))

data_heatmap_match <- data_heatmap_match %>%
  mutate(interaction_cat_var = interaction(category, variable, sep = "&")) %>%
  mutate(interaction_cat_var = factor(interaction_cat_var,
                                      levels = c("facilitate&Att. Immigration", "neither nor&Att. Immigration", "limit&Att. Immigration",
                                                 "take measures&Att. Inequality", "no opinion&Att. Inequality", "don't take measures&Att. Inequality",
                                                 "very strong&Strength of Party ID", "rather strong&Strength of Party ID", "medium&Strength of Party ID", "rather weak&Strength of Party ID", "very weak&Strength of Party ID",
                                                 "none&Party ID", "Small party&Party ID", "AfD&Party ID", "Left&Party ID", "FDP&Party ID", "Greens&Party ID", "SPD&Party ID", "CDU/CSU&Party ID",
                                                 "right&Ideology", "center-right&Ideology", "center&Ideology", "center-left&Ideology", "left&Ideology",
                                                 "very&Religiosity", "somewhat&Religiosity", "not very&Religiosity", "not at all&Religiosity",
                                                 "West Germany&Residence", "East Germany&Residence",
                                                 "high&Income", "medium&Income", "low&Income",
                                                 "working&Employment", "studying&Employment", "not working&Employment",
                                                 "College&Education", "Abitur&Education", "Realschule&Education", "Hauptschule&Education", "no degree&Education",
                                                 "male&Gender", "female&Gender",
                                                 "65+&Age", "35-64&Age", "18-34&Age")
  ))

plot_matches_subgroups <- ggplot(data_heatmap_match,
                          aes(x = vote,
                          y = interaction_cat_var,
                          fill = mean_prop)) +
  geom_tile() +
  xlab("Vote Choice (GLES)") +
  ylab("") +
  guides(y = guide_axis_nested(delim = "&")) + 
  scale_x_discrete(limits = c("CDU/CSU", "SPD", "Greens", "FDP", "Left","AfD", "Small party", "No vote")) +
  scale_fill_gradient(low="white", high="#03A63C",
                      limits = c(0, 1),
                      name = "% Match Vote Choice GPT - GLES",
                      labels = scales::label_percent()) +
  theme_minimal() +
  theme(legend.position = "top",
        panel.grid.minor = element_blank(),
        panel.grid.major = element_blank(),
        panel.background = element_rect(fill = "grey", color = NA)
        )

ggsave("heatmap_matches_subgroups.png", plot_matches_subgroups, height = 9, width = 8)

```

```{r}
plot_matches_subgroups
```

- Some combinations of subgroup/vote don't exist (white in plot)
- Subgroups are singular per variable, i.e. not cross-cutting!
- Across subgroups, higher share of matches for voters of CDU/CSU, Greens, and Left (mirrors previous plot) --> generally fewer matches for FDP & AfD voters
- Within subgroups:
-- Higher share of matches for older CDU/CSU and SPD (maybe even Left) voters
-- Higher share of matches for female Left voters
-- Higher share of matches for higher-educated Green voters, and for lower-educated CDU/CSU, SPD, and non-voters; as well as for medium-educated left voters
-- Higher share of matches for non-working CDU/CSU voters
-- Higher share of matches for high-income Green, FDP, and Left voters, but also for low-income left voters
-- Higher share of matches for East German Left voters
-- Higher share of matches for religious CDU/CSU voters, non-religious Green and Left voters
-- Higher share of matches for ideologically left Left-voters (not so much Greens, those more for center-left), ideologically right FDP, SPD (!, weaker for CDU/CSU), and AfD voters
-- Higher share of matches for those who voted according to their party ID
-- Higher share of matches the stronger the party ID is - for AfD, higher share of matches for those with very weak party IDs!
-- Higher share of matches for inequality-concerned Green and Left voters, inequality unconcerned CDU/CSU voters
-- Higher share of matches for immigration-supporting Green voters (not Left!), immigration-limiting CDU/CSU voters


## Individual level: Regression assessing determinants of match, by sample

```{r}
# Sample 1
model_match_1 <- glm(match_vote_outcome ~ vote + age + female + edu + emp + hhincome + east + religious + leftright + partyid_degree*partyid + inequality + immigration,
                   data=data_final_numeric_noNA[data_final_numeric_noNA$sample_no == 1, ],
                   family=binomial(link=logit))

## Get coeffs & stderrs
#summary(model_match_1)
#coef(model_match_1)

## Get n: 1827
#length(model_match_1$residuals)


# Sample 2
model_match_2 <- glm(match_vote_outcome ~ vote + age + female + edu + emp + hhincome + east + religious + leftright + partyid_degree*partyid + inequality + immigration,
                   data=data_final_numeric_noNA[data_final_numeric_noNA$sample_no == 2, ],
                   family=binomial(link=logit))

## Get coeffs & stderrs
#summary(model_match_2)
#coef(model_match_2)

## Get n: 1827
#length(model_match_2$residuals)


# Sample 3
model_match_3 <- glm(match_vote_outcome ~ vote+ age + female + edu + emp + hhincome + east + religious + leftright + partyid_degree*partyid + inequality + immigration,
                   data=data_final_numeric_noNA[data_final_numeric_noNA$sample_no == 3, ],
                   family=binomial(link=logit))

## Get coeffs & stderrs
#summary(model_match_3)
#coef(model_match_3)

## Get n: 1827
#length(model_match_3$residuals)


# Sample 4
model_match_4 <- glm(match_vote_outcome ~ vote + age + female + edu + emp + hhincome + east + religious + leftright + partyid_degree*partyid + inequality + immigration,
                   data=data_final_numeric_noNA[data_final_numeric_noNA$sample_no == 4, ],
                   family=binomial(link=logit))

## Get coeffs & stderrs
#summary(model_match_4)
#coef(model_match_4)

## Get n: 1827
#length(model_match_4$residuals)


# Sample 5
model_match_5 <- glm(match_vote_outcome ~ vote + age + female + edu + emp + hhincome + east + religious + leftright + partyid_degree*partyid + inequality + immigration,
                   data=data_final_numeric_noNA[data_final_numeric_noNA$sample_no == 5, ],
                   family=binomial(link=logit))

## Get coeffs & stderrs
#summary(model_match_5)
#coef(model_match_5)

## Get n: 1827
#length(model_match_5$residuals)
```

### Data transformation

```{r}
# Store as 1 df per sample

## Sample 1
data_model_match_1 <- summary(model_match_1)$coefficients %>%
                           as.data.frame() %>%
                           rownames_to_column("variable") %>%
                           mutate(variable = (ifelse(variable == "(Intercept)",
                                                     "intercept",
                                                     variable))) %>%
                           rename(coeff = Estimate) %>%
                           rename(stderr = "Std. Error") %>%
                           rename(z_value = "z value") %>%
                           rename(p_value = "Pr(>|z|)") %>%
                           mutate(sample = 1)

data_model_match_2 <- summary(model_match_2)$coefficients %>%
                           as.data.frame() %>%
                           rownames_to_column("variable") %>%
                           mutate(variable = (ifelse(variable == "(Intercept)",
                                                     "intercept",
                                                     variable))) %>%
                           rename(coeff = Estimate) %>%
                           rename(stderr = "Std. Error") %>%
                           rename(z_value = "z value") %>%
                           rename(p_value = "Pr(>|z|)") %>%
                           mutate(sample = 2)


data_model_match_3 <- summary(model_match_3)$coefficients %>%
                           as.data.frame() %>%
                           rownames_to_column("variable") %>%
                           mutate(variable = (ifelse(variable == "(Intercept)",
                                                     "intercept",
                                                     variable))) %>%
                           rename(coeff = Estimate) %>%
                           rename(stderr = "Std. Error") %>%
                           rename(z_value = "z value") %>%
                           rename(p_value = "Pr(>|z|)") %>%
                           mutate(sample = 3)

data_model_match_4 <- summary(model_match_4)$coefficients %>%
                           as.data.frame() %>%
                           rownames_to_column("variable") %>%
                           mutate(variable = (ifelse(variable == "(Intercept)",
                                                     "intercept",
                                                     variable))) %>%
                           rename(coeff = Estimate) %>%
                           rename(stderr = "Std. Error") %>%
                           rename(z_value = "z value") %>%
                           rename(p_value = "Pr(>|z|)") %>%
                           mutate(sample = 4)

data_model_match_5 <- summary(model_match_5)$coefficients %>%
                           as.data.frame() %>%
                           rownames_to_column("variable") %>%
                           mutate(variable = (ifelse(variable == "(Intercept)",
                                                     "intercept",
                                                     variable))) %>%
                           rename(coeff = Estimate) %>%
                           rename(stderr = "Std. Error") %>%
                           rename(z_value = "z value") %>%
                           rename(p_value = "Pr(>|z|)") %>%
                           mutate(sample = 5)

# Merge in one df across samples
data_model_match_all <- bind_rows(data_model_match_1, data_model_match_2, data_model_match_3, data_model_match_4, data_model_match_5)
data_model_match_all <- data_model_match_all %>% rename(sample_no = sample) # for consistency

```

### Aggregation

```{r}
data_model_match_mean <- data_model_match_all %>%
    group_by(variable) %>%
    summarise(W_coeff = mean(stderr^2), # Within variance OF COEFFICIENT (mean)
              mean_coeff = mean(coeff), # Mean estimate (coefficient)
              B_coeff = var(coeff), # Between variance (coefficient)
              mean_stderr = mean(stderr), # Mean estimate (stderr)
              B_stderr = var(stderr), # Between variance (stderr)
              mean_p = mean(p_value), # Mean estimate (p-value)
              B_p = var(p_value)) %>% # Between variance (p-value)
    mutate(m = 5,
           T = W_coeff + (1 + 1/m) * B_coeff, # total variance (Rubin's rules) OF COEFFICIENT
           T_stderr= sqrt(T)) # standard error OF COEFFICIENT --> to be used for CIs



# Export
export_match <- data_model_match_mean %>%
                   select(variable, mean_coeff, mean_p, T_stderr) %>%
                   mutate(mean_coeff = round(mean_coeff, digits = 3)) %>%
                   mutate(mean_p = round(mean_p, digits = 3)) %>%
                   mutate(T_stderr = round(T_stderr, digits = 3))

write.csv(export_match, "model_match.csv", row.names = F)
```

### Plot

```{r}
data_plot_match <- export_match %>%
                          filter(!(is.na(T_stderr))) %>%
                          mutate(lower = mean_coeff - 1.96*T_stderr,
                                 upper = mean_coeff + 1.96*T_stderr,
                                 oddsratio = exp(mean_coeff)) %>%
                          mutate(lower_or = exp(lower),
                                 upper_or = exp(upper)) %>%
                          mutate(sig = ifelse(lower_or > 1 | upper_or < 1, "Significant",
                                              "Not significant")) %>%
                          rename(category = variable) %>%
                          mutate(variable = ifelse(category == "intercept", "Intercept",
                                            ifelse(category == "voteAfD" | category == "voteAndere Partei" | category == "voteBündnis 90/Die Grünen" | category == "voteDie Linke" | category == "voteFDP" | category == "voteNicht gewählt" | category == "voteSPD" | category == "voteUngültig gewählt", "GLES-Vote (Ref.: CDU/CSU)",
                                            ifelse(category == "age", "Age",
                                            ifelse(category == "femaleweiblich", "Gender (Ref.: male)",
                                            ifelse(category == "edu", "Education",
                                            ifelse(category == "empnicht berufstätig" | category == "empin Ausbildung", "Employment (Ref.: working)",
                                            ifelse(category == "hhincomemittleres" | category == "hhincomehohes", "Income (Ref.: low)",
                                            ifelse(category == "eastOstdeutschland", "Residence (Ref.: West Germany)",
                                            ifelse(category == "religiousnicht sehr religiös" | category == "religiousetwas religiös" | category == "religioussehr religiös", "Religiosity (Ref.: not at all)",
                                            ifelse(category == "leftright", "Ideology",
                                            ifelse(category == "partyidSPD"| category == "partyidFDP" | category == "partyidDie Grünen" | category == "partyidDie Linke" | category == "partyidAfD" | category == "partyidKleinpartei"| category == "partyidkeine Partei", "Party ID (Ref.: CDU/CSU)",
                                            ifelse(category == "partyid_degree", "Strength of Party ID",
                                            ifelse(category == "partyid_degree:partyidAfD" | category == "partyid_degree:partyidDie Grünen" | category == "partyid_degree:partyidDie Linke" | category == "partyid_degree:partyidFDP" | category == "partyid_degree:partyidKleinpartei" | category == "partyid_degree:partyidSPD", "Party ID x Strength (Ref.: CDU/CSU)",        
                                            ifelse(category == "inequalityhabe keine Meinung dazu" | category == "inequalitykeine Maßnahmen ergreifen", "Att. Inequality (Ref.: take measures)",         
                                            ifelse(category == "immigrationweder erleichtern noch einschränken" | category == "immigrationeinschränken", "Att. Immigration (Ref.: facilitate)",
                                            category)))))))))))))))) %>%
                          mutate(category = ifelse(category == "femaleweiblich", "female",
                                        ifelse(category == "edu", " ",
                                        ifelse(category == "age", " ",
                                        ifelse(category == "empnicht berufstätig", "not working",
                                        ifelse(category == "empin Ausbildung", "studying",
                                        ifelse(category == "hhincomemittleres", "medium",
                                        ifelse(category == "hhincomehohes", "high",
                                        ifelse(category == "eastOstdeutschland", "East Germany",
                                        ifelse(category == "religiousnicht sehr religiös", "not very",
                                        ifelse(category == "religiousetwas religiös", "somewhat",
                                        ifelse(category == "religioussehr religiös", "very",
                                        ifelse(category == "leftright", " ",
                                        ifelse(category == "partyidSPD", "SPD",
                                        ifelse(category == "partyidFDP", "FDP",
                                        ifelse(category == "partyidDie Grünen", "Greens",
                                        ifelse(category == "partyidDie Linke", "Left",
                                        ifelse(category == "partyidAfD", "AfD",
                                        ifelse(category == "partyidKleinpartei", "Small party",
                                        ifelse(category == "partyidkeine Partei", "none",
                                        ifelse(category == "partyid_degree", " ",
                                        ifelse(category == "inequalityhabe keine Meinung dazu", "no opinion",
                                        ifelse(category == "inequalitykeine Maßnahmen ergreifen", "don't take measures",
                                        ifelse(category == "immigrationweder erleichtern noch einschränken", "neither nor",
                                        ifelse(category == "immigrationeinschränken", "limit",
                                        ifelse(category == "intercept", " ",
                                        ifelse(category == "partyid_degree:partyidAfD", "AfD",
                                        ifelse(category == "partyid_degree:partyidDie Grünen", "Greens",
                                        ifelse(category == "partyid_degree:partyidDie Linke", "Left",
                                        ifelse(category == "partyid_degree:partyidFDP", "FDP",
                                        ifelse(category == "partyid_degree:partyidKleinpartei", "Small party",
                                        ifelse(category == "partyid_degree:partyidSPD", "SPD",
                                        ifelse(category == "voteAfD", "AfD",
                                        ifelse(category == "voteAndere Partei","Small party",
                                        ifelse(category == "voteBündnis 90/Die Grünen", "Greens",
                                        ifelse(category == "voteDie Linke", "Left",
                                        ifelse(category == "voteFDP", "FDP",
                                        ifelse(category == "voteNicht gewählt", "No vote",
                                        ifelse(category == "voteSPD", "SPD",
                                        ifelse(category == "voteUngültig gewählt", "Invalid vote",
                                        category)))))))))))))))))))))))))))))))))))))))) %>%
  mutate(interaction_cat_var = interaction(category, variable, sep = "&")) %>%
  mutate(interaction_cat_var = factor(interaction_cat_var,
                                      levels = c(" &Intercept",
                                                 "No vote&GLES-Vote (Ref.: CDU/CSU)", "Small party&GLES-Vote (Ref.: CDU/CSU)", "AfD&GLES-Vote (Ref.: CDU/CSU)", "Left&GLES-Vote (Ref.: CDU/CSU)", "FDP&GLES-Vote (Ref.: CDU/CSU)", "Greens&GLES-Vote (Ref.: CDU/CSU)", "SPD&GLES-Vote (Ref.: CDU/CSU)",
                                                 "limit&Att. Immigration (Ref.: facilitate)", "neither nor&Att. Immigration (Ref.: facilitate)",
                                                "don't take measures&Att. Inequality (Ref.: take measures)", "no opinion&Att. Inequality (Ref.: take measures)",
                                                "Small party&Party ID x Strength (Ref.: CDU/CSU)", "AfD&Party ID x Strength (Ref.: CDU/CSU)", "Left&Party ID x Strength (Ref.: CDU/CSU)", "FDP&Party ID x Strength (Ref.: CDU/CSU)", "Greens&Party ID x Strength (Ref.: CDU/CSU)", "SPD&Party ID x Strength (Ref.: CDU/CSU)",
                                                 " &Strength of Party ID",
                                                 "none&Party ID (Ref.: CDU/CSU)", "Small party&Party ID (Ref.: CDU/CSU)", "AfD&Party ID (Ref.: CDU/CSU)", "Left&Party ID (Ref.: CDU/CSU)", "FDP&Party ID (Ref.: CDU/CSU)", "Greens&Party ID (Ref.: CDU/CSU)", "SPD&Party ID (Ref.: CDU/CSU)",
                                                 " &Ideology",
                                                 "very&Religiosity (Ref.: not at all)", "somewhat&Religiosity (Ref.: not at all)", "not very&Religiosity (Ref.: not at all)",
                                                 "East Germany&Residence (Ref.: West Germany)",
                                                 "high&Income (Ref.: low)", "medium&Income (Ref.: low)",
                                                "not working&Employment (Ref.: working)", "studying&Employment (Ref.: working)",
                                                 " &Education",
                                                 "female&Gender (Ref.: male)",
                                                 " &Age")
  ))

plot_model_match <- ggplot(drop_na(data_plot_match), 
       aes(y= interaction_cat_var,
           x = mean_coeff,
           xmin = lower,
           xmax = upper,
           color = sig)) + # legend colored by significance
  geom_vline(xintercept = 0,
             linetype = "solid",
             linewidth = 0.2) +
  geom_point(aes(color = sig), # point estimate
             size = 2) +
  geom_pointrange(linewidth = 0.5) + # error bars
  xlim(-7.5, 10) + # When using pure betas and removing Vote (GLES): Invalid
  guides(y = guide_axis_nested(delim = "&")) + 
  scale_color_manual(limits = c("Significant", "Not significant"),
                     values = c("Significant" = "#03A63C",
                                 "Not significant" = "#012340"),
                     labels = c("p < 0.05", "p > 0.05")) +
  theme_minimal() +
  labs(
    x = "ß (additive effect on log-odds)",
    y = "",
    title = "Determinants of Matching Vote Choice Between GLES and GPT") +
  theme(
        legend.position = "top",
        legend.title = element_blank(),
        plot.title.position = "plot"
        )

ggsave("model_match.png", plot_model_match, height = 6, width = 8)

```

```{r}
plot_model_match
```

Significant according to plot:
- vote: FDP (negative)
- vote: AfD (negative)
- vote: small party (negative)
- vote: no vote (negative)
- party ID: FDP (positive)
- party ID: none (positive)
- strength of party ID (positive)
(-Intercept)

### Partisan Voting Analysis

#### OMITTED: VarEst for comparing to GPT

```{r}
# Partisan voting
round(prop.table(table(data_final_numeric_noNA$vote, data_final_numeric_noNA$partyid), margin = 2), 3)

# Distribution of partisanship
round(prop.table(table(data_final_numeric_noNA$partyid)), 3)

# Distribution of vote
round(prop.table(table(data_final_numeric_noNA$vote)), 3)

# Compare to GPT: need VarEst!

```

# Aggregate: Distribution of vote shares GLES vs. GPT

## Tables

```{r}
# GLES
table_vote_overall_s <- prop.table(table(mc_GLES2017_final$vote, useNA = "always"))

# GPT Overall
table_votegpt_overall_s <- prop.table(table(mc_GLES2017_final$vote_gpt, useNA = "always"))

# GPT Sample 1
table_votegpt_s1 <- prop.table(table(mc_GLES2017_final$vote_gpt[mc_GLES2017_final$sample_no == 1], useNA = "always"))

# GPT Sample 2
table_votegpt_s2 <- prop.table(table(mc_GLES2017_final$vote_gpt[mc_GLES2017_final$sample_no == 2], useNA = "always"))

# GPT Sample 3
table_votegpt_s3 <- prop.table(table(mc_GLES2017_final$vote_gpt[mc_GLES2017_final$sample_no == 3], useNA = "always"))

# GPT Sample 4
table_votegpt_s4 <- prop.table(table(mc_GLES2017_final$vote_gpt[mc_GLES2017_final$sample_no == 4], useNA = "always"))

# GPT Sample 5
table_votegpt_s5 <- prop.table(table(mc_GLES2017_final$vote_gpt[mc_GLES2017_final$sample_no == 5], useNA = "always"))
```

## Variance Estimation

```{r}
# Calculate proportions and its variance for each iteration
sample_proportions <- mc_GLES2017_final %>%
    group_by(sample_no, vote_gpt) %>%
    summarise(n = n(), .groups = "keep") %>%
    ungroup(vote_gpt) %>%
    mutate(prop_estimate = n / sum(n)) %>%
    mutate(prop_variance = prop_estimate * (1 - prop_estimate) / sum(n))

# Calculate the between-iteration variance and total variance
mean_proportions <- sample_proportions %>%
    group_by(vote_gpt) %>%
    summarise(W = mean(prop_variance), # Within variance (mean)
              mean_prop = mean(prop_estimate),
              B = var(prop_estimate)) %>% # Between variance
    mutate(m = 5,
           T = W + (1 + 1/m) * B,
           T_stderr= sqrt(T)) %>% # total variance (Rubin's rules) 
    arrange(desc(mean_prop))

mean_proportions 
```

## Plot

```{r}
#GLES

## Filter the dataset for a specific sample_no
data_vote_1 <- subset(mc_GLES2017_final, sample_no == 1)

## Calculate the relative frequencies of each category
table_vote_freq_1 <- prop.table(table(data_vote_1$vote))

## Sort the categories based on their frequencies
data_vote_freq_1_sorted <- as.data.frame(table_vote_freq_1[order(table_vote_freq_1, decreasing = TRUE)])

data_vote_freq_1_sorted <- data_vote_freq_1_sorted %>%
                           rename(party = Var1) %>%
                           mutate(source = "GLES") %>%
                           mutate(source = as.factor(source)) %>%
                           mutate(T_stderr = NA) %>%
                           rename(freq = Freq)

# Adjust GPT
mean_proportions_df <- mean_proportions %>%
                       select(vote_gpt, mean_prop, T_stderr) %>%
                       rename(party = vote_gpt) %>%
                       rename(freq = mean_prop) %>%
                       replace_na(list(party = "no prediction")) %>%
                       mutate(source = "GPT") %>%
                       #mutate(party = as.factor(party)) %>%
                       mutate(source = factor(source, levels = c("GLES", "GPT")))

# Adjust GLES
data_vote_freq <- data_vote_freq_1_sorted %>%
                  mutate(T_stderr = sqrt(freq * (1-freq)/1905)) %>% # SE if GLES eligible voters could be treated unweighted
                  add_row(party = "no prediction", freq = 0, source = "GLES",
                          T_stderr = NA
                          ) %>%
                  mutate(source = factor(source, levels = c("GLES", "GPT")))

# Merge GLES & GPT, remove small percentage of "no prediction"
data_vote_parties <- bind_rows(mean_proportions_df, data_vote_freq)
data_vote_parties <- data_vote_parties %>%
                      mutate(party = ifelse(party == "Bündnis 90/Die Grünen", "Greens",
                                        ifelse(party == "Die Linke", "Left",
                                        ifelse(party== "Andere Partei", "Small party",
                                        ifelse(party == "Ungültig gewählt", "Invalid vote",
                                        ifelse(party == "Nicht gewählt", "No vote", party))))))  %>%
                      mutate(party = as.factor(party))
data_vote_parties <- data_vote_parties[data_vote_parties$party!="no prediction" , ]

plot_shares_aggregate <- ggplot(data_vote_parties, aes(x = party,
                                                           y = freq,
                                                           fill = source)) +
                      geom_bar(stat = "identity", position = "dodge") +
                      geom_text(aes(label = round(freq*100,1),
                                    y = freq + (1.96*T_stderr) + 0.005), 
                                position = position_dodge(0.9),
                                vjust = 0,
                                color = "#012340") +
                      xlab("") +
                      ylab("") +
                      scale_x_discrete(limits = c("CDU/CSU", "SPD", "Greens", "FDP", "Left",
                                                  "AfD", "Small party", "Invalid vote",
                                                  "No vote")) + # reorder categories
                      scale_y_continuous(labels = scales::percent) +
                      scale_fill_manual(limits = c("GLES", "GPT"),
                                        values = c("GLES" = "#027333", "GPT" = "#FAA32B"),
                                        labels = c("GLES",
                                                   "GPT-3"),
                                        name = "Reported vote choice \naccording to") +
                      geom_errorbar(aes(x=party,
                                        ymin=freq-(1.96*T_stderr),
                                        ymax=freq+(1.96*T_stderr)),
                                    #data = subset(data_vote_parties, source == "GPT"), # toggle on / off for GLES CIs; Problem: then CIs centered across sources!
                                    width=0.4,
                                    colour = "#012340",
                                    position = position_dodge(width = 0.9)) +
                      ggtitle("") +
                      theme_minimal() +
                      theme(legend.position = "top",
                            legend.title.align = 1,
                            axis.text.x = element_text(colour = "black"),
                            axis.text.y = element_text(colour = "black"),
                            panel.grid.minor = element_blank(),
                            panel.grid.major = element_blank())


ggsave("shares_aggregate.png", plot_shares_aggregate, height = 4, width = 8)
```

```{r}
plot_shares_aggregate
```

- GPT overestimates the share of Green, Left, and non-voters
- GPT underestimates the share of FDP and AfD voters and voters of other/small parties

## OMITTED: Comparison with actual election result - UNWEIGHTED

### QUESTION: How to add labels for real result without CIs, but still dodged to the top?

Source: https://www.bundeswahlleiterin.de/dam/jcr/56147bb4-c149-4faa-a9b0-9a3d98e8bf7b/btw17_heft5-1.pdf Chart page 30

```{r}
data_vote_real <- data_vote_parties %>%
                  add_row(party = "CDU/CSU", freq = 0.249, T_stderr = NA, source = "Election") %>%
                  add_row(party = "SPD", freq = 0.155, T_stderr = NA, source = "Election") %>%
                  add_row(party = "Greens", freq = 0.067, T_stderr = NA, source = "Election") %>%
                  add_row(party = "FDP", freq = 0.081, T_stderr = NA, source = "Election") %>%
                  add_row(party = "AfD", freq = 0.095, T_stderr = NA, source = "Election") %>%
                  add_row(party = "Left", freq = 0.07, T_stderr = NA, source = "Election") %>%
                  add_row(party = "Small party", freq = 0.038, T_stderr = NA, source = "Election") %>%
                  add_row(party = "Invalid vote", freq = 0.007, T_stderr = NA, source = "Election") %>%
                  add_row(party = "No vote", freq = 0.238, T_stderr = NA, source = "Election")

plot_shares_real <- ggplot(data_vote_real, aes(x = party,
                                                    y = freq,
                                                    fill = source)) +
                      geom_bar(stat = "identity", position = "dodge") +
                      geom_text(aes(label = round(freq*100,1),
                                    #y = freq + (1.96*T_stderr) + 0.005
                                    ), 
                                position = position_dodge(0.9),
                                vjust = 0,
                                color = "#012340") +
                      xlab("") +
                      ylab("") +
                      scale_x_discrete(limits = c("CDU/CSU", "SPD", "Greens", "FDP", "Left",
                                                  "AfD", "Small party", "Invalid vote",
                                                  "No vote")) + # reorder categories
                      scale_y_continuous(labels = scales::percent) +
                      scale_fill_manual(limits = c("Election", "GLES", "GPT"),
                                        values = c("Election" = "grey",
                                                   "GLES" = "#027333",
                                                   "GPT" = "#FAA32B"),
                                        labels = c("Official Result", 
                                                   "GLES (German Longitudinal Election Study)",
                                                   "GPT-3"
                                                   ),
                                        name = "Vote choice \naccording to") +
                      geom_errorbar(aes(x=party,
                                        ymin=freq-(1.96*T_stderr),
                                        ymax=freq+(1.96*T_stderr)),
                                    width=0.4,
                                    colour = "#012340",
                                    position = position_dodge(width = 0.9)) +
                      ggtitle("") +
                      theme_minimal() +
                      theme(legend.position = "top",
                            legend.title.align = 1,
                            axis.text.x = element_text(colour = "black"),
                            axis.text.y = element_text(colour = "black"),
                            panel.grid.minor = element_blank(),
                            panel.grid.major = element_blank())

ggsave("shares_real.png", plot_shares_real, height = 4, width = 8)
```

```{r}
plot_shares_real
```

- Two truths:
- For parties that GPT underestimates compared to GLES (FDP, AfD, small parties), GLES is closer to the real result / real result is in GLES, but not GPT CI - BUT except FDP! Re-evaluate variables for FDP in GPT regression models?
- For parties that GPT overestimates compared to GLES (Green, Left, non-voters), GLES is closer to the real result - BUT except non-voters! Confirms issue with GLES in getting non-voters

--> New paper: using GPT to forecast abstention / Wahlbeteiligung? --> What factors influence likely voting?

# VOTE: Comparing determinants of vote choice

Notes from https://stackoverflow.com/questions/43623076/multinomial-logit-in-r-mlogit-versus-nnet
In nnet::multinom the model is a neural network with no hidden layers, no bias nodes and a softmax output layer.
Maximum conditional likelihood is the method used in multinom for model fitting.

For models estimated by multinom the McFadden's pseudo R-squared can be easily calculated as follows:
nnet.mod.loglik <- nnet:::logLik.multinom(nnet.mod)
nnet.mod0 <- multinom(y ~ 1, df1)
nnet.mod0.loglik <- nnet:::logLik.multinom(nnet.mod0)
nnet.mod.mfr2 <- as.numeric(1 - nnet.mod.loglik/nnet.mod0.loglik)

## GPT: Regressions by sample

Note: Ungültig gewählt from sample 2 not in dataset, i.e. not part of n for means!

```{r}
# Sample 1
model_vote_gpt_1 <- multinom(vote_gpt ~ age + female + edu + emp + hhincome + east + religious + leftright + partyid*partyid_degree + inequality + immigration, data = data_final_numeric_noNA, subset = data_final_numeric_noNA$sample_no == 1, Hess = TRUE)

## Get coeffs & stderrs
#summary(model_vote_gpt_1)
#coef(model_vote_gpt_1)

## Get n: 1827
#nrow(residuals(model_vote_gpt_1))


# Sample 2
model_vote_gpt_2 <- multinom(vote_gpt ~ age + female + edu + emp + hhincome + east + religious + leftright + partyid*partyid_degree + inequality + immigration, data = data_final_numeric_noNA, subset = data_final_numeric_noNA$sample_no == 2, Hess = TRUE)

## Get coeffs & stderrs
#summary(model_vote_gpt_2)
#coef(model_vote_gpt_2)

## Get n: 1827
#nrow(residuals(model_vote_gpt_2))


# Sample 3
model_vote_gpt_3 <- multinom(vote_gpt ~ age + female + edu + emp + hhincome + east + religious + leftright + partyid*partyid_degree + inequality + immigration, data = data_final_numeric_noNA, subset = data_final_numeric_noNA$sample_no == 3, Hess = TRUE)

## Get coeffs & stderrs
#summary(model_vote_gpt_3)
#coef(model_vote_gpt_3)

## Get n: 1827
#nrow(residuals(model_vote_gpt_3))


# Sample 4
model_vote_gpt_4 <- multinom(vote_gpt ~ age + female + edu + emp + hhincome + east + religious + leftright + partyid*partyid_degree + inequality + immigration, data = data_final_numeric_noNA, subset = data_final_numeric_noNA$sample_no == 4, Hess = TRUE)

## Get coeffs & stderrs
#summary(model_vote_gpt_4)
#coef(model_vote_gpt_4)

## Get n: 1827
#nrow(residuals(model_vote_gpt_4))


# Sample 5
model_vote_gpt_5 <- multinom(vote_gpt ~ age + female + edu + emp + hhincome + east + religious + leftright + partyid*partyid_degree + inequality + immigration, data = data_final_numeric_noNA, subset = data_final_numeric_noNA$sample_no == 5, Hess = TRUE)

## Get coeffs & stderrs
#summary(model_vote_gpt_5)
#coef(model_vote_gpt_5)

## Get n: 1827
#nrow(residuals(model_vote_gpt_5))
```

### Data transformation

```{r}
# Get coeffs, std.errors & test statistics, transform into long format & store as 1 df per sample

## Sample 1
coeff_model_vote_gpt_1 <- summary(model_vote_gpt_1)$coefficients %>%
                           as.data.frame() %>%
                           rownames_to_column("party") %>%
                           rename(intercept = "(Intercept)") %>%
                           pivot_longer(cols = !party, names_to = "variable", values_to = "coeff")

stderr_model_vote_gpt_1 <- summary(model_vote_gpt_1)$standard.errors %>%
                           as.data.frame() %>%
                           rownames_to_column("party") %>%
                           rename(intercept = "(Intercept)") %>%
                           pivot_longer(cols = !party, names_to = "variable", values_to = "stderr")

z_model_vote_gpt_1 <- summary(model_vote_gpt_1)$coefficients/summary(model_vote_gpt_1)$standard.errors
# cannot transform before calculating p-values

# have to do separately because %>% doesn't work with calculation
p_model_vote_gpt_1 <- (1 - pnorm(abs(z_model_vote_gpt_1), 0, 1)) * 2 # 2-tailed z-test 
p_model_vote_gpt_1 <- p_model_vote_gpt_1 %>%
                      as.data.frame() %>%
                      rownames_to_column("party") %>%
                      rename(intercept = "(Intercept)") %>%
                      pivot_longer(cols = !party, names_to = "variable", values_to = "p_value")


z_model_vote_gpt_1 <- z_model_vote_gpt_1 %>%
                      as.data.frame() %>%
                      rownames_to_column("party") %>%
                      rename(intercept = "(Intercept)") %>%
                      pivot_longer(cols = !party, names_to = "variable", values_to = "z_value")

data_model_vote_gpt_1 <- coeff_model_vote_gpt_1 %>%
                         left_join(stderr_model_vote_gpt_1, by = c("party", "variable")) %>%
                         left_join(p_model_vote_gpt_1, by = c("party", "variable")) %>%
                         left_join(z_model_vote_gpt_1, by = c("party", "variable")) %>%
                         mutate(sample = 1)


## Sample 2

coeff_model_vote_gpt_2 <- summary(model_vote_gpt_2)$coefficients %>%
                           as.data.frame() %>%
                           rownames_to_column("party") %>%
                           rename(intercept = "(Intercept)") %>%
                           pivot_longer(cols = !party, names_to = "variable", values_to = "coeff")

stderr_model_vote_gpt_2 <- summary(model_vote_gpt_2)$standard.errors %>%
                           as.data.frame() %>%
                           rownames_to_column("party") %>%
                           rename(intercept = "(Intercept)") %>%
                           pivot_longer(cols = !party, names_to = "variable", values_to = "stderr")

z_model_vote_gpt_2 <- summary(model_vote_gpt_2)$coefficients/summary(model_vote_gpt_2)$standard.errors
# cannot transform before calculating p-values

# have to do separately because %>% doesn't work with calculation
p_model_vote_gpt_2 <- (1 - pnorm(abs(z_model_vote_gpt_2), 0, 1)) * 2 # 2-tailed z-test 
p_model_vote_gpt_2 <- p_model_vote_gpt_2 %>%
                      as.data.frame() %>%
                      rownames_to_column("party") %>%
                      rename(intercept = "(Intercept)") %>%
                      pivot_longer(cols = !party, names_to = "variable", values_to = "p_value")


z_model_vote_gpt_2 <- z_model_vote_gpt_2 %>%
                      as.data.frame() %>%
                      rownames_to_column("party") %>%
                      rename(intercept = "(Intercept)") %>%
                      pivot_longer(cols = !party, names_to = "variable", values_to = "z_value")

data_model_vote_gpt_2 <- coeff_model_vote_gpt_2 %>%
                         left_join(stderr_model_vote_gpt_2, by = c("party", "variable")) %>%
                         left_join(p_model_vote_gpt_2, by = c("party", "variable")) %>%
                         left_join(z_model_vote_gpt_2, by = c("party", "variable")) %>%
                         mutate(sample = 2)

## Sample 3

coeff_model_vote_gpt_3 <- summary(model_vote_gpt_3)$coefficients %>%
                           as.data.frame() %>%
                           rownames_to_column("party") %>%
                           rename(intercept = "(Intercept)") %>%
                           pivot_longer(cols = !party, names_to = "variable", values_to = "coeff")

stderr_model_vote_gpt_3 <- summary(model_vote_gpt_3)$standard.errors %>%
                           as.data.frame() %>%
                           rownames_to_column("party") %>%
                           rename(intercept = "(Intercept)") %>%
                           pivot_longer(cols = !party, names_to = "variable", values_to = "stderr")

z_model_vote_gpt_3 <- summary(model_vote_gpt_3)$coefficients/summary(model_vote_gpt_3)$standard.errors
# cannot transform before calculating p-values

# have to do separately because %>% doesn't work with calculation
p_model_vote_gpt_3 <- (1 - pnorm(abs(z_model_vote_gpt_3), 0, 1)) * 2 # 2-tailed z-test 
p_model_vote_gpt_3 <- p_model_vote_gpt_3 %>%
                      as.data.frame() %>%
                      rownames_to_column("party") %>%
                      rename(intercept = "(Intercept)") %>%
                      pivot_longer(cols = !party, names_to = "variable", values_to = "p_value")


z_model_vote_gpt_3 <- z_model_vote_gpt_3 %>%
                      as.data.frame() %>%
                      rownames_to_column("party") %>%
                      rename(intercept = "(Intercept)") %>%
                      pivot_longer(cols = !party, names_to = "variable", values_to = "z_value")

data_model_vote_gpt_3 <- coeff_model_vote_gpt_3 %>%
                         left_join(stderr_model_vote_gpt_3, by = c("party", "variable")) %>%
                         left_join(p_model_vote_gpt_3, by = c("party", "variable")) %>%
                         left_join(z_model_vote_gpt_3, by = c("party", "variable")) %>%
                         mutate(sample = 3)

## Sample 4

coeff_model_vote_gpt_4 <- summary(model_vote_gpt_4)$coefficients %>%
                           as.data.frame() %>%
                           rownames_to_column("party") %>%
                           rename(intercept = "(Intercept)") %>%
                           pivot_longer(cols = !party, names_to = "variable", values_to = "coeff")

stderr_model_vote_gpt_4 <- summary(model_vote_gpt_4)$standard.errors %>%
                           as.data.frame() %>%
                           rownames_to_column("party") %>%
                           rename(intercept = "(Intercept)") %>%
                           pivot_longer(cols = !party, names_to = "variable", values_to = "stderr")

z_model_vote_gpt_4 <- summary(model_vote_gpt_4)$coefficients/summary(model_vote_gpt_4)$standard.errors
# cannot transform before calculating p-values

# have to do separately because %>% doesn't work with calculation
p_model_vote_gpt_4 <- (1 - pnorm(abs(z_model_vote_gpt_4), 0, 1)) * 2 # 2-tailed z-test 
p_model_vote_gpt_4 <- p_model_vote_gpt_4 %>%
                      as.data.frame() %>%
                      rownames_to_column("party") %>%
                      rename(intercept = "(Intercept)") %>%
                      pivot_longer(cols = !party, names_to = "variable", values_to = "p_value")


z_model_vote_gpt_4 <- z_model_vote_gpt_4 %>%
                      as.data.frame() %>%
                      rownames_to_column("party") %>%
                      rename(intercept = "(Intercept)") %>%
                      pivot_longer(cols = !party, names_to = "variable", values_to = "z_value")

data_model_vote_gpt_4 <- coeff_model_vote_gpt_4 %>%
                         left_join(stderr_model_vote_gpt_4, by = c("party", "variable")) %>%
                         left_join(p_model_vote_gpt_4, by = c("party", "variable")) %>%
                         left_join(z_model_vote_gpt_4, by = c("party", "variable")) %>%
                         mutate(sample = 4)

## Sample 5

coeff_model_vote_gpt_5 <- summary(model_vote_gpt_5)$coefficients %>%
                           as.data.frame() %>%
                           rownames_to_column("party") %>%
                           rename(intercept = "(Intercept)") %>%
                           pivot_longer(cols = !party, names_to = "variable", values_to = "coeff")

stderr_model_vote_gpt_5 <- summary(model_vote_gpt_5)$standard.errors %>%
                           as.data.frame() %>%
                           rownames_to_column("party") %>%
                           rename(intercept = "(Intercept)") %>%
                           pivot_longer(cols = !party, names_to = "variable", values_to = "stderr")

z_model_vote_gpt_5 <- summary(model_vote_gpt_5)$coefficients/summary(model_vote_gpt_5)$standard.errors
# cannot transform before calculating p-values

# have to do separately because %>% doesn't work with calculation
p_model_vote_gpt_5 <- (1 - pnorm(abs(z_model_vote_gpt_5), 0, 1)) * 2 # 2-tailed z-test 
p_model_vote_gpt_5 <- p_model_vote_gpt_5 %>%
                      as.data.frame() %>%
                      rownames_to_column("party") %>%
                      rename(intercept = "(Intercept)") %>%
                      pivot_longer(cols = !party, names_to = "variable", values_to = "p_value")


z_model_vote_gpt_5 <- z_model_vote_gpt_5 %>%
                      as.data.frame() %>%
                      rownames_to_column("party") %>%
                      rename(intercept = "(Intercept)") %>%
                      pivot_longer(cols = !party, names_to = "variable", values_to = "z_value")

data_model_vote_gpt_5 <- coeff_model_vote_gpt_5 %>%
                         left_join(stderr_model_vote_gpt_5, by = c("party", "variable")) %>%
                         left_join(p_model_vote_gpt_5, by = c("party", "variable")) %>%
                         left_join(z_model_vote_gpt_5, by = c("party", "variable")) %>%
                         mutate(sample = 5)

# Merge in one df across samples
data_model_vote_gpt_all <- bind_rows(data_model_vote_gpt_1, data_model_vote_gpt_2, data_model_vote_gpt_3, data_model_vote_gpt_4, data_model_vote_gpt_5)
data_model_vote_gpt_all <- data_model_vote_gpt_all %>% rename(sample_no = sample) # for consistency
```

### Aggregation

```{r}
data_model_vote_gpt_mean <- data_model_vote_gpt_all %>%
    group_by(party, variable) %>%
    summarise(W_coeff = mean(stderr^2), # Within variance OF COEFFICIENT (mean)
              mean_coeff = mean(coeff), # Mean estimate (coefficient)
              B_coeff = var(coeff), # Between variance (coefficient)
              mean_stderr = mean(stderr), # Mean estimate (stderr)
              B_stderr = var(stderr), # Between variance (stderr)
              mean_p = mean(p_value), # Mean estimate (p-value)
              B_p = var(p_value)) %>% # Between variance (p-value)
    mutate(m = 5,
           T = W_coeff + (1 + 1/m) * B_coeff, # total variance (Rubin's rules) OF COEFFICIENT
           T_stderr= sqrt(T)) # standard error OF COEFFICIENT --> to be used for CIs



# Optional: Export
export_vote_gpt <- data_model_vote_gpt_mean %>%
                   select(party, variable, mean_coeff, mean_p) %>%
                   mutate(sig = ifelse(mean_p < 0.001, "***",
                                       ifelse(mean_p >= 0.001 & mean_p < 0.01, "**",
                                              ifelse(mean_p >= 0.01 & mean_p < 0.05, "*",
                                                     NA)))) %>%
                   mutate(mean_p = round(mean_p, digits = 3)) %>%
                   pivot_wider(names_from = party,
                               values_from = all_of(c("mean_coeff",
                                                      "mean_p")),
                               names_sep = "_")

write.csv(export_vote_gpt, "model_vote_gpt.csv", row.names = F)

```

## GLES

```{r}
data_onesample <- data_final_numeric_noNA[data_final_numeric_noNA$sample_no == 1,]

model_vote_gles <- multinom(vote ~ age + female + edu + emp + hhincome + east + religious + leftright + partyid*partyid_degree + inequality + immigration, data = data_onesample, na.action = na.omit, Hess = TRUE)

#summary(model_vote_gles)


# Get coeffs, std.errors & test statistics, transform into long format & store as 1 df
coeff_model_vote_gles <- summary(model_vote_gles)$coefficients %>%
                           as.data.frame() %>%
                           rownames_to_column("party") %>%
                           rename(intercept = "(Intercept)") %>%
                           pivot_longer(cols = !party, names_to = "variable", values_to = "coeff")

stderr_model_vote_gles <- summary(model_vote_gles)$standard.errors %>%
                           as.data.frame() %>%
                           rownames_to_column("party") %>%
                           rename(intercept = "(Intercept)") %>%
                           pivot_longer(cols = !party, names_to = "variable", values_to = "stderr")

z_model_vote_gles <- summary(model_vote_gles)$coefficients/summary(model_vote_gles)$standard.errors # Wald Z
# cannot transform before calculating p-values

# have to do separately because %>% doesn't work with calculation
p_model_vote_gles <- (1 - pnorm(abs(z_model_vote_gles), 0, 1)) * 2 # 2-tailed z-test 
p_model_vote_gles <- p_model_vote_gles %>%
                      as.data.frame() %>%
                      rownames_to_column("party") %>%
                      rename(intercept = "(Intercept)") %>%
                      pivot_longer(cols = !party, names_to = "variable", values_to = "p_value")

z_model_vote_gles <- z_model_vote_gles %>%
                      as.data.frame() %>%
                      rownames_to_column("party") %>%
                      rename(intercept = "(Intercept)") %>%
                      pivot_longer(cols = !party, names_to = "variable", values_to = "z_value")

data_model_vote_gles <- coeff_model_vote_gles %>%
                         left_join(stderr_model_vote_gles, by = c("party", "variable")) %>%
                         left_join(p_model_vote_gles, by = c("party", "variable")) %>%
                         left_join(z_model_vote_gles, by = c("party", "variable"))

# Pseudo-R2: 0.4156
model_vote_gles_loglik <- nnet:::logLik.multinom(model_vote_gles)
model_0 <- multinom(vote ~ 1, data = data_onesample)
model_0_loglik <- nnet:::logLik.multinom(model_0)
model_vote_gles_r2 <- as.numeric(1 - model_vote_gles_loglik/model_0_loglik)

# Optional: Export
stargazer(model_vote_gles,
          title = "Determinants of Vote Choice: GLES",
          dep.var.caption = "Dependent variable: Vote (GLES) – Reference: CDU/CSU",
          dep.var.labels.include = FALSE,
          model.numbers = FALSE,
          column.labels = c("SPD", "Greens", "FDP", "Left", "AfD",
                            "Other Party", "Invalid vote", "No vote"),
          covariate.labels = c("Age", "Gender: Female", "Education",
                              "Employment: not working", "Employment: studying",
                              "Income: medium", "Income: high", "East Germany",
                              "Religiosity: not very", "Religiosity: somewhat",
                              "Religiosity: very", "LR-Ideology",
                              "Party ID: SPD", "Party ID: FDP", "Party ID: Greens",
                              "Party ID: Left", "Party ID: AfD", "Party ID: Small party",
                              "Party ID: none", "Strength of Party ID",
                              "Inequality: no opinion", "Inequality: don't act",
                              "Immigration: neither nor", "Immigration: limit",
                            "Party ID x Strength: AfD", "Party ID x Strength: Small party",
                              "Party ID x Strength: none"),
          report = "vc*",
          star.cutoffs = c(0.05, 0.01, 0.001),
          add.lines = list(c("Observations", "1827"), c("Pseudo-R2","0.4156")),
          type = "html",
          out = "model_vote_gles.html",
          summary = TRUE,
          digits = 3
          )

```

## Comparing GLES and GPT models

### Data transformation

```{r}
data_model_vote_gles_merge <- data_model_vote_gles %>%
                              select(!z_value) %>%
                              mutate(model = "GLES")

data_model_vote_gpt_merge <- data_model_vote_gpt_mean %>%
                             select(!starts_with("B")) %>%
                             select(!starts_with("W")) %>%
                             select(!m) %>%
                             select(!T) %>%
                             select(!mean_stderr) %>%
                             rename(coeff = mean_coeff) %>%
                             rename(p_value = mean_p) %>%
                             rename (stderr = T_stderr) %>%
                             mutate(model = "GPT")
# Only relevant if plotting differences in coeffs/ORs
data_model_vote_merge <- bind_rows(data_model_vote_gles_merge, data_model_vote_gpt_merge)
data_model_vote_merge <- data_model_vote_merge %>%
                         pivot_wider(names_from = model,
                               values_from = all_of(c("coeff",
                                                      "p_value",
                                                      "stderr")),
                               names_sep = "_") %>%
                         mutate(diff_coeff = coeff_GPT - coeff_GLES) %>%
                         mutate(diff_coeff_norm = ((coeff_GPT - coeff_GLES)/coeff_GLES)) %>%
                         mutate(diff_p = p_value_GPT - p_value_GLES) %>%
                         mutate(or_GPT = exp(coeff_GPT)) %>%
                         mutate(or_GLES = exp(coeff_GLES)) %>%
                         mutate(diff_or = or_GPT - or_GLES) %>%
                         mutate(diff_or_norm = (or_GPT - or_GLES)/or_GLES) %>%
                         mutate(sig = ifelse(p_value_GLES < 0.05 & p_value_GPT >= 0.05, "GLES",
                                             ifelse(p_value_GPT < 0.05 & p_value_GLES >= 0.05, "GPT",
                                                    ifelse(p_value_GLES < 0.05 & p_value_GPT < 0.05, "Both",
                                                           ifelse(p_value_GLES >= 0.05 & p_value_GPT >=0.05, "None", "check"))))) %>%
                         mutate(party = ifelse(party == "Bündnis 90/Die Grünen", "Greens",
                                        ifelse(party == "Die Linke", "Left",
                                        ifelse(party == "Andere Partei", "Other party",
                                        ifelse(party == "Ungültig gewählt", "Invalid vote",
                                        ifelse(party == "Nicht gewählt", "No vote", party)))))) %>%
                         mutate(variable = ifelse(variable == "intercept", "Intercept",
                                                  ifelse(variable == "age", "Age",      
                                                  ifelse(variable == "femaleweiblich", "Gender: female",
                                                  ifelse(variable == "edu", "Education",
                                                  ifelse(variable == "empnicht berufstätig", "Employment: not working",
                                                  ifelse(variable == "empin Ausbildung", "Employment: studying",
                                                  ifelse(variable == "hhincomemittleres", "Income: medium",
                                                  ifelse(variable == "hhincomehohes", "Income: high",
                                                  ifelse(variable == "eastOstdeutschland", "Residence: East Germany",
                                                  ifelse(variable == "religiousnicht sehr religiös", "Religiosity: not very",
                                                  ifelse(variable == "religiousetwas religiös", "Religiosity: somewhat",
                                                  ifelse(variable == "religioussehr religiös", "Religiosity: very",
                                                  ifelse(variable == "leftright", "LR-Ideology",
                                                  ifelse(variable == "partyidSPD", "Party ID: SPD",
                                                  ifelse(variable == "partyidFDP", "Party ID: FDP",
                                                  ifelse(variable == "partyidDie Grünen", "Party ID: Greens",
                                                  ifelse(variable == "partyidDie Linke", "Party ID: Left",
                                                  ifelse(variable == "partyidAfD", "Party ID: AfD",
                                                  ifelse(variable == "partyidKleinpartei", "Party ID: Small party",
                                                  ifelse(variable == "partyidkeine Partei", "Party ID: none",
                                                  ifelse(variable == "partyid_degree", "Strength of Party ID",
                                                  ifelse(variable == "inequalityhabe keine Meinung dazu", "Att. Inequality: no opinion",
                                                  ifelse(variable == "inequalitykeine Maßnahmen ergreifen", "Att. Inequality: don't take measures",
                                                  ifelse(variable == "immigrationweder erleichtern noch einschränken", "Att. Immigration: neither nor",
                                                  ifelse(variable == "immigrationeinschränken", "Att. Immigration: limit",
                                                  ifelse(variable == "partyidSPD:partyid_degree", "Party ID x Strength: SPD",
                                                  ifelse(variable == "partyidFDP:partyid_degree", "Party ID x Strength: FDP",
                                                  ifelse(variable == "partyidDie Grünen:partyid_degree", "Party ID x Strength: Greens",
                                                  ifelse(variable == "partyidDie Linke:partyid_degree", "Party ID x Strength: Left",
                                                  ifelse(variable == "partyidAfD:partyid_degree", "Party ID x Strength: AfD",
                                                  ifelse(variable == "partyidKleinpartei:partyid_degree", "Party ID x Strength: Small party",
                                                  ifelse(variable == "partyidkeine Partei:partyid_degree", "Party ID x Strength: none", variable)))))))))))))))))))))))))))))))))
```

### Plot coeffs & CIs, only significant vars

```{r}
data_plot_vote_compare <- bind_rows(data_model_vote_gles_merge, data_model_vote_gpt_merge) %>%
                          filter(variable != "partyidkeine Partei:partyid_degree") %>%
                          mutate(lower = coeff - 1.96*stderr,
                                 upper = coeff + 1.96*stderr,
                                 oddsratio = exp(coeff)) %>%
                          mutate(lower_or = exp(lower),
                                 upper_or = exp(upper)) %>%
                          mutate(sig = ifelse(p_value < 0.05, "Significant",
                                              "Not significant")) %>%
                          mutate(party = ifelse(party == "Bündnis 90/Die Grünen", "Greens",
                                         ifelse(party == "Die Linke", "Left",
                                         ifelse(party == "Andere Partei", "Small party",
                                         ifelse(party == "Ungültig gewählt", "Invalid vote",
                                         ifelse(party == "Nicht gewählt", "No vote", party)))))) %>%
                          mutate(party = factor(party,
                                          levels = c("SPD", "Greens", "FDP", "Left","AfD", "Small party", "Invalid vote", "No vote"))) %>%
                          rename(category = variable) %>%
                          mutate(variable = ifelse(category == "intercept", "Intercept",
                                            ifelse(category == "age", "Age",
                                            ifelse(category == "femaleweiblich", "Gender (Ref.: male)",
                                            ifelse(category == "edu", "Education",
                                            ifelse(category == "empnicht berufstätig" | category == "empin Ausbildung", "Employment (Ref.: working)",
                                            ifelse(category == "hhincomemittleres" | category == "hhincomehohes", "Income (Ref.: low)",
                                            ifelse(category == "eastOstdeutschland", "Residence (Ref.: West Germany)",
                                            ifelse(category == "religiousnicht sehr religiös" | category == "religiousetwas religiös" | category == "religioussehr religiös", "Religiosity (Ref.: not at all)",
                                            ifelse(category == "leftright", "Ideology",
                                            ifelse(category == "partyidSPD"| category == "partyidFDP" | category == "partyidDie Grünen" | category == "partyidDie Linke" | category == "partyidAfD" | category == "partyidKleinpartei"| category == "partyidkeine Partei", "Party ID (Ref.: CDU/CSU)",
                                            ifelse(category == "partyid_degree", "Strength of Party ID",
                                            ifelse(category == "partyidAfD:partyid_degree" | category == "partyidDie Grünen:partyid_degree" | category == "partyidDie Linke:partyid_degree" | category == "partyidFDP:partyid_degree" | category == "partyidKleinpartei:partyid_degree" | category == "partyidSPD:partyid_degree" | category == "partyidkeine Partei:partyid_degree", "Party ID x Strength (Ref.: CDU/CSU)",        
                                            ifelse(category == "inequalityhabe keine Meinung dazu" | category == "inequalitykeine Maßnahmen ergreifen", "Att. Inequality (Ref.: take measures)",         
                                            ifelse(category == "immigrationweder erleichtern noch einschränken" | category == "immigrationeinschränken", "Att. Immigration (Ref.: facilitate)",
                                            category))))))))))))))) %>%
                          mutate(category = ifelse(category == "femaleweiblich", "female",
                                        ifelse(category == "edu", " ",
                                        ifelse(category == "age", " ",
                                        ifelse(category == "empnicht berufstätig", "not working",
                                        ifelse(category == "empin Ausbildung", "studying",
                                        ifelse(category == "hhincomemittleres", "medium",
                                        ifelse(category == "hhincomehohes", "high",
                                        ifelse(category == "eastOstdeutschland", "East Germany",
                                        ifelse(category == "religiousnicht sehr religiös", "not very",
                                        ifelse(category == "religiousetwas religiös", "somewhat",
                                        ifelse(category == "religioussehr religiös", "very",
                                        ifelse(category == "leftright", " ",
                                        ifelse(category == "partyidSPD", "SPD",
                                        ifelse(category == "partyidFDP", "FDP",
                                        ifelse(category == "partyidDie Grünen", "Greens",
                                        ifelse(category == "partyidDie Linke", "Left",
                                        ifelse(category == "partyidAfD", "AfD",
                                        ifelse(category == "partyidKleinpartei", "Small party",
                                        ifelse(category == "partyidkeine Partei", "none",
                                        ifelse(category == "partyid_degree", " ",
                                        ifelse(category == "inequalityhabe keine Meinung dazu", "no opinion",
                                        ifelse(category == "inequalitykeine Maßnahmen ergreifen", "don't take measures",
                                        ifelse(category == "immigrationweder erleichtern noch einschränken", "neither nor",
                                        ifelse(category == "immigrationeinschränken", "limit",
                                        ifelse(category == "intercept", " ",
                                        ifelse(category == "partyidAfD:partyid_degree", "AfD",
                                        ifelse(category == "partyidDie Grünen:partyid_degree", "Greens",
                                        ifelse(category == "partyidDie Linke:partyid_degree", "Left",
                                        ifelse(category == "partyidFDP:partyid_degree", "FDP",
                                        ifelse(category == "partyidKleinpartei:partyid_degree", "Small party",
                                        ifelse(category == "partyidkeine Partei:partyid_degree", "none",       
                                        ifelse(category == "partyidSPD:partyid_degree", "SPD",
                                        category))))))))))))))))))))))))))))))))) %>%
  mutate(interaction_cat_var = interaction(category, variable, sep = "&")) %>%
  mutate(interaction_cat_var = factor(interaction_cat_var,
                                      levels = c(" &Intercept",
                                                 "limit&Att. Immigration (Ref.: facilitate)", "neither nor&Att. Immigration (Ref.: facilitate)",
                                                "don't take measures&Att. Inequality (Ref.: take measures)", "no opinion&Att. Inequality (Ref.: take measures)",
                                                "Small party&Party ID x Strength (Ref.: CDU/CSU)", "AfD&Party ID x Strength (Ref.: CDU/CSU)", "Left&Party ID x Strength (Ref.: CDU/CSU)", "FDP&Party ID x Strength (Ref.: CDU/CSU)", "Greens&Party ID x Strength (Ref.: CDU/CSU)", "SPD&Party ID x Strength (Ref.: CDU/CSU)",
                                                 " &Strength of Party ID",
                                                 "none&Party ID (Ref.: CDU/CSU)", "Small party&Party ID (Ref.: CDU/CSU)", "AfD&Party ID (Ref.: CDU/CSU)", "Left&Party ID (Ref.: CDU/CSU)", "FDP&Party ID (Ref.: CDU/CSU)", "Greens&Party ID (Ref.: CDU/CSU)", "SPD&Party ID (Ref.: CDU/CSU)",
                                                 " &Ideology",
                                                 "very&Religiosity (Ref.: not at all)", "somewhat&Religiosity (Ref.: not at all)", "not very&Religiosity (Ref.: not at all)",
                                                 "East Germany&Residence (Ref.: West Germany)",
                                                 "high&Income (Ref.: low)", "medium&Income (Ref.: low)",
                                                "not working&Employment (Ref.: working)", "studying&Employment (Ref.: working)",
                                                 " &Education",
                                                 "female&Gender (Ref.: male)",
                                                 " &Age")
  ))

# Export
export_vote_compare <- data_plot_vote_compare %>%
                   select(party, variable, category, coeff, p_value, model) %>%
                   mutate(sig = ifelse(p_value < 0.001, "***",
                                       ifelse(p_value >= 0.001 & p_value < 0.01, "**",
                                              ifelse(p_value >= 0.01 & p_value < 0.05, "*",
                                                     NA)))) %>%
                   mutate(p_value = round(p_value, digits = 3)) %>%
                   pivot_wider(names_from = party,
                               values_from = all_of(c("coeff",
                                                      "p_value",
                                                       "sig")),
                               names_sep = "_")

write.csv(export_vote_compare, "model_vote_compare.csv", row.names = F)

# Plot
plot_vote_compare <- ggplot(data_plot_vote_compare[data_plot_vote_compare$sig == "Significant",], 
       aes(y = interaction_cat_var,
           x = coeff,
           xmin = lower,
           xmax = upper,
           color = model)) + # legend colored by model
  geom_vline(xintercept = 0,
             linetype = "solid",
             linewidth = 0.2) +
 geom_pointrange(# error bars
                 linewidth = 0.5,
                 shape = 1#,
                 ) +
  guides(y = guide_axis_nested(delim = "&")) + 
  xlim(-20, 15) +
  scale_color_manual(limits = c("GLES", "GPT"),
                      values = c("GLES" = "#027333", "GPT" = "#FAA32B"),
                     labels = c("GLES", "GPT-3")) +
  facet_grid(.~party) +
  theme_minimal() +
  labs(
    x = "ß (additive effect on log-odds) - only variables with p < 0.05",
    y = "",
    title = "Determinants of Vote Choice According to GLES and GPT \n(Reference: CDU/CSU)") +
  theme(
        legend.position = "top",
        legend.title = element_blank(),
        plot.title.position = "plot"
        )

ggsave("model_vote.png", plot_vote_compare, height = 6, width = 10)
```

```{r}
plot_vote_compare
```

The null-model predicts higher odds for Non-voting, SPD, AfD and lower odds for the other parties based on GLES data, but higher odds for all parties except small and irregular votes based on GPT data! Confirms descriptive results

## AMEs

```{r}
# GLES
ame_gles <- avg_slopes(model_vote_gles, type = "probs")
ame_gles <- ame_gles %>%
            select(group, term, contrast, estimate, p.value, conf.low, conf.high, std.error) %>%
            mutate(model = "GLES")

#GPT

##Sample 1
ame_gpt_1 <- avg_slopes(model_vote_gpt_1, type = "probs")
ame_gpt_1 <- ame_gpt_1 %>% mutate(sample = 1)

##Sample 2
ame_gpt_2 <- avg_slopes(model_vote_gpt_2, type = "probs")
ame_gpt_2 <- ame_gpt_2 %>% mutate(sample = 2)

##Sample 3
ame_gpt_3 <- avg_slopes(model_vote_gpt_3, type = "probs")
ame_gpt_3 <- ame_gpt_3 %>% mutate(sample = 3)

##Sample 4
ame_gpt_4 <- avg_slopes(model_vote_gpt_4, type = "probs")
ame_gpt_4 <- ame_gpt_4 %>% mutate(sample = 4)

##Sample 5
ame_gpt_5 <- avg_slopes(model_vote_gpt_5, type = "probs")
ame_gpt_5 <- ame_gpt_5%>% mutate(sample = 5)

## Variance Estimation
ame_gpt_all <- bind_rows(ame_gpt_1, ame_gpt_2, ame_gpt_3, ame_gpt_4, ame_gpt_5)

ame_gpt_mean <- ame_gpt_all %>%
    group_by(group, #party
             term, #variable
             contrast #category/AME
             ) %>%
    summarise(W_est = mean(std.error^2), # Within variance OF COEFFICIENT (mean)
              mean_est = mean(estimate), # Mean AME
              B_est = var(estimate), # Between variance (AME)
              mean_p = mean(p.value), # Mean estimate (p-value)
              B_p = var(p.value), # Between variance (p-value)
              mean_low = mean(conf.low),
              B_low = var(conf.low),
              mean_high = mean(conf.high),
              B_high = var(conf.high)) %>% 
    mutate(m = 5,
           T = W_est + (1 + 1/m) * B_est, # total variance (Rubin's rules) OF COEFFICIENT
           T_stderr= sqrt(T)) # standard error OF COEFFICIENT --> to be used for CIs
ame_gpt_merge <- ame_gpt_mean %>%
                 select(group, term, contrast, mean_est, mean_p, mean_low, mean_high, T_stderr) %>%
                 rename(estimate = mean_est,
                        p.value = mean_p,
                        conf.low = mean_low,
                        conf.high = mean_high,
                        std.error = T_stderr) %>%
                 mutate(model = "GPT")

# Merge

data_plot_ame_compare <- bind_rows(ame_gles, ame_gpt_merge) %>%
                         rename(party = group,
                                variable = term) %>%
                         mutate(party = ifelse(party == "Bündnis 90/Die Grünen", "Greens",
                                         ifelse(party == "Die Linke", "Left",
                                         ifelse(party == "Andere Partei", "Small party",
                                         ifelse(party == "Ungültig gewählt", "Invalid vote",
                                         ifelse(party == "Nicht gewählt", "No vote", party)))))) %>%
                          mutate(party = factor(party,
                                          levels = c("CDU/CSU", "SPD", "Greens", "FDP", "Left","AfD", "Small party", "Invalid vote", "No vote"))) %>%
                          mutate(contrast = ifelse(contrast == "weiblich - männlich", "<b>Gender:<b> female",
                                        ifelse(contrast == "dY/dX" & variable == "edu", "<b>Education<b>",
                                        ifelse(contrast == "dY/dX" & variable == "age", "<b>Age<b>",
                                        ifelse(contrast == "nicht berufstätig - berufstätig", "not working",
                                        ifelse(contrast == "in Ausbildung - berufstätig", "<b>Employment:<b> studying",
                                        ifelse(contrast == "mittleres - niedriges", "<b>Income:<b> medium",
                                        ifelse(contrast == "hohes - niedriges", "high",
                                        ifelse(contrast == "Ostdeutschland - Westdeutschland", "<b>Residence:<b> East Germany",
                                        ifelse(contrast == "nicht sehr religiös - überhaupt nicht religiös", "<b>Religiosity:<b> not very",
                                        ifelse(contrast == "etwas religiös - überhaupt nicht religiös", "somewhat",
                                        ifelse(contrast == "sehr religiös - überhaupt nicht religiös", "very",
                                        ifelse(contrast == "dY/dX" & variable == "leftright", "<b>Ideology<b>",
                                        ifelse(contrast == "SPD - CDU/CSU", "<b>Party ID:<b> SPD",
                                        ifelse(contrast == "FDP - CDU/CSU", "FDP",
                                        ifelse(contrast == "Die Grünen - CDU/CSU", "Greens",
                                        ifelse(contrast == "Die Linke - CDU/CSU", "Left",
                                        ifelse(contrast == "AfD - CDU/CSU", "AfD",
                                        ifelse(contrast == "Kleinpartei - CDU/CSU", "Small party",
                                        ifelse(contrast == "keine Partei - CDU/CSU", "none",
                                        ifelse(contrast == "dY/dX" & variable == "partyid_degree", "<b>Strength of Party ID<b>",
                                        ifelse(contrast == "habe keine Meinung dazu - Maßnahmen ergreifen", "<b>Att. Inequality:<b> no opinion",
                                        ifelse(contrast == "keine Maßnahmen ergreifen - Maßnahmen ergreifen", "don't take measures",
                                        ifelse(contrast == "weder erleichtern noch einschränken - erleichtern", "<b>Att. Immigration:<b> neither nor",
                                        ifelse(contrast == "einschränken - erleichtern", "limit",
                                        contrast))))))))))))))))))))))))) %>%
  mutate(contrast = factor(contrast,
                           levels = c("limit", "<b>Att. Immigration:<b> neither nor",
                                                "don't take measures", "<b>Att. Inequality:<b> no opinion",
                                                 "<b>Strength of Party ID<b>",
                                                 "none", "Small party", "AfD", "Left", "FDP", "Greens", "<b>Party ID:<b> SPD",
                                                 "<b>Ideology<b>",
                                                 "very", "somewhat", "<b>Religiosity:<b> not very",
                                                 "<b>Residence:<b> East Germany",
                                                 "high", "<b>Income:<b> medium",
                                                "not working", "<b>Employment:<b> studying",
                                                 "<b>Education<b>",
                                                 "<b>Gender:<b> female",
                                                 "<b>Age<b>")
  ))


# Plot

plot_ame_compare <- ggplot(data_plot_ame_compare[data_plot_ame_compare$p.value < 0.05,],
       aes(y = contrast,
           x = estimate,
           xmin = conf.low,
           xmax = conf.high,
           color = model # legend colored by model
           )) +
  geom_vline(xintercept = 0,
             linetype = "solid",
             linewidth = 0.2) +
 geom_pointrange(# error bars
                 linewidth = 0.5,
                 shape = 1#,
                 ) +
  #xlim(-20, 15) +
  scale_color_manual(limits = c("GLES", "GPT"),
                      values = c("GLES" = "#027333", "GPT" = "#FAA32B"),
                     labels = c("GLES", "GPT-3")) +
  facet_grid(.~party) +
  theme_minimal() +
  labs(
    x = "Average Marginal Effect - only variables with p < 0.05",
    y = "",
    title = "Average Marginal Effects on Vote Choice According to GLES and GPT") +
  theme(
        legend.position = "top",
        legend.title = element_blank(),
        plot.title.position = "plot",
        axis.text.y = ggtext::element_markdown()
        )

ggsave("model_vote_ame.png", plot_ame_compare, height = 6, width = 12)
```

# ROBUSTNESS

## Imputed vs. non-imputed

### Data transformation

```{r}
mc_GLES2017_robustness <- bind_rows(mc_GLES2017_complete, mc_GLES2017_final_nonimputed)

mc_GLES2017_robustness <- mc_GLES2017_robustness %>%
                          mutate(imputed = ifelse(is.na(imputed), 1, imputed))

data_robustness_factors <- mc_GLES2017_robustness %>%
                      mutate(
    female = factor(female,
                    levels = c("männlich","weiblich"),
                    labels = c("männlich","weiblich")),
    edu = factor(edu,
                 levels = c("keinen Schulabschluss",
                            "einen Hauptschulabschluss",
                            "einen Realschulabschluss",
                            "Abitur",
                            "einen Hochschulabschluss"), 
                 labels = c("keinen Schulabschluss",
                            "einen Hauptschulabschluss",
                            "einen Realschulabschluss",
                            "Abitur",
                            "einen Hochschulabschluss"),
                 ordered = FALSE),
    emp = factor(emp,
                 levels = c("berufstätig",
                            "nicht berufstätig",
                            "in Ausbildung"),
                 labels = c("berufstätig",
                            "nicht berufstätig",
                            "in Ausbildung")),
    hhincome = factor(hhincome,
                      levels = c("niedriges", "mittleres", "hohes"), 
                      labels = c("niedriges", "mittleres", "hohes"),
                      ordered = FALSE),
    east = factor(east,
                  levels = c("Westdeutschland",
                             "Ostdeutschland"),
                  labels = c("Westdeutschland",
                             "Ostdeutschland")),
    religious = factor(religious,
                       levels = c("überhaupt nicht religiös",
                                  "nicht sehr religiös",
                                  "etwas religiös",
                                  "sehr religiös"), 
                       labels = c("überhaupt nicht religiös",
                                  "nicht sehr religiös",
                                  "etwas religiös",
                                  "sehr religiös"),
                       ordered = FALSE),
    leftright = factor(leftright,
                       levels = c("stark links",
                                  "mittig links",
                                  "in der Mitte",
                                  "mittig rechts",
                                  "stark rechts"),
                       labels = c("stark links",
                                  "mittig links",
                                  "in der Mitte",
                                  "mittig rechts",
                                  "stark rechts"),
                       ordered = FALSE),
    partyid = factor(partyid,
                     levels = c("mit der Partei CDU/CSU",
                                "mit der Partei SPD", 
                                "mit der Partei FDP",
                                "mit der Partei Bündnis 90/Die Grünen",
                                "mit der Partei Die Linke",
                                "mit der Partei AfD",
                                "mit einer Kleinpartei",
                                "mit keiner Partei"),
                     labels = c("CDU/CSU",
                                "SPD", 
                                "FDP",
                                "Die Grünen",
                                "Die Linke",
                                "AfD",
                                "Kleinpartei",
                                "keine Partei")),
    partyid_degree = ifelse(partyid_degree == "", "überhaupt nicht", partyid_degree), # NAs to zero
    partyid_degree = factor(partyid_degree,
                            levels = c("überhaupt nicht",
                                       "sehr schwach ",
                                       "ziemlich schwach ",
                                       "mäßig ",
                                       "ziemlich stark ",
                                       "sehr stark "),
                            labels = c("überhaupt nicht",
                                       "sehr schwach",
                                       "ziemlich schwach",
                                       "mäßig",
                                       "ziemlich stark",
                                       "sehr stark"),
                            ordered = FALSE),
    inequality = factor(inequality,
                        levels = c("Maßnahmen ergreifen",
                                   "habe keine Meinung dazu, ob die Regierung Maßnahmen ergreifen sollte",
                                   "keine Maßnahmen ergreifen"),
                        labels = c("Maßnahmen ergreifen",
                                   "habe keine Meinung dazu",
                                   "keine Maßnahmen ergreifen"),
                        ordered = FALSE),
    immigration = factor(immigration,
                         levels = c("erleichtern",
                                    "weder erleichtern noch einschränken",
                                    "einschränken"), 
                         labels = c("erleichtern",
                                    "weder erleichtern noch einschränken",
                                    "einschränken"),
                         ordered = FALSE),
    vote = factor(vote,
                  levels = c("CDU/CSU",
                             "SPD",
                             "Bündnis 90/Die Grünen",
                             "FDP",
                             "Die Linke",
                             "AfD",
                             "Andere Partei",
                             "Ungültig gewählt",
                             "Nicht gewählt"),
                  labels = c("CDU/CSU",
                             "SPD",
                             "Bündnis 90/Die Grünen",
                             "FDP",
                             "Die Linke",
                             "AfD",
                             "Andere Partei",
                             "Ungültig gewählt",
                             "Nicht gewählt")),
    vote_gpt = factor(vote_gpt,
                      levels = c("CDU/CSU",
                             "SPD",
                             "Bündnis 90/Die Grünen",
                             "FDP",
                             "Die Linke",
                             "AfD",
                             "Andere Partei",
                             "Ungültig gewählt",
                             "Nicht gewählt"),
                      labels = c("CDU/CSU",
                             "SPD",
                             "Bündnis 90/Die Grünen",
                             "FDP",
                             "Die Linke",
                             "AfD",
                             "Andere Partei",
                             "Ungültig gewählt",
                             "Nicht gewählt"))
                      )
# Transform variables with 5 categories to numeric
data_robustness_numeric <- data_robustness_factors %>%
                      mutate(
                        edu = ifelse(edu == "keinen Schulabschluss", 0,
                                     ifelse(edu == "einen Hauptschulabschluss", 1,
                                            ifelse(edu == "einen Realschulabschluss", 2,
                                                   ifelse(edu == "Abitur", 3,
                                                          ifelse(edu == "einen Hochschulabschluss", 4,
                                                                 NA))))),
                        leftright = ifelse(leftright == "stark links", -2,
                                           ifelse(leftright == "mittig links", -1,
                                                  ifelse(leftright == "in der Mitte", 0,
                                                         ifelse(leftright == "mittig rechts", 1,
                                                                ifelse(leftright == "stark rechts", 2,
                                                                       NA))))),
                        partyid_degree = ifelse(partyid_degree == "überhaupt nicht", 0,
                                                ifelse(partyid_degree == "sehr schwach", 1,
                                                       ifelse(partyid_degree == "ziemlich schwach", 2,
                                                              ifelse(partyid_degree == "mäßig", 3,
                                                                     ifelse(partyid_degree == "ziemlich stark", 4,
                                                                            ifelse(partyid_degree == "sehr stark", 5,
                                                                                   NA))))))
                      )

# Removing respondents that have at least one NA in gpt_vote (for comparability between samples)

data_robustness_numeric_noNA <- data_robustness_numeric %>%
                           drop_na("vote_gpt") %>% 
                           group_by(id) %>%
                           filter(sum(id)/5==id) %>%
                           ungroup()
```

```{r}
prop.table(table(data_final_numeric$vote_gpt, useNA = "always"))
prop.table(table(data_robustness_numeric$vote_gpt, useNA = "always"))
```

More than twice as many NAs (2% instead of 0.9%) ! Resulting in only 1755 instead of 1827 (of 1905) respondents being included in regressions. 96% of main sample, 92% of total sample.

### MATCHING: Prediction between GPT and GLES

Can LLMs accurately emulate response distributions of population subgroups?

#### Aggregate: Shares of correct and incorrect matches overall (Variance Estimation)

```{r}
# Calculate proportions and its variance for each iteration
sample_proportions_match_r <- mc_GLES2017_robustness %>%
    group_by(sample_no, match_vote_outcome) %>%
    summarise(n = n(), .groups = "keep") %>%
    ungroup(match_vote_outcome) %>%
    mutate(prop_estimate = n / sum(n)) %>%
    mutate(prop_variance = prop_estimate * (1 - prop_estimate) / sum(n))

# Calculate the between-iteration variance and total variance
mean_proportions_match_r <- sample_proportions_match_r %>%
    group_by(match_vote_outcome) %>%
    summarise(W = mean(prop_variance), # Within variance (mean)
              mean_prop = mean(prop_estimate),
              B = var(prop_estimate)) %>% # Between variance
    mutate(m = 5,
           T = W + (1 + 1/m) * B,
           T_stderr= sqrt(T)) %>% # total variance (Rubin's rules) 
    arrange(desc(mean_prop))
```

- Average still at 0.46 match and variance still 0.0001 (stderr 0.01) - No difference

#### Aggregate: Recall - Shares of correct and incorrect matches by GLES party vote

```{r}
# Across samples
table_matches_parties_s_r <- prop.table(table(mc_GLES2017_robustness$vote, mc_GLES2017_robustness$match_vote_outcome), 1)

data_matches_parties_s_r <- as.data.frame(table_matches_parties_s_r)
data_matches_parties_s_r <- data_matches_parties_s_r %>%
                            rename(match = Var2) %>%
                            rename(party = Var1)

table_matches_overall_c_r <- table(mc_GLES2017_robustness$match_vote_outcome)
table_matches_overall_s_r <- prop.table(table_matches_overall_c_r)

data_matches_overall_s_r <- as.data.frame(table_matches_overall_s_r)
data_matches_overall_s_r <- data_matches_overall_s_r %>%
                          mutate(sample = "Overall") %>%
                          rename(match = Var1)

data_matches_overall_parties_s_r <- data_matches_overall_s_r %>%
                                  rename(party = sample) %>%
                                  mutate(party = factor(party))


data_matches_parties_all_r <- bind_rows(data_matches_overall_parties_s_r, data_matches_parties_s_r) %>%
                            mutate(party = ifelse(party == "Bündnis 90/Die Grünen", "Greens",
                                         ifelse(party == "Die Linke", "Left",
                                         ifelse(party == "Andere Partei", "Small party",
                                         ifelse(party == "Ungültig gewählt", "Invalid vote",
                                         ifelse(party == "Nicht gewählt", "No vote",
                                         ifelse(party == "CDU/CSU", "CDU/CSU",
                                         ifelse(party == "FDP", "FDP",
                                         ifelse(party == "SPD", "SPD",
                                         ifelse(party == "AfD", "AfD", 
                                         ifelse(party == "Overall", "Overall", party)))))))))))

plot_matches_parties_r <- ggplot(data_matches_parties_all_r,
                       aes(x = party,
                           y = Freq,
                           fill = match)) +
                      geom_bar(stat = "identity", position = "stack") +
                      geom_text(aes(label = paste0(round(Freq*100,1),"%")),
                                # TO DO: fix colors white/black
                                position = position_fill(0.5), color = "white") +
                      xlab("Vote Choice (GLES)") +
                      ylab("") +
                      scale_x_discrete(limits = c("Overall", "Greens", "CDU/CSU", "Left",
                                                  "SPD", "FDP", "AfD", "Small party", "No vote",
                                                  "Invalid vote")) + # reorder categories
                      scale_y_continuous(labels = scales::percent) +
                      scale_fill_manual(values = c("FALSE" = "#012340", "TRUE" = "#03A63C"), 
                                        labels = c("different", "match"),
                                        name = "GPT Prediction") +
                      ggtitle("") +
                      theme_minimal() +
                      theme(panel.grid.minor = element_blank(),
                            panel.grid.major = element_blank())

ggsave("matches_parties_r.png", plot_matches_parties_r, height = 4, width = 8)

```

```{r}
plot_matches_parties_r
```

- Same order and similar magnitude - No difference

#### Aggregate: Precision: Share of correct and incorrect matches by GPT party vote

```{r}
table_matches_gpt_s_r <- prop.table(table(mc_GLES2017_robustness$vote_gpt, mc_GLES2017_robustness$match_vote_outcome), 1)

data_matches_gpt_s_r <- as.data.frame(table_matches_gpt_s_r)
data_matches_gpt_s_r <- data_matches_gpt_s_r %>%
                            rename(match = Var2) %>%
                            rename(party = Var1)

data_matches_gpt_all_r <- bind_rows(data_matches_overall_parties_s_r, data_matches_gpt_s_r) %>%
                            mutate(party = ifelse(party == "Bündnis 90/Die Grünen", "Greens",
                                         ifelse(party == "Die Linke", "Left",
                                         ifelse(party == "Andere Partei", "Small party",
                                         ifelse(party == "Ungültig gewählt", "Invalid vote",
                                         ifelse(party == "Nicht gewählt", "No vote",
                                         ifelse(party == "CDU/CSU", "CDU/CSU",
                                         ifelse(party == "FDP", "FDP",
                                         ifelse(party == "SPD", "SPD",
                                         ifelse(party == "AfD", "AfD", 
                                         ifelse(party == "Overall", "Overall", party)))))))))))

plot_matches_gpt_r <- ggplot(data_matches_gpt_all_r,
                       aes(x = party,
                           y = Freq,
                           fill = match)) +
                      geom_bar(stat = "identity", position = "stack") +
                      geom_text(aes(label = paste0(round(Freq*100,1),"%")),
                                # TO DO: fix colors white/black
                                position = position_fill(0.5), color = "white") +
                      xlab("Vote Choice (GPT)") +
                      ylab("") +
                      scale_x_discrete(limits = c("Overall", "CDU/CSU", "SPD","Small party",
                                                  "FDP", "Greens", "AfD", "Left",
                                                  "No vote", "Invalid vote")) + # reorder categories
                      scale_y_continuous(labels = scales::percent) +
                      scale_fill_manual(values = c("FALSE" = "#012340", "TRUE" = "#03A63C"), 
                                        labels = c("different", "match"),
                                        name = "GLES-Vote") +
                      ggtitle("") +
                      theme_minimal() +
                      theme(panel.grid.minor = element_blank(),
                            panel.grid.major = element_blank())

ggsave("matches_gpt_r.png", plot_matches_gpt_r, height = 4, width = 8)
```

```{r}
plot_matches_gpt_r
```

- Nearly same order (except SPD and Small party switching spots and FDP now ahead of Greens & AfD) and similar magnitude (despite switches in order) - Slightly better precision for SPD and FDP than with main sample

#### Aggregate: F1 Scores (Variance Estimation)

```{r}
## Recall

# Calculate proportions and its variance for each iteration
sample_proportions_match_party_r <- mc_GLES2017_robustness %>%
    group_by(sample_no, match_vote_outcome, vote) %>%
    summarise(n = n(), .groups = "keep") %>%
    ungroup(match_vote_outcome) %>%
    mutate(prop_estimate = n / sum(n)) %>%
    mutate(prop_variance = prop_estimate * (1 - prop_estimate) / sum(n))

# Calculate the between-iteration variance and total variance
mean_proportions_match_party_r <- sample_proportions_match_party_r %>%
    group_by(match_vote_outcome, vote) %>%
    summarise(W = mean(prop_variance), # Within variance (mean)
              mean_prop = mean(prop_estimate),
              B = var(prop_estimate)) %>% # Between variance
    mutate(m = 5,
           T = W + (1 + 1/m) * B,
           T_stderr= sqrt(T)) %>% # total variance (Rubin's rules) 
    arrange(desc(mean_prop))

data_recall_varest_r <- mean_proportions_match_party_r %>%
                         filter(match_vote_outcome == TRUE) %>%
                         select(vote, W, mean_prop, B, T_stderr) %>%
                         rename(recall = mean_prop,
                                recall_W = W,
                                recall_B = B,
                                recall_totalse = T_stderr,
                                party = vote)

## Precision

# Calculate proportions and its variance for each iteration
sample_proportions_match_gpt_r <- mc_GLES2017_robustness %>%
    group_by(sample_no, match_vote_outcome, vote_gpt) %>%
    summarise(n = n(), .groups = "keep") %>%
    ungroup(match_vote_outcome) %>%
    mutate(prop_estimate = n / sum(n)) %>%
    mutate(prop_variance = prop_estimate * (1 - prop_estimate) / sum(n))

# Calculate the between-iteration variance and total variance
mean_proportions_match_gpt_r <- sample_proportions_match_gpt_r %>%
    group_by(match_vote_outcome, vote_gpt) %>%
    summarise(W = mean(prop_variance), # Within variance (mean)
              mean_prop = mean(prop_estimate),
              B = var(prop_estimate)) %>% # Between variance
    mutate(m = 5,
           T = W + (1 + 1/m) * B,
           T_stderr= sqrt(T)) %>% # total variance (Rubin's rules) 
    arrange(desc(mean_prop))

data_precision_varest_r <- mean_proportions_match_gpt_r %>%
                         filter(match_vote_outcome == TRUE) %>%
                         select(vote_gpt, W, mean_prop, B, T_stderr) %>%
                         rename(precision = mean_prop,
                                precision_W = W,
                                precision_B = B,
                                precision_totalse = T_stderr,
  
                                                              party = vote_gpt)
## F1

data_f1_varest_r <- merge(data_precision_varest_r, data_recall_varest_r, by = "party")

data_f1_varest_r <- data_f1_varest_r %>%
                  mutate(f1 = (2*precision*recall) / (precision + recall)) %>%
                  select(!c(match_vote_outcome.x, match_vote_outcome.y))
```

- Minimal changes in magnitude, but not in order - No difference overall

#### Individual level: Heatmap of % matches per subgroup

Note:
- Aggregated age to 3 groups: 18-34, 35-64, 65+ (range in data: 18-95)
- There are no "Invalid vote" & Match == TRUE groups!

```{r}
# Gender

## Calculate proportions and its variance for each iteration
sample_proportions_match_party_gender_r <- mc_GLES2017_robustness %>%
    group_by(sample_no, match_vote_outcome, vote, female) %>%
    summarise(n = n(), .groups = "keep") %>%
    ungroup(match_vote_outcome) %>%
    mutate(prop_estimate = n / sum(n)) %>%
    mutate(prop_variance = prop_estimate * (1 - prop_estimate) / sum(n))

## Calculate the between-iteration variance and total variance
mean_proportions_match_party_gender_r <- sample_proportions_match_party_gender_r %>%
    group_by(match_vote_outcome, vote, female) %>%
    summarise(W = mean(prop_variance), # Within variance (mean)
              mean_prop = mean(prop_estimate),
              B = var(prop_estimate)) %>% # Between variance
    mutate(m = 5,
           T = W + (1 + 1/m) * B,
           T_stderr= sqrt(T)) %>% # total variance (Rubin's rules)
    rename(variable = female) %>%
    arrange(desc(mean_prop))

# Education

## Calculate proportions and its variance for each iteration
sample_proportions_match_party_edu_r <- mc_GLES2017_robustness %>%
    group_by(sample_no, match_vote_outcome, vote, edu) %>%
    summarise(n = n(), .groups = "keep") %>%
    ungroup(match_vote_outcome) %>%
    mutate(prop_estimate = n / sum(n)) %>%
    mutate(prop_variance = prop_estimate * (1 - prop_estimate) / sum(n))

## Calculate the between-iteration variance and total variance
mean_proportions_match_party_edu_r <- sample_proportions_match_party_edu_r %>%
    group_by(match_vote_outcome, vote, edu) %>%
    summarise(W = mean(prop_variance), # Within variance (mean)
              mean_prop = mean(prop_estimate),
              B = var(prop_estimate)) %>% # Between variance
    mutate(m = 5,
           T = W + (1 + 1/m) * B,
           T_stderr= sqrt(T)) %>% # total variance (Rubin's rules)
    rename(variable = edu) %>%
    arrange(desc(mean_prop))

# Employment Status

## Calculate proportions and its variance for each iteration
sample_proportions_match_party_emp_r <- mc_GLES2017_robustness %>%
    group_by(sample_no, match_vote_outcome, vote, emp) %>%
    summarise(n = n(), .groups = "keep") %>%
    ungroup(match_vote_outcome) %>%
    mutate(prop_estimate = n / sum(n)) %>%
    mutate(prop_variance = prop_estimate * (1 - prop_estimate) / sum(n))

## Calculate the between-iteration variance and total variance
mean_proportions_match_party_emp_r <- sample_proportions_match_party_emp_r %>%
    group_by(match_vote_outcome, vote, emp) %>%
    summarise(W = mean(prop_variance), # Within variance (mean)
              mean_prop = mean(prop_estimate),
              B = var(prop_estimate)) %>% # Between variance
    mutate(m = 5,
           T = W + (1 + 1/m) * B,
           T_stderr= sqrt(T)) %>% # total variance (Rubin's rules) 
    rename(variable = emp) %>%
    arrange(desc(mean_prop))

# Income

## Calculate proportions and its variance for each iteration
sample_proportions_match_party_inc_r <- mc_GLES2017_robustness %>%
    group_by(sample_no, match_vote_outcome, vote, hhincome) %>%
    summarise(n = n(), .groups = "keep") %>%
    ungroup(match_vote_outcome) %>%
    mutate(prop_estimate = n / sum(n)) %>%
    mutate(prop_variance = prop_estimate * (1 - prop_estimate) / sum(n))

## Calculate the between-iteration variance and total variance
mean_proportions_match_party_inc_r <- sample_proportions_match_party_inc_r %>%
    group_by(match_vote_outcome, vote, hhincome) %>%
    summarise(W = mean(prop_variance), # Within variance (mean)
              mean_prop = mean(prop_estimate),
              B = var(prop_estimate)) %>% # Between variance
    mutate(m = 5,
           T = W + (1 + 1/m) * B,
           T_stderr= sqrt(T)) %>% # total variance (Rubin's rules)
    rename(variable = hhincome) %>%
    arrange(desc(mean_prop))

# East/West

## Calculate proportions and its variance for each iteration
sample_proportions_match_party_east_r <- mc_GLES2017_robustness %>%
    group_by(sample_no, match_vote_outcome, vote, east) %>%
    summarise(n = n(), .groups = "keep") %>%
    ungroup(match_vote_outcome) %>%
    mutate(prop_estimate = n / sum(n)) %>%
    mutate(prop_variance = prop_estimate * (1 - prop_estimate) / sum(n))

## Calculate the between-iteration variance and total variance
mean_proportions_match_party_east_r <- sample_proportions_match_party_east_r %>%
    group_by(match_vote_outcome, vote, east) %>%
    summarise(W = mean(prop_variance), # Within variance (mean)
              mean_prop = mean(prop_estimate),
              B = var(prop_estimate)) %>% # Between variance
    mutate(m = 5,
           T = W + (1 + 1/m) * B,
           T_stderr= sqrt(T)) %>% # total variance (Rubin's rules)
    rename(variable = east) %>%
    arrange(desc(mean_prop))

# Religiosity

## Calculate proportions and its variance for each iteration
sample_proportions_match_party_relig_r <- mc_GLES2017_robustness %>%
    group_by(sample_no, match_vote_outcome, vote, religious) %>%
    summarise(n = n(), .groups = "keep") %>%
    ungroup(match_vote_outcome) %>%
    mutate(prop_estimate = n / sum(n)) %>%
    mutate(prop_variance = prop_estimate * (1 - prop_estimate) / sum(n))

## Calculate the between-iteration variance and total variance
mean_proportions_match_party_relig_r <- sample_proportions_match_party_relig_r %>%
    group_by(match_vote_outcome, vote, religious) %>%
    summarise(W = mean(prop_variance), # Within variance (mean)
              mean_prop = mean(prop_estimate),
              B = var(prop_estimate)) %>% # Between variance
    mutate(m = 5,
           T = W + (1 + 1/m) * B,
           T_stderr= sqrt(T)) %>% # total variance (Rubin's rules)
    rename(variable = religious) %>%
    arrange(desc(mean_prop))

# LR-Ideology

## Calculate proportions and its variance for each iteration
sample_proportions_match_party_leftright_r <- mc_GLES2017_robustness %>%
    group_by(sample_no, match_vote_outcome, vote, leftright) %>%
    summarise(n = n(), .groups = "keep") %>%
    ungroup(match_vote_outcome) %>%
    mutate(prop_estimate = n / sum(n)) %>%
    mutate(prop_variance = prop_estimate * (1 - prop_estimate) / sum(n))

## Calculate the between-iteration variance and total variance
mean_proportions_match_party_leftright_r <- sample_proportions_match_party_leftright_r %>%
    group_by(match_vote_outcome, vote, leftright) %>%
    summarise(W = mean(prop_variance), # Within variance (mean)
              mean_prop = mean(prop_estimate),
              B = var(prop_estimate)) %>% # Between variance
    mutate(m = 5,
           T = W + (1 + 1/m) * B,
           T_stderr= sqrt(T)) %>% # total variance (Rubin's rules)
    rename(variable = leftright) %>%
    arrange(desc(mean_prop))

# Party ID

## Calculate proportions and its variance for each iteration
sample_proportions_match_party_partyid_r <- mc_GLES2017_robustness %>%
    group_by(sample_no, match_vote_outcome, vote, partyid) %>%
    summarise(n = n(), .groups = "keep") %>%
    ungroup(match_vote_outcome) %>%
    mutate(prop_estimate = n / sum(n)) %>%
    mutate(prop_variance = prop_estimate * (1 - prop_estimate) / sum(n))

## Calculate the between-iteration variance and total variance
mean_proportions_match_party_partyid_r <- sample_proportions_match_party_partyid_r %>%
    group_by(match_vote_outcome, vote, partyid) %>%
    summarise(W = mean(prop_variance), # Within variance (mean)
              mean_prop = mean(prop_estimate),
              B = var(prop_estimate)) %>% # Between variance
    mutate(m = 5,
           T = W + (1 + 1/m) * B,
           T_stderr= sqrt(T)) %>% # total variance (Rubin's rules)
    rename(variable = partyid) %>%
    arrange(desc(mean_prop))

# Strength of Party ID

## Calculate proportions and its variance for each iteration
sample_proportions_match_party_piddegree_r <- mc_GLES2017_robustness %>%
    group_by(sample_no, match_vote_outcome, vote, partyid_degree) %>%
    summarise(n = n(), .groups = "keep") %>%
    ungroup(match_vote_outcome) %>%
    mutate(prop_estimate = n / sum(n)) %>%
    mutate(prop_variance = prop_estimate * (1 - prop_estimate) / sum(n))

## Calculate the between-iteration variance and total variance
mean_proportions_match_party_piddegree_r <- sample_proportions_match_party_piddegree_r %>%
    group_by(match_vote_outcome, vote, partyid_degree) %>%
    summarise(W = mean(prop_variance), # Within variance (mean)
              mean_prop = mean(prop_estimate),
              B = var(prop_estimate)) %>% # Between variance
    mutate(m = 5,
           T = W + (1 + 1/m) * B,
           T_stderr= sqrt(T)) %>% # total variance (Rubin's rules)
    rename(variable = partyid_degree) %>%
    filter(variable != "") %>%
    arrange(desc(mean_prop))

# Att. Inequality

## Calculate proportions and its variance for each iteration
sample_proportions_match_party_ineq_r <- mc_GLES2017_robustness %>%
    group_by(sample_no, match_vote_outcome, vote, inequality) %>%
    summarise(n = n(), .groups = "keep") %>%
    ungroup(match_vote_outcome) %>%
    mutate(prop_estimate = n / sum(n)) %>%
    mutate(prop_variance = prop_estimate * (1 - prop_estimate) / sum(n))

## Calculate the between-iteration variance and total variance
mean_proportions_match_party_ineq_r <- sample_proportions_match_party_ineq_r %>%
    group_by(match_vote_outcome, vote, inequality) %>%
    summarise(W = mean(prop_variance), # Within variance (mean)
              mean_prop = mean(prop_estimate),
              B = var(prop_estimate)) %>% # Between variance
    mutate(m = 5,
           T = W + (1 + 1/m) * B,
           T_stderr= sqrt(T)) %>% # total variance (Rubin's rules) 
    rename(variable = inequality) %>%
    arrange(desc(mean_prop))

# Att. Immigration

## Calculate proportions and its variance for each iteration
sample_proportions_match_party_immig_r <- mc_GLES2017_robustness %>%
    group_by(sample_no, match_vote_outcome, vote, immigration) %>%
    summarise(n = n(), .groups = "keep") %>%
    ungroup(match_vote_outcome) %>%
    mutate(prop_estimate = n / sum(n)) %>%
    mutate(prop_variance = prop_estimate * (1 - prop_estimate) / sum(n))

## Calculate the between-iteration variance and total variance
mean_proportions_match_party_immig_r <- sample_proportions_match_party_immig_r %>%
    group_by(match_vote_outcome, vote, immigration) %>%
    summarise(W = mean(prop_variance), # Within variance (mean)
              mean_prop = mean(prop_estimate),
              B = var(prop_estimate)) %>% # Between variance
    mutate(m = 5,
           T = W + (1 + 1/m) * B,
           T_stderr= sqrt(T)) %>% # total variance (Rubin's rules)
    rename(variable = immigration) %>%
    arrange(desc(mean_prop))

# Age: Too many catgeories --> Aggregate to 3 groups

## Calculate proportions and its variance for each iteration
sample_proportions_match_party_age_r <- mc_GLES2017_robustness %>%
    mutate(age_grp = ifelse(age < 35, "18-34",
                            ifelse(age >=35 & age < 65, "35-64",
                                   ifelse(age >= 65, "65+", age)))) %>%
    group_by(sample_no, match_vote_outcome, vote, age_grp) %>%
    summarise(n = n(), .groups = "keep") %>%
    ungroup(match_vote_outcome) %>%
    mutate(prop_estimate = n / sum(n)) %>%
    mutate(prop_variance = prop_estimate * (1 - prop_estimate) / sum(n))

## Calculate the between-iteration variance and total variance
mean_proportions_match_party_age_r <- sample_proportions_match_party_age_r %>%
    group_by(match_vote_outcome, vote, age_grp) %>%
    summarise(W = mean(prop_variance), # Within variance (mean)
              mean_prop = mean(prop_estimate),
              B = var(prop_estimate)) %>% # Between variance
    mutate(m = 5,
           T = W + (1 + 1/m) * B,
           T_stderr= sqrt(T)) %>% # total variance (Rubin's rules)
    rename(variable = age_grp) %>%
    arrange(desc(mean_prop))


mean_proportions_match_party_all_r <- bind_rows(mean_proportions_match_party_gender_r, mean_proportions_match_party_edu_r, mean_proportions_match_party_emp_r, mean_proportions_match_party_inc_r, mean_proportions_match_party_east_r, mean_proportions_match_party_relig_r, mean_proportions_match_party_leftright_r, mean_proportions_match_party_partyid_r, mean_proportions_match_party_piddegree_r, mean_proportions_match_party_ineq_r, mean_proportions_match_party_immig_r, mean_proportions_match_party_age_r)

#Plot

data_heatmap_match_r <- mean_proportions_match_party_all_r %>%
                      select(match_vote_outcome, vote, variable, mean_prop) %>%
                      filter(match_vote_outcome == TRUE) %>%
                      mutate(vote = ifelse(vote == "Bündnis 90/Die Grünen", "Greens",
                                        ifelse(vote == "Die Linke", "Left",
                                        ifelse(vote == "Andere Partei", "Small party",
                                        ifelse(vote == "Ungültig gewählt", "Invalid vote",
                                        ifelse(vote == "Nicht gewählt", "No vote", vote)))))) %>%
                      rename(category = variable) %>%
                      mutate(variable = ifelse(category == "18-34" | category == "35-64"| category == "65+", "Age",
                                        ifelse(category == "weiblich" | category == "männlich", "Gender",
                                        ifelse(category == "keinen Schulabschluss" | category == "einen Hauptschulabschluss" | category == "einen Realschulabschluss"| category == "Abitur" | category == "einen Hochschulabschluss", "Education",
                                        ifelse(category == "nicht berufstätig" | category == "in Ausbildung" | category == "berufstätig", "Employment",
                                        ifelse(category == "niedriges" | category == "mittleres" | category == "hohes", "Income",
                                        ifelse(category == "Ostdeutschland" | category == "Westdeutschland", "Residence",
                                        ifelse(category == "überhaupt nicht religiös" | category == "nicht sehr religiös" | category == "etwas religiös" | category == "sehr religiös", "Religiosity",
                                        ifelse(category == "stark links" | category == "mittig links"| category == "in der Mitte"| category == "mittig rechts" | category == "stark rechts", "Ideology",
                                        ifelse(category == "mit der Partei CDU/CSU" | category == "mit der Partei SPD"| category == "mit der Partei FDP" | category == "mit der Partei Bündnis 90/Die Grünen" | category == "mit der Partei Die Linke" | category == "mit der Partei AfD" | category == "mit einer Kleinpartei"| category == "mit keiner Partei", "Party ID",
                                        ifelse(category == "sehr stark " | category == "ziemlich stark " | category == "mäßig " | category == "ziemlich schwach " | category == "sehr schwach ", "Strength of Party ID",
                                        ifelse(category == "Maßnahmen ergreifen" | category == "habe keine Meinung dazu, ob die Regierung Maßnahmen ergreifen sollte" | category == "keine Maßnahmen ergreifen", "Att. Inequality",
                                               
                                        ifelse(category == "erleichtern" | category == "weder erleichtern noch einschränken" | category == "einschränken", "Att. Immigration", category))))))))))))) %>%
                      mutate(category = ifelse(category == "weiblich", "female",
                                        ifelse(category == "männlich", "male",
                                        ifelse(category == "keinen Schulabschluss", "no degree",
                                        ifelse(category == "einen Hauptschulabschluss", "Hauptschule",
                                        ifelse(category == "einen Realschulabschluss", "Realschule",
                                        ifelse(category == "Abitur", "Abitur",
                                        ifelse(category == "einen Hochschulabschluss", "College",
                                        ifelse(category == "nicht berufstätig", "not working",
                                        ifelse(category == "in Ausbildung", "studying",
                                        ifelse(category == "berufstätig", "working",
                                        ifelse(category == "niedriges", "low",
                                        ifelse(category == "mittleres", "medium",
                                        ifelse(category == "hohes", "high",
                                        ifelse(category == "Ostdeutschland", "East Germany",
                                        ifelse(category == "Westdeutschland", "West Germany",
                                        ifelse(category == "überhaupt nicht religiös", "not at all",
                                        ifelse(category == "nicht sehr religiös", "not very",
                                        ifelse(category == "etwas religiös", "somewhat",
                                        ifelse(category == "sehr religiös", "very",
                                        ifelse(category == "stark links", "left",
                                        ifelse(category == "mittig links", "center-left",
                                        ifelse(category == "in der Mitte", "center",
                                        ifelse(category == "mittig rechts", "center-right",
                                        ifelse(category == "stark rechts", "right",
                                        ifelse(category == "mit der Partei CDU/CSU", "CDU/CSU",
                                        ifelse(category == "mit der Partei SPD", "SPD",
                                        ifelse(category == "mit der Partei FDP", "FDP",
                                        ifelse(category == "mit der Partei Bündnis 90/Die Grünen", "Greens",
                                        ifelse(category == "mit der Partei Die Linke", "Left",
                                        ifelse(category == "mit der Partei AfD", "AfD",
                                        ifelse(category == "mit einer Kleinpartei", "Small party",
                                        ifelse(category == "mit keiner Partei", "none",
                                        ifelse(category == "sehr stark ", "very strong",
                                        ifelse(category == "ziemlich stark ", "rather strong",
                                        ifelse(category == "mäßig ", "medium",
                                        ifelse(category == "ziemlich schwach ", "rather weak",
                                        ifelse(category == "sehr schwach ", "very weak",
                                        ifelse(category == "Maßnahmen ergreifen", "take measures",
                                        ifelse(category == "habe keine Meinung dazu, ob die Regierung Maßnahmen ergreifen sollte", "no opinion",
                                        ifelse(category == "keine Maßnahmen ergreifen", "don't take measures",
                                               
                                        ifelse(category == "erleichtern", "facilitate",
                                        ifelse(category == "weder erleichtern noch einschränken", "neither nor",
                                        ifelse(category == "einschränken", "limit", category))))))))))))))))))))))))))))))))))))))))))))

data_heatmap_match_r <- data_heatmap_match_r %>%
  mutate(interaction_cat_var = interaction(category, variable, sep = "&")) %>%
  mutate(interaction_cat_var = factor(interaction_cat_var,
                                      levels = c("facilitate&Att. Immigration", "neither nor&Att. Immigration", "limit&Att. Immigration",
                                                 "take measures&Att. Inequality", "no opinion&Att. Inequality", "don't take measures&Att. Inequality",
                                                 "very strong&Strength of Party ID", "rather strong&Strength of Party ID", "medium&Strength of Party ID", "rather weak&Strength of Party ID", "very weak&Strength of Party ID",
                                                 "none&Party ID", "Small party&Party ID", "AfD&Party ID", "Left&Party ID", "FDP&Party ID", "Greens&Party ID", "SPD&Party ID", "CDU/CSU&Party ID",
                                                 "right&Ideology", "center-right&Ideology", "center&Ideology", "center-left&Ideology", "left&Ideology",
                                                 "very&Religiosity", "somewhat&Religiosity", "not very&Religiosity", "not at all&Religiosity",
                                                 "West Germany&Residence", "East Germany&Residence",
                                                 "high&Income", "medium&Income", "low&Income",
                                                 "working&Employment", "studying&Employment", "not working&Employment",
                                                 "College&Education", "Abitur&Education", "Realschule&Education", "Hauptschule&Education", "no degree&Education",
                                                 "male&Gender", "female&Gender",
                                                 "65+&Age", "35-64&Age", "18-34&Age")
  ))

plot_matches_subgroups_r <- ggplot(data_heatmap_match_r[!is.na(data_heatmap_match_r$variable),],
                          aes(x = vote,
                          y = interaction_cat_var,
                          fill = mean_prop)) +
  geom_tile() +
  xlab("Vote Choice (GLES)") +
  ylab("") +
  guides(y = guide_axis_nested(delim = "&")) + 
  scale_x_discrete(limits = c("CDU/CSU", "SPD", "Greens", "FDP", "Left","AfD", "Small party", "No vote")) +
  scale_fill_gradient(low="white", high="#03A63C",
                      limits = c(0, 1),
                      name = "% Match Vote Choice GPT - GLES",
                      labels = scales::label_percent()) +
  theme_minimal() +
  theme(legend.position = "top",
        panel.grid.minor = element_blank(),
        panel.grid.major = element_blank(),
        panel.background = element_rect(fill = "grey", color = NA)
        )

ggsave("heatmap_matches_subgroups_r.png", plot_matches_subgroups_r, height = 9, width = 8)

```

```{r}
plot_matches_subgroups_r
```


- Largely the same patterns - No difference

### Aggregate: Distribution of vote shares GLES vs. GPT

```{r}
## Variance Estimation

# Calculate proportions and its variance for each iteration
sample_proportions_r <- mc_GLES2017_robustness %>%
    group_by(sample_no, vote_gpt) %>%
    summarise(n = n(), .groups = "keep") %>%
    ungroup(vote_gpt) %>%
    mutate(prop_estimate = n / sum(n)) %>%
    mutate(prop_variance = prop_estimate * (1 - prop_estimate) / sum(n))

# Calculate the between-iteration variance and total variance
mean_proportions_r <- sample_proportions_r %>%
    group_by(vote_gpt) %>%
    summarise(W = mean(prop_variance), # Within variance (mean)
              mean_prop = mean(prop_estimate),
              B = var(prop_estimate)) %>% # Between variance
    mutate(m = 5,
           T = W + (1 + 1/m) * B,
           T_stderr= sqrt(T)) %>% # total variance (Rubin's rules) 
    arrange(desc(mean_prop))

## Plot

#GLES

## Filter the dataset for a specific sample_no
data_vote_1_r <- subset(mc_GLES2017_robustness, sample_no == 1)

## Calculate the relative frequencies of each category
table_vote_freq_1_r <- prop.table(table(data_vote_1_r$vote))

## Sort the categories based on their frequencies
data_vote_freq_1_r_sorted <- as.data.frame(table_vote_freq_1_r[order(table_vote_freq_1_r, decreasing = TRUE)])

data_vote_freq_1_r_sorted <- data_vote_freq_1_r_sorted %>%
                           rename(party = Var1) %>%
                           mutate(source = "GLES") %>%
                           mutate(source = as.factor(source)) %>%
                           mutate(T_stderr = NA) %>%
                           rename(freq = Freq)

# Adjust GPT
mean_proportions_r_df <- mean_proportions_r %>%
                       select(vote_gpt, mean_prop, T_stderr) %>%
                       rename(party = vote_gpt) %>%
                       rename(freq = mean_prop) %>%
                       replace_na(list(party = "no prediction")) %>%
                       mutate(source = "GPT") %>%
                       #mutate(party = as.factor(party)) %>%
                       mutate(source = factor(source, levels = c("GLES", "GPT")))

# Adjust GLES
data_vote_freq_r <- data_vote_freq_1_r_sorted %>%
                  mutate(T_stderr = sqrt(freq * (1-freq)/1905)) %>% # SE if GLES eligible voters could be treated unweighted
                  add_row(party = "no prediction", freq = 0, source = "GLES",
                          T_stderr = NA
                          ) %>%
                  mutate(source = factor(source, levels = c("GLES", "GPT")))

# Merge GLES & GPT, remove small percentage of "no prediction"
data_vote_parties_r <- bind_rows(mean_proportions_r_df, data_vote_freq_r)
data_vote_parties_r <- data_vote_parties_r %>%
                      mutate(party = ifelse(party == "Bündnis 90/Die Grünen", "Greens",
                                        ifelse(party == "Die Linke", "Left",
                                        ifelse(party== "Andere Partei", "Small party",
                                        ifelse(party == "Ungültig gewählt", "Invalid vote",
                                        ifelse(party == "Nicht gewählt", "No vote", party))))))  %>%
                      mutate(party = as.factor(party))
data_vote_parties_r <- data_vote_parties_r[data_vote_parties_r$party!="no prediction" , ]

plot_shares_aggregate_r <- ggplot(data_vote_parties_r, aes(x = party,
                                                           y = freq,
                                                           fill = source)) +
                      geom_bar(stat = "identity", position = "dodge") +
                      geom_text(aes(label = round(freq*100,1),
                                    y = freq + (1.96*T_stderr) + 0.005), 
                                position = position_dodge(0.9),
                                vjust = 0,
                                color = "#012340") +
                      xlab("") +
                      ylab("") +
                      scale_x_discrete(limits = c("CDU/CSU", "SPD", "Greens", "FDP", "Left",
                                                  "AfD", "Small party", "Invalid vote",
                                                  "No vote")) + # reorder categories
                      scale_y_continuous(labels = scales::percent) +
                      scale_fill_manual(limits = c("GLES", "GPT"),
                                        values = c("GLES" = "#027333", "GPT" = "#FAA32B"),
                                        labels = c("GLES",
                                                   "GPT-3"),
                                        name = "Reported vote choice \naccording to") +
                      geom_errorbar(aes(x=party,
                                        ymin=freq-(1.96*T_stderr),
                                        ymax=freq+(1.96*T_stderr)),
                                    #data = subset(data_vote_parties, source == "GPT"), # toggle on / off for GLES CIs; Problem: then CIs centered across sources!
                                    width=0.4,
                                    #colour="#0c1aad",
                                    colour = "#012340",
                                    position = position_dodge(width = 0.9)) +
                      ggtitle("") +
                      theme_minimal() +
                      theme(legend.position = "top",
                            legend.title.align = 1,
                            axis.text.x = element_text(colour = "black"),
                            axis.text.y = element_text(colour = "black"),
                            panel.grid.minor = element_blank(),
                            panel.grid.major = element_blank())


ggsave("shares_aggregate_r.png", plot_shares_aggregate_r, height = 4, width = 8)
```

```{r}
plot_shares_aggregate_r
```

- Differences in the decimals, except about 2 percentage points fewer non-voters!

### Impact of absence of predictor variables

Cannot conduct regression analyses because missings on IVs (non-imputed data!).

#### Comparing whether imputation made a difference on matching

##### Imputed sample

```{r}
# Sample 1
model_match_1_t <- glm(match_vote_outcome ~ imputed,
                   data=data_final_numeric_noNA[data_final_numeric_noNA$sample_no == 1, ],
                   family=binomial(link=logit))

## Get coeffs & stderrs
#summary(model_match_1_t)
#coef(model_match_1_t)

## Get n: 1827
#length(model_match_1_t$residuals)

# Sample 2
model_match_2_t <- glm(match_vote_outcome ~ imputed,
                   data=data_final_numeric_noNA[data_final_numeric_noNA$sample_no == 2, ],
                   family=binomial(link=logit))

## Get coeffs & stderrs
#summary(model_match_2_t)
#coef(model_match_2_t)

## Get n: 1827
#length(model_match_2_t$residuals)

# Sample 3
model_match_3_t <- glm(match_vote_outcome ~ imputed,
                   data=data_final_numeric_noNA[data_final_numeric_noNA$sample_no == 3, ],
                   family=binomial(link=logit))

## Get coeffs & stderrs
#summary(model_match_3_t)
#coef(model_match_3_t)

## Get n: 1827
#length(model_match_3_t$residuals)

# Sample 4
model_match_4_t <- glm(match_vote_outcome ~ imputed,
                   data=data_final_numeric_noNA[data_final_numeric_noNA$sample_no == 4, ],
                   family=binomial(link=logit))

## Get coeffs & stderrs
#summary(model_match_4_t)
#coef(model_match_4_t)

## Get n: 1827
#length(model_match_4_t$residuals)

# Sample 5
model_match_5_t <- glm(match_vote_outcome ~ imputed,
                   data=data_final_numeric_noNA[data_final_numeric_noNA$sample_no == 5, ],
                   family=binomial(link=logit))

## Get coeffs & stderrs
#summary(model_match_5_t)
#coef(model_match_5_t)

## Get n: 1827
#length(model_match_5_t$residuals)

# Store as 1 df per sample

## Sample 1
data_model_match_1_t <- summary(model_match_1_t)$coefficients %>%
                           as.data.frame() %>%
                           rownames_to_column("variable") %>%
                           mutate(variable = (ifelse(variable == "(Intercept)",
                                                     "intercept",
                                                     variable))) %>%
                           rename(coeff = Estimate) %>%
                           rename(stderr = "Std. Error") %>%
                           rename(z_value = "z value") %>%
                           rename(p_value = "Pr(>|z|)") %>%
                           mutate(sample = 1)

data_model_match_2_t <- summary(model_match_2_t)$coefficients %>%
                           as.data.frame() %>%
                           rownames_to_column("variable") %>%
                           mutate(variable = (ifelse(variable == "(Intercept)",
                                                     "intercept",
                                                     variable))) %>%
                           rename(coeff = Estimate) %>%
                           rename(stderr = "Std. Error") %>%
                           rename(z_value = "z value") %>%
                           rename(p_value = "Pr(>|z|)") %>%
                           mutate(sample = 2)


data_model_match_3_t <- summary(model_match_3_t)$coefficients %>%
                           as.data.frame() %>%
                           rownames_to_column("variable") %>%
                           mutate(variable = (ifelse(variable == "(Intercept)",
                                                     "intercept",
                                                     variable))) %>%
                           rename(coeff = Estimate) %>%
                           rename(stderr = "Std. Error") %>%
                           rename(z_value = "z value") %>%
                           rename(p_value = "Pr(>|z|)") %>%
                           mutate(sample = 3)

data_model_match_4_t <- summary(model_match_4_t)$coefficients %>%
                           as.data.frame() %>%
                           rownames_to_column("variable") %>%
                           mutate(variable = (ifelse(variable == "(Intercept)",
                                                     "intercept",
                                                     variable))) %>%
                           rename(coeff = Estimate) %>%
                           rename(stderr = "Std. Error") %>%
                           rename(z_value = "z value") %>%
                           rename(p_value = "Pr(>|z|)") %>%
                           mutate(sample = 4)

data_model_match_5_t <- summary(model_match_5_t)$coefficients %>%
                           as.data.frame() %>%
                           rownames_to_column("variable") %>%
                           mutate(variable = (ifelse(variable == "(Intercept)",
                                                     "intercept",
                                                     variable))) %>%
                           rename(coeff = Estimate) %>%
                           rename(stderr = "Std. Error") %>%
                           rename(z_value = "z value") %>%
                           rename(p_value = "Pr(>|z|)") %>%
                           mutate(sample = 5)

# Merge in one df across samples
data_model_match_all_t <- bind_rows(data_model_match_1_t, data_model_match_2_t, data_model_match_3_t, data_model_match_4_t, data_model_match_5_t)
data_model_match_all_t <- data_model_match_all_t %>% rename(sample_no = sample) # for consistency

data_model_match_mean_t <- data_model_match_all_t %>%
    group_by(variable) %>%
    summarise(W_coeff = mean(stderr^2), # Within variance OF COEFFICIENT (mean)
              mean_coeff = mean(coeff), # Mean estimate (coefficient)
              B_coeff = var(coeff), # Between variance (coefficient)
              mean_stderr = mean(stderr), # Mean estimate (stderr)
              B_stderr = var(stderr), # Between variance (stderr)
              mean_p = mean(p_value), # Mean estimate (p-value)
              B_p = var(p_value)) %>% # Between variance (p-value)
    mutate(m = 5,
           T = W_coeff + (1 + 1/m) * B_coeff, # total variance (Rubin's rules) OF COEFFICIENT
           T_stderr= sqrt(T)) # standard error OF COEFFICIENT --> to be used for CIs

export_match_t <- data_model_match_mean_t %>%
                   select(variable, mean_coeff, mean_p, T_stderr) %>%
                   mutate(mean_coeff = round(mean_coeff, digits = 3)) %>%
                   mutate(mean_p = round(mean_p, digits = 3)) %>%
                   mutate(T_stderr = round(T_stderr, digits = 3))

data_plot_match_t <- export_match_t %>%
                          filter(!(is.na(T_stderr))) %>%
                          mutate(lower = mean_coeff - 1.96*T_stderr,
                                 upper = mean_coeff + 1.96*T_stderr,
                                 oddsratio = exp(mean_coeff)) %>%
                          mutate(lower_or = exp(lower),
                                 upper_or = exp(upper)) %>%
                          mutate(sig = ifelse(lower_or > 1 | upper_or < 1, "Significant",
                                              "Not significant")) %>%
                          mutate(variable = ifelse(variable == "intercept", "Intercept",
                                                  ifelse(variable == "imputed", "Imputed", 
                                                         variable)))


plot_model_match_t <- ggplot(data_plot_match_t, 
       aes(y = variable,
           x = mean_coeff,
           xmin = lower,
           xmax = upper,
           color = sig)) + # legend colored by significance
  geom_vline(xintercept = 0,
             linetype = "solid",
             linewidth = 0.2) +
  geom_point(aes(color = sig), # point estimate
             size = 2) +
  geom_pointrange(linewidth = 0.5) + # error bars
  scale_color_manual(limits = c("Significant", "Not significant"),
                     values = c("Significant" = "#03A63C",
                                 "Not significant" = "#012340"),
                     labels = c("p < 0.05", "p > 0.05")) +
  scale_y_discrete(limits = c("Intercept", "Imputed")) +
  theme_minimal() +
  labs(
    x = "ß (additive effect on log-odds)",
    y = "",
    title = "Impact of Imputed Prompt Variables on Matching Vote Choice Between GLES and GPT") +
  theme(
        legend.position = "top",
        legend.title = element_blank(),
        plot.title.position = "plot")

ggsave("model_match_t.png", plot_model_match_t, height = 6, width = 8)

plot_model_match_t
```

- Imputation does not have an impact on match overall

##### Non-Imputed sample

```{r}
# Sample 1
model_match_1_r <- glm(match_vote_outcome ~ imputed,
                   data=data_robustness_numeric_noNA[data_robustness_numeric_noNA$sample_no == 1, ],
                   family=binomial(link=logit))

## Get coeffs & stderrs
#summary(model_match_1_r)
#coef(model_match_1_r)

## Get n: 1755
#length(model_match_1_r$residuals)

# Sample 2
model_match_2_r <- glm(match_vote_outcome ~ imputed,
                   data=data_robustness_numeric_noNA[data_robustness_numeric_noNA$sample_no == 2, ],
                   family=binomial(link=logit))

## Get coeffs & stderrs
#summary(model_match_2_r)
#coef(model_match_2_r)

## Get n: 1755
#length(model_match_2_r$residuals)

# Sample 1
model_match_3_r <- glm(match_vote_outcome ~ imputed,
                   data=data_robustness_numeric_noNA[data_robustness_numeric_noNA$sample_no == 3, ],
                   family=binomial(link=logit))

## Get coeffs & stderrs
#summary(model_match_3_r)
#coef(model_match_3_r)

## Get n: 1755
#length(model_match_3_r$residuals)

# Sample 4
model_match_4_r <- glm(match_vote_outcome ~ imputed,
                   data=data_robustness_numeric_noNA[data_robustness_numeric_noNA$sample_no == 4, ],
                   family=binomial(link=logit))

## Get coeffs & stderrs
#summary(model_match_4_r)
#coef(model_match_4_r)

## Get n: 1755
#length(model_match_4_r$residuals)

# Sample 5
model_match_5_r <- glm(match_vote_outcome ~ imputed,
                   data=data_robustness_numeric_noNA[data_robustness_numeric_noNA$sample_no == 5, ],
                   family=binomial(link=logit))

## Get coeffs & stderrs
#summary(model_match_5_r)
#coef(model_match_5_r)

## Get n: 1755
#length(model_match_5_r$residuals)

# Store as 1 df per sample

## Sample 1
data_model_match_1_r <- summary(model_match_1_r)$coefficients %>%
                           as.data.frame() %>%
                           rownames_to_column("variable") %>%
                           mutate(variable = (ifelse(variable == "(Intercept)",
                                                     "intercept",
                                                     variable))) %>%
                           rename(coeff = Estimate) %>%
                           rename(stderr = "Std. Error") %>%
                           rename(z_value = "z value") %>%
                           rename(p_value = "Pr(>|z|)") %>%
                           mutate(sample = 1)

data_model_match_2_r <- summary(model_match_2_r)$coefficients %>%
                           as.data.frame() %>%
                           rownames_to_column("variable") %>%
                           mutate(variable = (ifelse(variable == "(Intercept)",
                                                     "intercept",
                                                     variable))) %>%
                           rename(coeff = Estimate) %>%
                           rename(stderr = "Std. Error") %>%
                           rename(z_value = "z value") %>%
                           rename(p_value = "Pr(>|z|)") %>%
                           mutate(sample = 2)


data_model_match_3_r <- summary(model_match_3_r)$coefficients %>%
                           as.data.frame() %>%
                           rownames_to_column("variable") %>%
                           mutate(variable = (ifelse(variable == "(Intercept)",
                                                     "intercept",
                                                     variable))) %>%
                           rename(coeff = Estimate) %>%
                           rename(stderr = "Std. Error") %>%
                           rename(z_value = "z value") %>%
                           rename(p_value = "Pr(>|z|)") %>%
                           mutate(sample = 3)

data_model_match_4_r <- summary(model_match_4_r)$coefficients %>%
                           as.data.frame() %>%
                           rownames_to_column("variable") %>%
                           mutate(variable = (ifelse(variable == "(Intercept)",
                                                     "intercept",
                                                     variable))) %>%
                           rename(coeff = Estimate) %>%
                           rename(stderr = "Std. Error") %>%
                           rename(z_value = "z value") %>%
                           rename(p_value = "Pr(>|z|)") %>%
                           mutate(sample = 4)

data_model_match_5_r <- summary(model_match_5_r)$coefficients %>%
                           as.data.frame() %>%
                           rownames_to_column("variable") %>%
                           mutate(variable = (ifelse(variable == "(Intercept)",
                                                     "intercept",
                                                     variable))) %>%
                           rename(coeff = Estimate) %>%
                           rename(stderr = "Std. Error") %>%
                           rename(z_value = "z value") %>%
                           rename(p_value = "Pr(>|z|)") %>%
                           mutate(sample = 5)

# Merge in one df across samples
data_model_match_all_r <- bind_rows(data_model_match_1_r, data_model_match_2_r, data_model_match_3_r, data_model_match_4_r, data_model_match_5_r)
data_model_match_all_r <- data_model_match_all_r %>% rename(sample_no = sample) # for consistency

data_model_match_mean_r <- data_model_match_all_r %>%
    group_by(variable) %>%
    summarise(W_coeff = mean(stderr^2), # Within variance OF COEFFICIENT (mean)
              mean_coeff = mean(coeff), # Mean estimate (coefficient)
              B_coeff = var(coeff), # Between variance (coefficient)
              mean_stderr = mean(stderr), # Mean estimate (stderr)
              B_stderr = var(stderr), # Between variance (stderr)
              mean_p = mean(p_value), # Mean estimate (p-value)
              B_p = var(p_value)) %>% # Between variance (p-value)
    mutate(m = 5,
           T = W_coeff + (1 + 1/m) * B_coeff, # total variance (Rubin's rules) OF COEFFICIENT
           T_stderr= sqrt(T)) # standard error OF COEFFICIENT --> to be used for CIs

export_match_r <- data_model_match_mean_r %>%
                   select(variable, mean_coeff, mean_p, T_stderr) %>%
                   mutate(mean_coeff = round(mean_coeff, digits = 3)) %>%
                   mutate(mean_p = round(mean_p, digits = 3)) %>%
                   mutate(T_stderr = round(T_stderr, digits = 3))

data_plot_match_r <- export_match_r %>%
                          filter(!(is.na(T_stderr))) %>%
                          mutate(lower = mean_coeff - 1.96*T_stderr,
                                 upper = mean_coeff + 1.96*T_stderr,
                                 oddsratio = exp(mean_coeff)) %>%
                          mutate(lower_or = exp(lower),
                                 upper_or = exp(upper)) %>%
                          mutate(sig = ifelse(lower_or > 1 | upper_or < 1, "Significant",
                                              "Not significant")) %>%
                          mutate(variable = ifelse(variable == "intercept", "Intercept",
                                                  ifelse(variable == "imputed", "Missing Prompt Variable", 
                                                         variable)))


plot_model_match_r <- ggplot(data_plot_match_r, 
       aes(y = variable,
           x = mean_coeff,
           xmin = lower,
           xmax = upper,
           color = sig)) + # legend colored by significance
  geom_vline(xintercept = 0,
             linetype = "solid",
             linewidth = 0.2) +
  geom_point(aes(color = sig), # point estimate
             size = 2) +
  geom_pointrange(linewidth = 0.5) + # error bars
  scale_color_manual(limits = c("Significant", "Not significant"),
                     values = c("Significant" = "#03A63C",
                                 "Not significant" = "#012340"),
                     labels = c("p < 0.05", "p > 0.05")) +
  theme_minimal() +
  labs(
    x = "ß (additive effect on log-odds)",
    y = "",
    title = "Impact of Absence of Prompt Variables on Matching Vote Choice Between GLES and GPT") +
  theme(
        legend.position = "top",
        legend.title = element_blank(),
        plot.title.position = "plot"
        )

ggsave("model_match_r.png", plot_model_match_r, height = 6, width = 8)

plot_model_match_r
```

- Missing values have no impact on match overall

#### Comparing whether imputation made a difference on vote choice prediction

##### Imputed sample

```{r}
# Sample 1
model_vote_gpt_1_t <- multinom(vote_gpt ~ imputed, data = data_final_numeric_noNA, subset = data_final_numeric_noNA$sample_no == 1)

## Get coeffs & stderrs
#summary(model_vote_gpt_1_t)
#coef(model_vote_gpt_1_t)

## Get n: 1827
#nrow(residuals(model_vote_gpt_1_t))

# Sample 2
model_vote_gpt_2_t <- multinom(vote_gpt ~ imputed, data = data_final_numeric_noNA, subset = data_final_numeric_noNA$sample_no == 2)

## Get coeffs & stderrs
#summary(model_vote_gpt_2_t)
#coef(model_vote_gpt_2_t)

## Get n: 1827
#nrow(residuals(model_vote_gpt_2_t))

# Sample 3
model_vote_gpt_3_t <- multinom(vote_gpt ~ imputed, data = data_final_numeric_noNA, subset = data_final_numeric_noNA$sample_no == 3)

## Get coeffs & stderrs
#summary(model_vote_gpt_3_t)
#coef(model_vote_gpt_3_t)

## Get n: 1827
#nrow(residuals(model_vote_gpt_3_t))

# Sample 4
model_vote_gpt_4_t <- multinom(vote_gpt ~ imputed, data = data_final_numeric_noNA, subset = data_final_numeric_noNA$sample_no == 4)

## Get coeffs & stderrs
#summary(model_vote_gpt_4_t)
#coef(model_vote_gpt_4_t)

## Get n: 1827
#nrow(residuals(model_vote_gpt_4_t))

# Sample 5
model_vote_gpt_5_t <- multinom(vote_gpt ~ imputed, data = data_final_numeric_noNA, subset = data_final_numeric_noNA$sample_no == 5)

## Get coeffs & stderrs
#summary(model_vote_gpt_5_t)
#coef(model_vote_gpt_5_t)

## Get n: 1827
#nrow(residuals(model_vote_gpt_5_t))

# Get coeffs, std.errors & test statistics, transform into long format & store as 1 df per sample

## Sample 1
coeff_model_vote_gpt_1_t <- summary(model_vote_gpt_1_t)$coefficients %>%
                           as.data.frame() %>%
                           rownames_to_column("party") %>%
                           rename(intercept = "(Intercept)") %>%
                           pivot_longer(cols = !party, names_to = "variable", values_to = "coeff")

stderr_model_vote_gpt_1_t <- summary(model_vote_gpt_1_t)$standard.errors %>%
                           as.data.frame() %>%
                           rownames_to_column("party") %>%
                           rename(intercept = "(Intercept)") %>%
                           pivot_longer(cols = !party, names_to = "variable", values_to = "stderr")

z_model_vote_gpt_1_t <- summary(model_vote_gpt_1_t)$coefficients/summary(model_vote_gpt_1_t)$standard.errors
# cannot transform before calculating p-values

# have to do separately because %>% doesn't work with calculation
p_model_vote_gpt_1_t <- (1 - pnorm(abs(z_model_vote_gpt_1_t), 0, 1)) * 2 # 2-tailed z-test 
p_model_vote_gpt_1_t <- p_model_vote_gpt_1_t %>%
                      as.data.frame() %>%
                      rownames_to_column("party") %>%
                      rename(intercept = "(Intercept)") %>%
                      pivot_longer(cols = !party, names_to = "variable", values_to = "p_value")


z_model_vote_gpt_1_t <- z_model_vote_gpt_1_t %>%
                      as.data.frame() %>%
                      rownames_to_column("party") %>%
                      rename(intercept = "(Intercept)") %>%
                      pivot_longer(cols = !party, names_to = "variable", values_to = "z_value")

data_model_vote_gpt_1_t <- coeff_model_vote_gpt_1_t %>%
                         left_join(stderr_model_vote_gpt_1_t, by = c("party", "variable")) %>%
                         left_join(p_model_vote_gpt_1_t, by = c("party", "variable")) %>%
                         left_join(z_model_vote_gpt_1_t, by = c("party", "variable")) %>%
                         mutate(sample = 1)


## Sample 2

coeff_model_vote_gpt_2_t <- summary(model_vote_gpt_2_t)$coefficients %>%
                           as.data.frame() %>%
                           rownames_to_column("party") %>%
                           rename(intercept = "(Intercept)") %>%
                           pivot_longer(cols = !party, names_to = "variable", values_to = "coeff")

stderr_model_vote_gpt_2_t <- summary(model_vote_gpt_2_t)$standard.errors %>%
                           as.data.frame() %>%
                           rownames_to_column("party") %>%
                           rename(intercept = "(Intercept)") %>%
                           pivot_longer(cols = !party, names_to = "variable", values_to = "stderr")

z_model_vote_gpt_2_t <- summary(model_vote_gpt_2_t)$coefficients/summary(model_vote_gpt_2_t)$standard.errors
# cannot transform before calculating p-values

# have to do separately because %>% doesn't work with calculation
p_model_vote_gpt_2_t <- (1 - pnorm(abs(z_model_vote_gpt_2_t), 0, 1)) * 2 # 2-tailed z-test 
p_model_vote_gpt_2_t <- p_model_vote_gpt_2_t %>%
                      as.data.frame() %>%
                      rownames_to_column("party") %>%
                      rename(intercept = "(Intercept)") %>%
                      pivot_longer(cols = !party, names_to = "variable", values_to = "p_value")


z_model_vote_gpt_2_t <- z_model_vote_gpt_2_t %>%
                      as.data.frame() %>%
                      rownames_to_column("party") %>%
                      rename(intercept = "(Intercept)") %>%
                      pivot_longer(cols = !party, names_to = "variable", values_to = "z_value")

data_model_vote_gpt_2_t <- coeff_model_vote_gpt_2_t %>%
                         left_join(stderr_model_vote_gpt_2_t, by = c("party", "variable")) %>%
                         left_join(p_model_vote_gpt_2_t, by = c("party", "variable")) %>%
                         left_join(z_model_vote_gpt_2_t, by = c("party", "variable")) %>%
                         mutate(sample = 2)

## Sample 3

coeff_model_vote_gpt_3_t <- summary(model_vote_gpt_3_t)$coefficients %>%
                           as.data.frame() %>%
                           rownames_to_column("party") %>%
                           rename(intercept = "(Intercept)") %>%
                           pivot_longer(cols = !party, names_to = "variable", values_to = "coeff")

stderr_model_vote_gpt_3_t <- summary(model_vote_gpt_3_t)$standard.errors %>%
                           as.data.frame() %>%
                           rownames_to_column("party") %>%
                           rename(intercept = "(Intercept)") %>%
                           pivot_longer(cols = !party, names_to = "variable", values_to = "stderr")

z_model_vote_gpt_3_t <- summary(model_vote_gpt_3_t)$coefficients/summary(model_vote_gpt_3_t)$standard.errors
# cannot transform before calculating p-values

# have to do separately because %>% doesn't work with calculation
p_model_vote_gpt_3_t <- (1 - pnorm(abs(z_model_vote_gpt_3_t), 0, 1)) * 2 # 2-tailed z-test 
p_model_vote_gpt_3_t <- p_model_vote_gpt_3_t %>%
                      as.data.frame() %>%
                      rownames_to_column("party") %>%
                      rename(intercept = "(Intercept)") %>%
                      pivot_longer(cols = !party, names_to = "variable", values_to = "p_value")


z_model_vote_gpt_3_t <- z_model_vote_gpt_3_t %>%
                      as.data.frame() %>%
                      rownames_to_column("party") %>%
                      rename(intercept = "(Intercept)") %>%
                      pivot_longer(cols = !party, names_to = "variable", values_to = "z_value")

data_model_vote_gpt_3_t <- coeff_model_vote_gpt_3_t %>%
                         left_join(stderr_model_vote_gpt_3_t, by = c("party", "variable")) %>%
                         left_join(p_model_vote_gpt_3_t, by = c("party", "variable")) %>%
                         left_join(z_model_vote_gpt_3_t, by = c("party", "variable")) %>%
                         mutate(sample = 3)

## Sample 4

coeff_model_vote_gpt_4_t <- summary(model_vote_gpt_4_t)$coefficients %>%
                           as.data.frame() %>%
                           rownames_to_column("party") %>%
                           rename(intercept = "(Intercept)") %>%
                           pivot_longer(cols = !party, names_to = "variable", values_to = "coeff")

stderr_model_vote_gpt_4_t <- summary(model_vote_gpt_4_t)$standard.errors %>%
                           as.data.frame() %>%
                           rownames_to_column("party") %>%
                           rename(intercept = "(Intercept)") %>%
                           pivot_longer(cols = !party, names_to = "variable", values_to = "stderr")

z_model_vote_gpt_4_t <- summary(model_vote_gpt_4_t)$coefficients/summary(model_vote_gpt_4_t)$standard.errors
# cannot transform before calculating p-values

# have to do separately because %>% doesn't work with calculation
p_model_vote_gpt_4_t <- (1 - pnorm(abs(z_model_vote_gpt_4_t), 0, 1)) * 2 # 2-tailed z-test 
p_model_vote_gpt_4_t <- p_model_vote_gpt_4_t %>%
                      as.data.frame() %>%
                      rownames_to_column("party") %>%
                      rename(intercept = "(Intercept)") %>%
                      pivot_longer(cols = !party, names_to = "variable", values_to = "p_value")


z_model_vote_gpt_4_t <- z_model_vote_gpt_4_t %>%
                      as.data.frame() %>%
                      rownames_to_column("party") %>%
                      rename(intercept = "(Intercept)") %>%
                      pivot_longer(cols = !party, names_to = "variable", values_to = "z_value")

data_model_vote_gpt_4_t <- coeff_model_vote_gpt_4_t %>%
                         left_join(stderr_model_vote_gpt_4_t, by = c("party", "variable")) %>%
                         left_join(p_model_vote_gpt_4_t, by = c("party", "variable")) %>%
                         left_join(z_model_vote_gpt_4_t, by = c("party", "variable")) %>%
                         mutate(sample = 4)

## Sample 5

coeff_model_vote_gpt_5_t <- summary(model_vote_gpt_5_t)$coefficients %>%
                           as.data.frame() %>%
                           rownames_to_column("party") %>%
                           rename(intercept = "(Intercept)") %>%
                           pivot_longer(cols = !party, names_to = "variable", values_to = "coeff")

stderr_model_vote_gpt_5_t <- summary(model_vote_gpt_5_t)$standard.errors %>%
                           as.data.frame() %>%
                           rownames_to_column("party") %>%
                           rename(intercept = "(Intercept)") %>%
                           pivot_longer(cols = !party, names_to = "variable", values_to = "stderr")

z_model_vote_gpt_5_t <- summary(model_vote_gpt_5_t)$coefficients/summary(model_vote_gpt_5_t)$standard.errors
# cannot transform before calculating p-values

# have to do separately because %>% doesn't work with calculation
p_model_vote_gpt_5_t <- (1 - pnorm(abs(z_model_vote_gpt_5_t), 0, 1)) * 2 # 2-tailed z-test 
p_model_vote_gpt_5_t <- p_model_vote_gpt_5_t %>%
                      as.data.frame() %>%
                      rownames_to_column("party") %>%
                      rename(intercept = "(Intercept)") %>%
                      pivot_longer(cols = !party, names_to = "variable", values_to = "p_value")


z_model_vote_gpt_5_t <- z_model_vote_gpt_5_t %>%
                      as.data.frame() %>%
                      rownames_to_column("party") %>%
                      rename(intercept = "(Intercept)") %>%
                      pivot_longer(cols = !party, names_to = "variable", values_to = "z_value")

data_model_vote_gpt_5_t <- coeff_model_vote_gpt_5_t %>%
                         left_join(stderr_model_vote_gpt_5_t, by = c("party", "variable")) %>%
                         left_join(p_model_vote_gpt_5_t, by = c("party", "variable")) %>%
                         left_join(z_model_vote_gpt_5_t, by = c("party", "variable")) %>%
                         mutate(sample = 5)

# Merge in one df across samples
data_model_vote_gpt_all_t <- bind_rows(data_model_vote_gpt_1_t, data_model_vote_gpt_2_t, data_model_vote_gpt_3_t, data_model_vote_gpt_4_t, data_model_vote_gpt_5_t)
data_model_vote_gpt_all_t <- data_model_vote_gpt_all_t %>% rename(sample_no = sample) # for consistency

data_model_vote_gpt_mean_t <- data_model_vote_gpt_all_t %>%
    group_by(party, variable) %>%
    summarise(W_coeff = mean(stderr^2), # Within variance OF COEFFICIENT (mean)
              mean_coeff = mean(coeff), # Mean estimate (coefficient)
              B_coeff = var(coeff), # Between variance (coefficient)
              mean_stderr = mean(stderr), # Mean estimate (stderr)
              B_stderr = var(stderr), # Between variance (stderr)
              mean_p = mean(p_value), # Mean estimate (p-value)
              B_p = var(p_value)) %>% # Between variance (p-value)
    mutate(m = 5,
           T = W_coeff + (1 + 1/m) * B_coeff, # total variance (Rubin's rules) OF COEFFICIENT
           T_stderr= sqrt(T)) # standard error OF COEFFICIENT --> to be used for CIs

data_plot_vote_gpt_t <- data_model_vote_gpt_mean_t %>%
                          select(party, variable, mean_coeff, mean_p, T_stderr) %>%
                          filter(!(is.na(T_stderr))) %>%
                          mutate(lower = mean_coeff - 1.96*T_stderr,
                                 upper = mean_coeff + 1.96*T_stderr,
                                 oddsratio = exp(mean_coeff)) %>%
                          mutate(lower_or = exp(lower),
                                 upper_or = exp(upper)) %>%
                          mutate(sig = ifelse(lower_or > 1 | upper_or < 1, "Significant",
                                              "Not significant")) %>%
                          mutate(party = ifelse(party == "Bündnis 90/Die Grünen", "Greens",
                                         ifelse(party == "Die Linke", "Left",
                                         ifelse(party == "Andere Partei", "Small party",
                                         ifelse(party == "Ungültig gewählt", "Invalid vote",
                                         ifelse(party == "Nicht gewählt", "No vote", party)))))) %>%
                          mutate(party = factor(party,
                                          levels = c("SPD", "Greens", "FDP", "Left","AfD", "Small party", "Invalid vote", "No vote"))) %>%
                          mutate(variable = ifelse(variable == "intercept", "Intercept",
                                                  ifelse(variable == "imputed", "Imputed",
                                                         variable)))

plot_vote_gpt_t <- ggplot(data_plot_vote_gpt_t, 
       aes(y = variable,
           x = mean_coeff,
           xmin = lower,
           xmax = upper,
           color = sig)) + # legend colored by significance
  geom_vline(xintercept = 0, # reference line at 1 for OR, 0 for pure coeffs
             linetype = "solid",
             linewidth = 0.2) +
  geom_point(aes(color = sig), # point estimate
             size = 2) +
  geom_pointrange(linewidth = 0.5) + # error bars
  scale_color_manual(limits = c("Significant", "Not significant"),
                     values = c("Significant" = "#03A63C", "Not significant" = "#012340"),
                     labels = c("p < 0.05", "p > 0.05")) +
  scale_y_discrete(limits=c("Intercept", "Imputed")) +
  facet_grid(.~party) +
  theme_minimal() +
  labs(
    x = "ß (additive effect on log-odds)",
    y = "",
    title = "Impact of Imputed Prompt Variables on GPT Prediction") +
  theme(
        legend.position = "top",
        legend.title = element_blank())

ggsave("model_vote_gpt_t.png", plot_vote_gpt_t, height = 6, width = 8)

plot_vote_gpt_t
```

- No significant difference between imputed and non-imputed cases

##### Non-Imputed sample

```{r}
# Sample 1
model_vote_gpt_1_r <- multinom(vote_gpt ~ imputed, data = data_robustness_numeric_noNA, subset = data_robustness_numeric_noNA$sample_no == 1)

## Get coeffs & stderrs
#summary(model_vote_gpt_1_r)
#coef(model_vote_gpt_1_r)

## Get n: 1755
#nrow(residuals(model_vote_gpt_1_r))

# Sample 2
model_vote_gpt_2_r <- multinom(vote_gpt ~ imputed, data = data_robustness_numeric_noNA, subset = data_robustness_numeric_noNA$sample_no == 2)

## Get coeffs & stderrs
#summary(model_vote_gpt_2_r)
#coef(model_vote_gpt_2_r)

## Get n: 1755
#nrow(residuals(model_vote_gpt_2_r))

# Sample 3
model_vote_gpt_3_r <- multinom(vote_gpt ~ imputed, data = data_robustness_numeric_noNA, subset = data_robustness_numeric_noNA$sample_no == 3)

## Get coeffs & stderrs
#summary(model_vote_gpt_3_r)
#coef(model_vote_gpt_3_r)

## Get n: 1755
#nrow(residuals(model_vote_gpt_3_r))

# Sample 4
model_vote_gpt_4_r <- multinom(vote_gpt ~ imputed, data = data_robustness_numeric_noNA, subset = data_robustness_numeric_noNA$sample_no == 4)

## Get coeffs & stderrs
#summary(model_vote_gpt_4_r)
#coef(model_vote_gpt_4_r)

## Get n: 1755
#nrow(residuals(model_vote_gpt_4_r))

# Sample 5
model_vote_gpt_5_r <- multinom(vote_gpt ~ imputed, data = data_robustness_numeric_noNA, subset = data_robustness_numeric_noNA$sample_no == 5)

## Get coeffs & stderrs
#summary(model_vote_gpt_5_r)
#coef(model_vote_gpt_5_r)

## Get n: 1755
#nrow(residuals(model_vote_gpt_5_r))

# Get coeffs, std.errors & test statistics, transform into long format & store as 1 df per sample

## Sample 1
coeff_model_vote_gpt_1_r <- summary(model_vote_gpt_1_r)$coefficients %>%
                           as.data.frame() %>%
                           rownames_to_column("party") %>%
                           rename(intercept = "(Intercept)") %>%
                           pivot_longer(cols = !party, names_to = "variable", values_to = "coeff")

stderr_model_vote_gpt_1_r <- summary(model_vote_gpt_1_r)$standard.errors %>%
                           as.data.frame() %>%
                           rownames_to_column("party") %>%
                           rename(intercept = "(Intercept)") %>%
                           pivot_longer(cols = !party, names_to = "variable", values_to = "stderr")

z_model_vote_gpt_1_r <- summary(model_vote_gpt_1_r)$coefficients/summary(model_vote_gpt_1_r)$standard.errors
# cannot transform before calculating p-values

# have to do separately because %>% doesn't work with calculation
p_model_vote_gpt_1_r <- (1 - pnorm(abs(z_model_vote_gpt_1_r), 0, 1)) * 2 # 2-tailed z-test 
p_model_vote_gpt_1_r <- p_model_vote_gpt_1_r %>%
                      as.data.frame() %>%
                      rownames_to_column("party") %>%
                      rename(intercept = "(Intercept)") %>%
                      pivot_longer(cols = !party, names_to = "variable", values_to = "p_value")


z_model_vote_gpt_1_r <- z_model_vote_gpt_1_r %>%
                      as.data.frame() %>%
                      rownames_to_column("party") %>%
                      rename(intercept = "(Intercept)") %>%
                      pivot_longer(cols = !party, names_to = "variable", values_to = "z_value")

data_model_vote_gpt_1_r <- coeff_model_vote_gpt_1_r %>%
                         left_join(stderr_model_vote_gpt_1_r, by = c("party", "variable")) %>%
                         left_join(p_model_vote_gpt_1_r, by = c("party", "variable")) %>%
                         left_join(z_model_vote_gpt_1_r, by = c("party", "variable")) %>%
                         mutate(sample = 1)


## Sample 2

coeff_model_vote_gpt_2_r <- summary(model_vote_gpt_2_r)$coefficients %>%
                           as.data.frame() %>%
                           rownames_to_column("party") %>%
                           rename(intercept = "(Intercept)") %>%
                           pivot_longer(cols = !party, names_to = "variable", values_to = "coeff")

stderr_model_vote_gpt_2_r <- summary(model_vote_gpt_2_r)$standard.errors %>%
                           as.data.frame() %>%
                           rownames_to_column("party") %>%
                           rename(intercept = "(Intercept)") %>%
                           pivot_longer(cols = !party, names_to = "variable", values_to = "stderr")

z_model_vote_gpt_2_r <- summary(model_vote_gpt_2_r)$coefficients/summary(model_vote_gpt_2_r)$standard.errors
# cannot transform before calculating p-values

# have to do separately because %>% doesn't work with calculation
p_model_vote_gpt_2_r <- (1 - pnorm(abs(z_model_vote_gpt_2_r), 0, 1)) * 2 # 2-tailed z-test 
p_model_vote_gpt_2_r <- p_model_vote_gpt_2_r %>%
                      as.data.frame() %>%
                      rownames_to_column("party") %>%
                      rename(intercept = "(Intercept)") %>%
                      pivot_longer(cols = !party, names_to = "variable", values_to = "p_value")


z_model_vote_gpt_2_r <- z_model_vote_gpt_2_r %>%
                      as.data.frame() %>%
                      rownames_to_column("party") %>%
                      rename(intercept = "(Intercept)") %>%
                      pivot_longer(cols = !party, names_to = "variable", values_to = "z_value")

data_model_vote_gpt_2_r <- coeff_model_vote_gpt_2_r %>%
                         left_join(stderr_model_vote_gpt_2_r, by = c("party", "variable")) %>%
                         left_join(p_model_vote_gpt_2_r, by = c("party", "variable")) %>%
                         left_join(z_model_vote_gpt_2_r, by = c("party", "variable")) %>%
                         mutate(sample = 2)

## Sample 3

coeff_model_vote_gpt_3_r <- summary(model_vote_gpt_3_r)$coefficients %>%
                           as.data.frame() %>%
                           rownames_to_column("party") %>%
                           rename(intercept = "(Intercept)") %>%
                           pivot_longer(cols = !party, names_to = "variable", values_to = "coeff")

stderr_model_vote_gpt_3_r <- summary(model_vote_gpt_3_r)$standard.errors %>%
                           as.data.frame() %>%
                           rownames_to_column("party") %>%
                           rename(intercept = "(Intercept)") %>%
                           pivot_longer(cols = !party, names_to = "variable", values_to = "stderr")

z_model_vote_gpt_3_r <- summary(model_vote_gpt_3_r)$coefficients/summary(model_vote_gpt_3_r)$standard.errors
# cannot transform before calculating p-values

# have to do separately because %>% doesn't work with calculation
p_model_vote_gpt_3_r <- (1 - pnorm(abs(z_model_vote_gpt_3_r), 0, 1)) * 2 # 2-tailed z-test 
p_model_vote_gpt_3_r <- p_model_vote_gpt_3_r %>%
                      as.data.frame() %>%
                      rownames_to_column("party") %>%
                      rename(intercept = "(Intercept)") %>%
                      pivot_longer(cols = !party, names_to = "variable", values_to = "p_value")


z_model_vote_gpt_3_r <- z_model_vote_gpt_3_r %>%
                      as.data.frame() %>%
                      rownames_to_column("party") %>%
                      rename(intercept = "(Intercept)") %>%
                      pivot_longer(cols = !party, names_to = "variable", values_to = "z_value")

data_model_vote_gpt_3_r <- coeff_model_vote_gpt_3_r %>%
                         left_join(stderr_model_vote_gpt_3_r, by = c("party", "variable")) %>%
                         left_join(p_model_vote_gpt_3_r, by = c("party", "variable")) %>%
                         left_join(z_model_vote_gpt_3_r, by = c("party", "variable")) %>%
                         mutate(sample = 3)

## Sample 4

coeff_model_vote_gpt_4_r <- summary(model_vote_gpt_4_r)$coefficients %>%
                           as.data.frame() %>%
                           rownames_to_column("party") %>%
                           rename(intercept = "(Intercept)") %>%
                           pivot_longer(cols = !party, names_to = "variable", values_to = "coeff")

stderr_model_vote_gpt_4_r <- summary(model_vote_gpt_4_r)$standard.errors %>%
                           as.data.frame() %>%
                           rownames_to_column("party") %>%
                           rename(intercept = "(Intercept)") %>%
                           pivot_longer(cols = !party, names_to = "variable", values_to = "stderr")

z_model_vote_gpt_4_r <- summary(model_vote_gpt_4_r)$coefficients/summary(model_vote_gpt_4_r)$standard.errors
# cannot transform before calculating p-values

# have to do separately because %>% doesn't work with calculation
p_model_vote_gpt_4_r <- (1 - pnorm(abs(z_model_vote_gpt_4_r), 0, 1)) * 2 # 2-tailed z-test 
p_model_vote_gpt_4_r <- p_model_vote_gpt_4_r %>%
                      as.data.frame() %>%
                      rownames_to_column("party") %>%
                      rename(intercept = "(Intercept)") %>%
                      pivot_longer(cols = !party, names_to = "variable", values_to = "p_value")


z_model_vote_gpt_4_r <- z_model_vote_gpt_4_r %>%
                      as.data.frame() %>%
                      rownames_to_column("party") %>%
                      rename(intercept = "(Intercept)") %>%
                      pivot_longer(cols = !party, names_to = "variable", values_to = "z_value")

data_model_vote_gpt_4_r <- coeff_model_vote_gpt_4_r %>%
                         left_join(stderr_model_vote_gpt_4_r, by = c("party", "variable")) %>%
                         left_join(p_model_vote_gpt_4_r, by = c("party", "variable")) %>%
                         left_join(z_model_vote_gpt_4_r, by = c("party", "variable")) %>%
                         mutate(sample = 4)

## Sample 5

coeff_model_vote_gpt_5_r <- summary(model_vote_gpt_5_r)$coefficients %>%
                           as.data.frame() %>%
                           rownames_to_column("party") %>%
                           rename(intercept = "(Intercept)") %>%
                           pivot_longer(cols = !party, names_to = "variable", values_to = "coeff")

stderr_model_vote_gpt_5_r <- summary(model_vote_gpt_5_r)$standard.errors %>%
                           as.data.frame() %>%
                           rownames_to_column("party") %>%
                           rename(intercept = "(Intercept)") %>%
                           pivot_longer(cols = !party, names_to = "variable", values_to = "stderr")

z_model_vote_gpt_5_r <- summary(model_vote_gpt_5_r)$coefficients/summary(model_vote_gpt_5_r)$standard.errors
# cannot transform before calculating p-values

# have to do separately because %>% doesn't work with calculation
p_model_vote_gpt_5_r <- (1 - pnorm(abs(z_model_vote_gpt_5_r), 0, 1)) * 2 # 2-tailed z-test 
p_model_vote_gpt_5_r <- p_model_vote_gpt_5_r %>%
                      as.data.frame() %>%
                      rownames_to_column("party") %>%
                      rename(intercept = "(Intercept)") %>%
                      pivot_longer(cols = !party, names_to = "variable", values_to = "p_value")


z_model_vote_gpt_5_r <- z_model_vote_gpt_5_r %>%
                      as.data.frame() %>%
                      rownames_to_column("party") %>%
                      rename(intercept = "(Intercept)") %>%
                      pivot_longer(cols = !party, names_to = "variable", values_to = "z_value")

data_model_vote_gpt_5_r <- coeff_model_vote_gpt_5_r %>%
                         left_join(stderr_model_vote_gpt_5_r, by = c("party", "variable")) %>%
                         left_join(p_model_vote_gpt_5_r, by = c("party", "variable")) %>%
                         left_join(z_model_vote_gpt_5_r, by = c("party", "variable")) %>%
                         mutate(sample = 5)

# Merge in one df across samples
data_model_vote_gpt_all_r <- bind_rows(data_model_vote_gpt_1_r, data_model_vote_gpt_2_r, data_model_vote_gpt_3_r, data_model_vote_gpt_4_r, data_model_vote_gpt_5_r)
data_model_vote_gpt_all_r <- data_model_vote_gpt_all_r %>% rename(sample_no = sample) # for consistency

data_model_vote_gpt_mean_r <- data_model_vote_gpt_all_r %>%
    group_by(party, variable) %>%
    summarise(W_coeff = mean(stderr^2), # Within variance OF COEFFICIENT (mean)
              mean_coeff = mean(coeff), # Mean estimate (coefficient)
              B_coeff = var(coeff), # Between variance (coefficient)
              mean_stderr = mean(stderr), # Mean estimate (stderr)
              B_stderr = var(stderr), # Between variance (stderr)
              mean_p = mean(p_value), # Mean estimate (p-value)
              B_p = var(p_value)) %>% # Between variance (p-value)
    mutate(m = 5,
           T = W_coeff + (1 + 1/m) * B_coeff, # total variance (Rubin's rules) OF COEFFICIENT
           T_stderr= sqrt(T)) # standard error OF COEFFICIENT --> to be used for CIs

data_plot_vote_gpt_r <- data_model_vote_gpt_mean_r %>%
                          select(party, variable, mean_coeff, mean_p, T_stderr) %>%
                          filter(!(is.na(T_stderr))) %>%
                          mutate(lower = mean_coeff - 1.96*T_stderr,
                                 upper = mean_coeff + 1.96*T_stderr,
                                 oddsratio = exp(mean_coeff)) %>%
                          mutate(lower_or = exp(lower),
                                 upper_or = exp(upper)) %>%
                          mutate(sig = ifelse(lower_or > 1 | upper_or < 1, "Significant",
                                              "Not significant")) %>%
                          mutate(party = ifelse(party == "Bündnis 90/Die Grünen", "Greens",
                                         ifelse(party == "Die Linke", "Left",
                                         ifelse(party == "Andere Partei", "Small party",
                                         ifelse(party == "Ungültig gewählt", "Invalid vote",
                                         ifelse(party == "Nicht gewählt", "No vote", party)))))) %>%
                          mutate(party = factor(party,
                                          levels = c("SPD", "Greens", "FDP", "Left","AfD", "Small party", "Invalid vote", "No vote"))) %>%
                          mutate(variable = ifelse(variable == "intercept", "Intercept",
                                                  ifelse(variable == "imputed", "Missing Prompt Variable",
                                                         variable)))

plot_vote_gpt_r <- ggplot(data_plot_vote_gpt_r, 
       aes(y = variable,
           x = mean_coeff,
           xmin = lower,
           xmax = upper,
           color = sig)) +  # legend colored by significance
  geom_vline(xintercept = 0, # reference line at 1 for OR, 0 for pure coeffs
             linetype = "solid",
             linewidth = 0.2) +
  geom_point(aes(color = sig), # point estimate
             size = 2) +
  geom_pointrange(linewidth = 0.5) + # error bars
  scale_color_manual(limits = c("Significant", "Not significant"),
                     values = c("Significant" = "#03A63C", "Not significant" = "#012340"),
                     labels = c("p < 0.05", "p > 0.05")) +
  scale_y_discrete(limits=c("Intercept", "Missing Prompt Variable")) +
  facet_grid(.~party) +
  theme_minimal() +
  labs(
    x = "ß (additive effect on log-odds)",
    y = "",
    title = "Impact of Absence of Prompt Variables on GPT Prediction") +
  theme(
        legend.position = "top",
        legend.title = element_blank())

ggsave("model_vote_gpt_r.png", plot_vote_gpt_r, height = 6, width = 8)

plot_vote_gpt_r
```

- Missing values have significant positive impact on likelihood for no-vote prediction --> GPT seems to need full set of information to make a "substantive" prediction (also in line with higher shares of empty completions in non-imputed sample - might be related: more NAs in > more NAs out > smaller sample > probably underestimating impact of non-imputation because higher share of NAs).
--> Distinction between predicting turnout and predicting vote choice should be researched in the future.

Omitted:

Should look into which missing variable plays a particular role here:

Among those respondents for whom we have 5 predictions (1755), highest amount of NAs for household income (193), followed by LR-ideology (94), with all other variables less than 20 missing values and no missing values on core demographics. Compared to the full sample, this implies that 33% of those with missing income and 18% of those with missing ideology don't have all completions.
--> Future work should investigate effect of missing variables on MISSING prediction, not just substantive prediction.

In main sample, income not predictive of vote choice (except non-voters, negative!?), ideology predictive

##### OMITTED: Create dummies for whether variables are missing, regress on match / vote.

```{r}
data_robustness_numeric_noNA <- data_robustness_numeric_noNA %>%
                                mutate(# no NAs on age, gender, education, east/west Germany
                                       emp_na = ifelse(is.na(emp), 1, 0), # 3 NAs almost perfect separation / no variance
                                       hhinc_na = ifelse(is.na(hhincome), 1, 0), # 193 NAs
                                       religious_na = ifelse(is.na(religious), 1, 0), # 9 NAs
                                       leftright_na = ifelse(is.na(leftright), 1, 0), # 94 NAs
                                       partyid_na = ifelse(is.na(partyid), 1, 0), # 14 NAs
                                       pid_degree_na = ifelse(is.na(partyid_degree), 1, 0), # 1 NA almost perfect separation / no variance
                                       inequality_na = ifelse(is.na(inequality), 1, 0), # 11 NAs
                                       immigration_na = ifelse(is.na(immigration), 1, 0) # 19 NAs
                                )

# Comparing to full sample
data_robustness_numeric <- data_robustness_numeric %>%
                                mutate(# no NAs on age, gender, east/west Germany
                                       edu_na = ifelse(is.na(edu), 1, 0), # 1 NA
                                       emp_na = ifelse(is.na(emp), 1, 0), # 3 NAs
                                       hhinc_na = ifelse(is.na(hhincome), 1, 0), # 248 NAs
                                       religious_na = ifelse(is.na(religious), 1, 0), # 15 NAs
                                       leftright_na = ifelse(is.na(leftright), 1, 0), # 114 NAs
                                       partyid_na = ifelse(is.na(partyid), 1, 0), # 27 NAs
                                       pid_degree_na = ifelse(is.na(partyid_degree), 1, 0), # 2 NAs
                                       inequality_na = ifelse(is.na(inequality), 1, 0), # 16 NAs
                                       immigration_na = ifelse(is.na(immigration), 1, 0) # 26 NAs
                                )

model_vote_r <- multinom(vote_gpt ~ hhinc_na + leftright_na + immigration_na + partyid_na + inequality_na + religious_na + emp_na + pid_degree_na, data = data_robustness_numeric_noNA)

ggcoef_multinom(model_vote_r, type = "faceted")

```

Quick pooled regression reveals that missing hhinc has significant negative impact on SPD & Grüne as well as non-voter likelihood, ideology (mostly) negative on likelihood for all except invalid voters, immigration on FDP, AfD, and Small party, 
--> How can pid_degree be sig with only 5/1 observations?
Even though hhinc not predictive in main study, many missing values which have negative impact on likelihood of not voting (even though share of non-voters higher in robustenss sample!?)
--> How can 0/1 vars be sig when substantive values not sig in main sample?

## Patterns in missing completions / NA Analysis

### Distribution of NAs across samples

Sample 4 has more NAs than others! 15 on average (not counting S4), but S4 has 27

In robustness samples:
More NAs in general, but again sample 4 has more than others (43 vs. 50)

```{r}
table(mc_GLES2017_final$sample_no, is.na(mc_GLES2017_final$vote_gpt))

table(mc_GLES2017_robustness$sample_no, is.na(mc_GLES2017_robustness$vote_gpt))
```

### Distribution of NAs across individuals

There are 78 individuals with NAs, 9 of which have NAs in 2 samples, resulting in 87 NAs overall.

Robustness: 150 unique, 114 with at least 2 NAs (mostly 2, but up to 5), 222 overall.
33 with 2
10 with 3
2 with 4
2 with 5

```{r}
gpt_NAs <- data_final_numeric[is.na(data_final_numeric$vote_gpt), "id"]
n_distinct(gpt_NAs) # 78 --> 9 with 2 NAs: 864, 972, 1123, 1425, 1490, 1495, 1655, 1842, 2081

gpt_NAs_r <- data_robustness_numeric[is.na(data_robustness_numeric$vote_gpt), "id"]
n_distinct(gpt_NAs_r) # 150! --> 114 with at least 2 NAs
```

#### NAs vs. non-NAs: prompt variables

```{r}
data_NAs <- data_final_numeric %>%
            group_by(id) %>%
            mutate(missing = ifelse(any(is.na(vote_gpt)), 1, 0)) %>% # mark all IDs with at least 1 NA
            summarise(across(everything(), first)) %>%
            ungroup() %>%
            mutate(missing_2 = ifelse(id == 864 | id == 972 | id == 1123 | id == 1425 | id == 1490 | id == 1495 | id == 1655 | id == 1842 | id == 2081, 1, 0)) # double-NAs

prop.table(table(data_NAs$female, data_NAs$missing),2) # 50/50 among NAs, slightly more females than among non-NAs
prop.table(table(data_NAs$edu, data_NAs$missing),2) # Slightly more better-educated people than among non-NAs
prop.table(table(data_NAs$emp, data_NAs$missing),2) # Much more working among NAs, less non-working 
prop.table(table(data_NAs$hhincome, data_NAs$missing),2) # Much fewer people with low income, much more with medium among NAs!
prop.table(table(data_NAs$east, data_NAs$missing),2) # Slightly more people from East Germany among NAs
prop.table(table(data_NAs$religious, data_NAs$missing),2) # NAs less religious
prop.table(table(data_NAs$leftright, data_NAs$missing),2) # less left/right, much more middle
prop.table(table(data_NAs$partyid, data_NAs$missing),2) # less CDU/CSU, SPD, FDP, Left, no Greens/AfD, more small party, MUCH more no party
prop.table(table(data_NAs$partyid_degree, data_NAs$missing),2) # much more weakly! Much less strongly
prop.table(table(data_NAs$inequality, data_NAs$missing),2) # more neutrals, much less "don't act"
prop.table(table(data_NAs$immigration, data_NAs$missing),2) # much fewer foster, more neutrals & limit
prop.table(table(data_NAs$vote, data_NAs$missing),2) # much less CDU/CSU, SPD, more FDP, small party, invalid, no vote (same for Greens & AfD!)
prop.table(table(data_NAs$imputed, data_NAs$missing),2) # much less imputed cases!

mean(data_NAs$age[data_NAs$missing == 1]) # 47
mean(data_NAs$age[data_NAs$missing == 0]) # 51

## Robustness sample

data_NAs_r <- data_robustness_numeric %>%
            group_by(id) %>%
            mutate(missing = ifelse(any(is.na(vote_gpt)), 1, 0)) %>% # mark all IDs with at least 1 NA
            summarise(across(everything(), first)) %>%
            ungroup()

prop.table(table(data_NAs_r$female, data_NAs_r$missing),2) # 50/50 among NAs, more females than among non-NAs (more balanced!) - similar as main
prop.table(table(data_NAs_r$edu, data_NAs_r$missing),2) # Rather similar between NAs and non-NAs
prop.table(table(data_NAs_r$emp, data_NAs_r$missing),2) # Much more working among NAs, less non-working - similar as main
prop.table(table(data_NAs_r$hhincome, data_NAs_r$missing),2) # Fewer people with low income, more with medium among NAs - similar as main
prop.table(table(data_NAs_r$east, data_NAs_r$missing),2) # Less people from East Germany among NAs!
prop.table(table(data_NAs_r$religious, data_NAs_r$missing),2) # Much fewer not at all / very religious people among NAs
prop.table(table(data_NAs_r$leftright, data_NAs_r$missing),2) # less left/right, much more middle - similar as main
prop.table(table(data_NAs_r$partyid, data_NAs_r$missing),2) # less CDU/CSU, SPD, FDP, Left, no Greens/AfD, more small party, MUCH more no party - similar as main
prop.table(table(data_NAs_r$partyid_degree, data_NAs_r$missing),2) # much more weakly! Much less strongly - similar as main
prop.table(table(data_NAs_r$inequality, data_NAs_r$missing),2) # rather similar, less "don't act"
prop.table(table(data_NAs_r$immigration, data_NAs_r$missing),2) # much fewer foster, more neutrals & limit - similar to main
prop.table(table(data_NAs_r$vote, data_NAs_r$missing),2) # much less CDU/CSU, SPD, Greens, slightly more FDP, invalid, much more AfD, small party, no vote

mean(data_NAs_r$age[data_NAs_r$missing == 1]) # 47
mean(data_NAs_r$age[data_NAs_r$missing == 0]) # 52

```

## Ineligibility ("did not vote") due to age or other reasons

```{r}
data_novote <- data_final_numeric %>%
  filter(vote_gpt == "Nicht gewählt") %>%
  select(id, age, completion, vote_gpt, vote)

write.csv(data_novote, file = "GPT4PO_novote.csv")

# Manual coding & descriptive analysis of completions

exclude_ids <- c(14, 69, 92, 107, 115, 202, 224, 236, 257, 279, 286, 362, 365, 381, 383, 394, 412, 440, 458, 473, 525, 570, 600, 637, 716, 724, 767, 791, 909, 926, 955, 974, 1002, 1065, 1104, 1150, 1157, 1159, 1232, 1275, 1371, 1389, 1402, 1412, 1444, 1500, 1516, 1533, 1566, 1569, 1621, 1673, 1686, 1697, 1698, 1762, 1782, 1792, 1898, 1920, 1928, 1929, 1959, 1977, 1990, 1996, 1998, 2007, 2032, 2040, 2091, 2093, 2107)

data_final_numeric_exid <- data_final_numeric_noNA %>%
                           filter(!(id %in% exclude_ids)) # 3 already excluded due to missing completions before
```

### Analyses without those incorrectly considered ineligible

### Aggregate Distribution

```{r}
## Variance Estimation

# Calculate proportions and its variance for each iteration
sample_proportions_exid <- data_final_numeric_exid %>%
    group_by(sample_no, vote_gpt) %>%
    summarise(n = n(), .groups = "keep") %>%
    ungroup(vote_gpt) %>%
    mutate(prop_estimate = n / sum(n)) %>%
    mutate(prop_variance = prop_estimate * (1 - prop_estimate) / sum(n))

# Calculate the between-iteration variance and total variance
mean_proportions_exid <- sample_proportions_exid %>%
    group_by(vote_gpt) %>%
    summarise(W = mean(prop_variance), # Within variance (mean)
              mean_prop = mean(prop_estimate),
              B = var(prop_estimate)) %>% # Between variance
    mutate(m = 5,
           T = W + (1 + 1/m) * B,
           T_stderr= sqrt(T)) %>% # total variance (Rubin's rules) 
    arrange(desc(mean_prop))

## Plot

#GLES

## Filter the dataset for a specific sample_no
data_vote_1_exid <- subset(data_final_numeric_exid, sample_no == 1)

## Calculate the relative frequencies of each category
table_vote_freq_1_exid <- prop.table(table(data_vote_1_exid$vote))

## Sort the categories based on their frequencies
data_vote_freq_1_sorted_exid <- as.data.frame(table_vote_freq_1_exid[order(table_vote_freq_1_exid, decreasing = TRUE)])

data_vote_freq_1_sorted_exid <- data_vote_freq_1_sorted_exid %>%
                           rename(party = Var1) %>%
                           mutate(source = "GLES") %>%
                           mutate(source = as.factor(source)) %>%
                           mutate(T_stderr = NA) %>%
                           rename(freq = Freq)

# Adjust GPT
mean_proportions_df_exid <- mean_proportions_exid %>%
                       select(vote_gpt, mean_prop, T_stderr) %>%
                       rename(party = vote_gpt) %>%
                       rename(freq = mean_prop) %>%
                       replace_na(list(party = "no prediction")) %>%
                       mutate(source = "GPT") %>%
                       #mutate(party = as.factor(party)) %>%
                       mutate(source = factor(source, levels = c("GLES", "GPT")))

# Adjust GLES
data_vote_freq_exid <- data_vote_freq_1_sorted_exid %>%
                  mutate(T_stderr = sqrt(freq * (1-freq)/1905)) %>% # SE if GLES eligible voters could be treated unweighted
                  add_row(party = "no prediction", freq = 0, source = "GLES",
                          T_stderr = NA
                          ) %>%
                  mutate(source = factor(source, levels = c("GLES", "GPT")))

# Merge GLES & GPT, remove small percentage of "no prediction"
data_vote_parties_exid <- bind_rows(mean_proportions_df_exid, data_vote_freq_exid)
data_vote_parties_exid <- data_vote_parties_exid %>%
                      mutate(party = ifelse(party == "Bündnis 90/Die Grünen", "Greens",
                                        ifelse(party == "Die Linke", "Left",
                                        ifelse(party== "Andere Partei", "Small party",
                                        ifelse(party == "Ungültig gewählt", "Invalid vote",
                                        ifelse(party == "Nicht gewählt", "No vote", party))))))  %>%
                      mutate(party = as.factor(party))
data_vote_parties <- data_vote_parties[data_vote_parties$party!="no prediction" , ]

plot_shares_aggregate_exid <- ggplot(data_vote_parties_exid, aes(x = party,
                                                           y = freq,
                                                           fill = source)) +
                      geom_bar(stat = "identity", position = "dodge") +
                      geom_text(aes(label = round(freq*100,1),
                                    y = freq + (1.96*T_stderr) + 0.005), 
                                position = position_dodge(0.9),
                                vjust = 0,
                                color = "#012340") +
                      xlab("") +
                      ylab("") +
                      scale_x_discrete(limits = c("CDU/CSU", "SPD", "Greens", "FDP", "Left",
                                                  "AfD", "Small party", "Invalid vote",
                                                  "No vote")) + # reorder categories
                      scale_y_continuous(labels = scales::percent) +
                      scale_fill_manual(limits = c("GLES", "GPT"),
                                        values = c("GLES" = "#027333", "GPT" = "#FAA32B"),
                                        labels = c("GLES",
                                                   "GPT-3"),
                                        name = "Reported vote choice \naccording to") +
                      geom_errorbar(aes(x=party,
                                        ymin=freq-(1.96*T_stderr),
                                        ymax=freq+(1.96*T_stderr)),
                                    #data = subset(data_vote_parties, source == "GPT"), # toggle on / off for GLES CIs; Problem: then CIs centered across sources!
                                    width=0.4,
                                    colour = "#012340",
                                    position = position_dodge(width = 0.9)) +
                      ggtitle("") +
                      theme_minimal() +
                      theme(legend.position = "top",
                            legend.title.align = 1,
                            axis.text.x = element_text(colour = "black"),
                            axis.text.y = element_text(colour = "black"),
                            panel.grid.minor = element_blank(),
                            panel.grid.major = element_blank())


ggsave("shares_aggregate_exid.png", plot_shares_aggregate_exid, height = 4, width = 8)
```

### F1

```{r}
### Recall

# Calculate proportions and its variance for each iteration
sample_proportions_match_party_exid <- data_final_numeric_exid %>%
    group_by(sample_no, match_vote_outcome, vote) %>%
    summarise(n = n(), .groups = "keep") %>%
    ungroup(match_vote_outcome) %>%
    mutate(prop_estimate = n / sum(n)) %>%
    mutate(prop_variance = prop_estimate * (1 - prop_estimate) / sum(n))

# Calculate the between-iteration variance and total variance
mean_proportions_match_party_exid <- sample_proportions_match_party_exid %>%
    group_by(match_vote_outcome, vote) %>%
    summarise(W = mean(prop_variance), # Within variance (mean)
              mean_prop = mean(prop_estimate),
              B = var(prop_estimate)) %>% # Between variance
    mutate(m = 5,
           T = W + (1 + 1/m) * B,
           T_stderr= sqrt(T)) %>% # total variance (Rubin's rules) 
    arrange(desc(mean_prop))

data_recall_varest_exid <- mean_proportions_match_party_exid %>%
                         filter(match_vote_outcome == TRUE) %>%
                         select(vote, W, mean_prop, B, T_stderr) %>%
                         rename(recall = mean_prop,
                                recall_W = W,
                                recall_B = B,
                                recall_totalse = T_stderr,
                                party = vote)


### Precision

# Calculate proportions and its variance for each iteration
sample_proportions_match_gpt_exid <- data_final_numeric_exid %>%
    group_by(sample_no, match_vote_outcome, vote_gpt) %>%
    summarise(n = n(), .groups = "keep") %>%
    ungroup(match_vote_outcome) %>%
    mutate(prop_estimate = n / sum(n)) %>%
    mutate(prop_variance = prop_estimate * (1 - prop_estimate) / sum(n))

# Calculate the between-iteration variance and total variance
mean_proportions_match_gpt_exid <- sample_proportions_match_gpt_exid %>%
    group_by(match_vote_outcome, vote_gpt) %>%
    summarise(W = mean(prop_variance), # Within variance (mean)
              mean_prop = mean(prop_estimate),
              B = var(prop_estimate)) %>% # Between variance
    mutate(m = 5,
           T = W + (1 + 1/m) * B,
           T_stderr= sqrt(T)) %>% # total variance (Rubin's rules) 
    arrange(desc(mean_prop))

data_precision_varest_exid <- mean_proportions_match_gpt_exid %>%
                         filter(match_vote_outcome == TRUE) %>%
                         select(vote_gpt, W, mean_prop, B, T_stderr) %>%
                         rename(precision = mean_prop,
                                precision_W = W,
                                precision_B = B,
                                precision_totalse = T_stderr,
                                party = vote_gpt)

### F1

data_f1_varest_exid <- merge(data_precision_varest_exid, data_recall_varest_exid, by = "party")

data_f1_varest_exid <- data_f1_varest_exid %>%
                  mutate(f1 = (2*precision*recall) / (precision + recall)) %>%
                  select(!c(match_vote_outcome.x, match_vote_outcome.y))
```

### Match Regression

```{r}
# Sample 1
model_match_1_exid <- glm(match_vote_outcome ~ vote + age + female + edu + emp + hhincome + east + religious + leftright + partyid_degree*partyid + inequality + immigration,
                   data=data_final_numeric_exid[data_final_numeric_exid$sample_no == 1, ],
                   family=binomial(link=logit))


# Sample 2
model_match_2_exid <- glm(match_vote_outcome ~ vote + age + female + edu + emp + hhincome + east + religious + leftright + partyid_degree*partyid + inequality + immigration,
                   data=data_final_numeric_exid[data_final_numeric_exid$sample_no == 2, ],
                   family=binomial(link=logit))


# Sample 3
model_match_3_exid <- glm(match_vote_outcome ~ vote+ age + female + edu + emp + hhincome + east + religious + leftright + partyid_degree*partyid + inequality + immigration,
                   data=data_final_numeric_exid[data_final_numeric_exid$sample_no == 3, ],
                   family=binomial(link=logit))


# Sample 4
model_match_4_exid <- glm(match_vote_outcome ~ vote + age + female + edu + emp + hhincome + east + religious + leftright + partyid_degree*partyid + inequality + immigration,
                   data=data_final_numeric_exid[data_final_numeric_exid$sample_no == 4, ],
                   family=binomial(link=logit))


# Sample 5
model_match_5_exid <- glm(match_vote_outcome ~ vote + age + female + edu + emp + hhincome + east + religious + leftright + partyid_degree*partyid + inequality + immigration,
                   data=data_final_numeric_exid[data_final_numeric_exid$sample_no == 5, ],
                   family=binomial(link=logit))


### Data transformation

# Store as 1 df per sample

## Sample 1
data_model_match_1_exid <- summary(model_match_1_exid)$coefficients %>%
                           as.data.frame() %>%
                           rownames_to_column("variable") %>%
                           mutate(variable = (ifelse(variable == "(Intercept)",
                                                     "intercept",
                                                     variable))) %>%
                           rename(coeff = Estimate) %>%
                           rename(stderr = "Std. Error") %>%
                           rename(z_value = "z value") %>%
                           rename(p_value = "Pr(>|z|)") %>%
                           mutate(sample = 1)

data_model_match_2_exid <- summary(model_match_2_exid)$coefficients %>%
                           as.data.frame() %>%
                           rownames_to_column("variable") %>%
                           mutate(variable = (ifelse(variable == "(Intercept)",
                                                     "intercept",
                                                     variable))) %>%
                           rename(coeff = Estimate) %>%
                           rename(stderr = "Std. Error") %>%
                           rename(z_value = "z value") %>%
                           rename(p_value = "Pr(>|z|)") %>%
                           mutate(sample = 2)


data_model_match_3_exid <- summary(model_match_3_exid)$coefficients %>%
                           as.data.frame() %>%
                           rownames_to_column("variable") %>%
                           mutate(variable = (ifelse(variable == "(Intercept)",
                                                     "intercept",
                                                     variable))) %>%
                           rename(coeff = Estimate) %>%
                           rename(stderr = "Std. Error") %>%
                           rename(z_value = "z value") %>%
                           rename(p_value = "Pr(>|z|)") %>%
                           mutate(sample = 3)

data_model_match_4_exid <- summary(model_match_4_exid)$coefficients %>%
                           as.data.frame() %>%
                           rownames_to_column("variable") %>%
                           mutate(variable = (ifelse(variable == "(Intercept)",
                                                     "intercept",
                                                     variable))) %>%
                           rename(coeff = Estimate) %>%
                           rename(stderr = "Std. Error") %>%
                           rename(z_value = "z value") %>%
                           rename(p_value = "Pr(>|z|)") %>%
                           mutate(sample = 4)

data_model_match_5_exid <- summary(model_match_5_exid)$coefficients %>%
                           as.data.frame() %>%
                           rownames_to_column("variable") %>%
                           mutate(variable = (ifelse(variable == "(Intercept)",
                                                     "intercept",
                                                     variable))) %>%
                           rename(coeff = Estimate) %>%
                           rename(stderr = "Std. Error") %>%
                           rename(z_value = "z value") %>%
                           rename(p_value = "Pr(>|z|)") %>%
                           mutate(sample = 5)

# Merge in one df across samples
data_model_match_all_exid <- bind_rows(data_model_match_1_exid, data_model_match_2_exid, data_model_match_3_exid, data_model_match_4_exid, data_model_match_5_exid)
data_model_match_all_exid <- data_model_match_all_exid %>% rename(sample_no = sample) # for consistency

### Aggregation

data_model_match_mean_exid <- data_model_match_all_exid %>%
    group_by(variable) %>%
    summarise(W_coeff = mean(stderr^2), # Within variance OF COEFFICIENT (mean)
              mean_coeff = mean(coeff), # Mean estimate (coefficient)
              B_coeff = var(coeff), # Between variance (coefficient)
              mean_stderr = mean(stderr), # Mean estimate (stderr)
              B_stderr = var(stderr), # Between variance (stderr)
              mean_p = mean(p_value), # Mean estimate (p-value)
              B_p = var(p_value)) %>% # Between variance (p-value)
    mutate(m = 5,
           T = W_coeff + (1 + 1/m) * B_coeff, # total variance (Rubin's rules) OF COEFFICIENT
           T_stderr= sqrt(T)) # standard error OF COEFFICIENT --> to be used for CIs



# Export
export_match_exid <- data_model_match_mean_exid %>%
                   select(variable, mean_coeff, mean_p, T_stderr) %>%
                   mutate(mean_coeff = round(mean_coeff, digits = 3)) %>%
                   mutate(mean_p = round(mean_p, digits = 3)) %>%
                   mutate(T_stderr = round(T_stderr, digits = 3))


### Plot

data_plot_match_exid <- export_match_exid %>%
                          filter(!(is.na(T_stderr))) %>%
                          mutate(lower = mean_coeff - 1.96*T_stderr,
                                 upper = mean_coeff + 1.96*T_stderr,
                                 oddsratio = exp(mean_coeff)) %>%
                          mutate(lower_or = exp(lower),
                                 upper_or = exp(upper)) %>%
                          mutate(sig = ifelse(lower_or > 1 | upper_or < 1, "Significant",
                                              "Not significant")) %>%
                          rename(category = variable) %>%
                          mutate(variable = ifelse(category == "intercept", "Intercept",
                                            ifelse(category == "voteAfD" | category == "voteAndere Partei" | category == "voteBündnis 90/Die Grünen" | category == "voteDie Linke" | category == "voteFDP" | category == "voteNicht gewählt" | category == "voteSPD" | category == "voteUngültig gewählt", "GLES-Vote (Ref.: CDU/CSU)",
                                            ifelse(category == "age", "Age",
                                            ifelse(category == "femaleweiblich", "Gender (Ref.: male)",
                                            ifelse(category == "edu", "Education",
                                            ifelse(category == "empnicht berufstätig" | category == "empin Ausbildung", "Employment (Ref.: working)",
                                            ifelse(category == "hhincomemittleres" | category == "hhincomehohes", "Income (Ref.: low)",
                                            ifelse(category == "eastOstdeutschland", "Residence (Ref.: West Germany)",
                                            ifelse(category == "religiousnicht sehr religiös" | category == "religiousetwas religiös" | category == "religioussehr religiös", "Religiosity (Ref.: not at all)",
                                            ifelse(category == "leftright", "Ideology",
                                            ifelse(category == "partyidSPD"| category == "partyidFDP" | category == "partyidDie Grünen" | category == "partyidDie Linke" | category == "partyidAfD" | category == "partyidKleinpartei"| category == "partyidkeine Partei", "Party ID (Ref.: CDU/CSU)",
                                            ifelse(category == "partyid_degree", "Strength of Party ID",
                                            ifelse(category == "partyid_degree:partyidAfD" | category == "partyid_degree:partyidDie Grünen" | category == "partyid_degree:partyidDie Linke" | category == "partyid_degree:partyidFDP" | category == "partyid_degree:partyidKleinpartei" | category == "partyid_degree:partyidSPD", "Party ID x Strength (Ref.: CDU/CSU)",        
                                            ifelse(category == "inequalityhabe keine Meinung dazu" | category == "inequalitykeine Maßnahmen ergreifen", "Att. Inequality (Ref.: take measures)",         
                                            ifelse(category == "immigrationweder erleichtern noch einschränken" | category == "immigrationeinschränken", "Att. Immigration (Ref.: facilitate)",
                                            category)))))))))))))))) %>%
                          mutate(category = ifelse(category == "femaleweiblich", "female",
                                        ifelse(category == "edu", " ",
                                        ifelse(category == "age", " ",
                                        ifelse(category == "empnicht berufstätig", "not working",
                                        ifelse(category == "empin Ausbildung", "studying",
                                        ifelse(category == "hhincomemittleres", "medium",
                                        ifelse(category == "hhincomehohes", "high",
                                        ifelse(category == "eastOstdeutschland", "East Germany",
                                        ifelse(category == "religiousnicht sehr religiös", "not very",
                                        ifelse(category == "religiousetwas religiös", "somewhat",
                                        ifelse(category == "religioussehr religiös", "very",
                                        ifelse(category == "leftright", " ",
                                        ifelse(category == "partyidSPD", "SPD",
                                        ifelse(category == "partyidFDP", "FDP",
                                        ifelse(category == "partyidDie Grünen", "Greens",
                                        ifelse(category == "partyidDie Linke", "Left",
                                        ifelse(category == "partyidAfD", "AfD",
                                        ifelse(category == "partyidKleinpartei", "Small party",
                                        ifelse(category == "partyidkeine Partei", "none",
                                        ifelse(category == "partyid_degree", " ",
                                        ifelse(category == "inequalityhabe keine Meinung dazu", "no opinion",
                                        ifelse(category == "inequalitykeine Maßnahmen ergreifen", "don't take measures",
                                        ifelse(category == "immigrationweder erleichtern noch einschränken", "neither nor",
                                        ifelse(category == "immigrationeinschränken", "limit",
                                        ifelse(category == "intercept", " ",
                                        ifelse(category == "partyid_degree:partyidAfD", "AfD",
                                        ifelse(category == "partyid_degree:partyidDie Grünen", "Greens",
                                        ifelse(category == "partyid_degree:partyidDie Linke", "Left",
                                        ifelse(category == "partyid_degree:partyidFDP", "FDP",
                                        ifelse(category == "partyid_degree:partyidKleinpartei", "Small party",
                                        ifelse(category == "partyid_degree:partyidSPD", "SPD",
                                        ifelse(category == "voteAfD", "AfD",
                                        ifelse(category == "voteAndere Partei","Small party",
                                        ifelse(category == "voteBündnis 90/Die Grünen", "Greens",
                                        ifelse(category == "voteDie Linke", "Left",
                                        ifelse(category == "voteFDP", "FDP",
                                        ifelse(category == "voteNicht gewählt", "No vote",
                                        ifelse(category == "voteSPD", "SPD",
                                        ifelse(category == "voteUngültig gewählt", "Invalid vote",
                                        category)))))))))))))))))))))))))))))))))))))))) %>%
  mutate(interaction_cat_var = interaction(category, variable, sep = "&")) %>%
  mutate(interaction_cat_var = factor(interaction_cat_var,
                                      levels = c(" &Intercept",
                                                 "No vote&GLES-Vote (Ref.: CDU/CSU)", "Small party&GLES-Vote (Ref.: CDU/CSU)", "AfD&GLES-Vote (Ref.: CDU/CSU)", "Left&GLES-Vote (Ref.: CDU/CSU)", "FDP&GLES-Vote (Ref.: CDU/CSU)", "Greens&GLES-Vote (Ref.: CDU/CSU)", "SPD&GLES-Vote (Ref.: CDU/CSU)",
                                                 "limit&Att. Immigration (Ref.: facilitate)", "neither nor&Att. Immigration (Ref.: facilitate)",
                                                "don't take measures&Att. Inequality (Ref.: take measures)", "no opinion&Att. Inequality (Ref.: take measures)",
                                                "Small party&Party ID x Strength (Ref.: CDU/CSU)", "AfD&Party ID x Strength (Ref.: CDU/CSU)", "Left&Party ID x Strength (Ref.: CDU/CSU)", "FDP&Party ID x Strength (Ref.: CDU/CSU)", "Greens&Party ID x Strength (Ref.: CDU/CSU)", "SPD&Party ID x Strength (Ref.: CDU/CSU)",
                                                 " &Strength of Party ID",
                                                 "none&Party ID (Ref.: CDU/CSU)", "Small party&Party ID (Ref.: CDU/CSU)", "AfD&Party ID (Ref.: CDU/CSU)", "Left&Party ID (Ref.: CDU/CSU)", "FDP&Party ID (Ref.: CDU/CSU)", "Greens&Party ID (Ref.: CDU/CSU)", "SPD&Party ID (Ref.: CDU/CSU)",
                                                 " &Ideology",
                                                 "very&Religiosity (Ref.: not at all)", "somewhat&Religiosity (Ref.: not at all)", "not very&Religiosity (Ref.: not at all)",
                                                 "East Germany&Residence (Ref.: West Germany)",
                                                 "high&Income (Ref.: low)", "medium&Income (Ref.: low)",
                                                "not working&Employment (Ref.: working)", "studying&Employment (Ref.: working)",
                                                 " &Education",
                                                 "female&Gender (Ref.: male)",
                                                 " &Age")
  ))

plot_model_match_exid <- ggplot(drop_na(data_plot_match_exid), 
       aes(y= interaction_cat_var,
           x = mean_coeff,
           xmin = lower,
           xmax = upper,
           color = sig)) + # legend colored by significance
  geom_vline(xintercept = 0,
             linetype = "solid",
             linewidth = 0.2) +
  geom_point(aes(color = sig), # point estimate
             size = 2) +
  geom_pointrange(linewidth = 0.5) + # error bars
  xlim(-7.5, 10) + # When using pure betas and removing Vote (GLES): Invalid
  guides(y = guide_axis_nested(delim = "&")) + 
  scale_color_manual(limits = c("Significant", "Not significant"),
                     values = c("Significant" = "#03A63C",
                                 "Not significant" = "#012340"),
                     labels = c("p < 0.05", "p > 0.05")) +
  theme_minimal() +
  labs(
    x = "ß (additive effect on log-odds)",
    y = "",
    title = "Determinants of Matching Vote Choice Between GLES and GPT") +
  theme(
        legend.position = "top",
        legend.title = element_blank(),
        plot.title.position = "plot"
        )

ggsave("model_match_exid.png", plot_model_match_exid, height = 6, width = 8)

```

### OMITTED: Vote Regression

```{r}

# If original == sig & new != sig
# If original != sig & new == sig
# If original == sig & new == sig & original < 0 & new > 0
# If original == sig & new == sig & original > 0 & new < 0

```

## Regression on match without invalid

```{r}

data_final_numeric_inv <- data_final_numeric_noNA %>%
                          filter(!(vote == "Ungültig gewählt")) # excludes 50 observations / 10 unique individuals

### Regressions

# Sample 1
model_match_1_inv <- glm(match_vote_outcome ~ vote + age + female + edu + emp + hhincome + east + religious + leftright + partyid_degree*partyid + inequality + immigration,
                   data=data_final_numeric_inv[data_final_numeric_inv$sample_no == 1, ],
                   family=binomial(link=logit))

## Get coeffs & stderrs
#summary(model_match_1_inv)
#coef(model_match_1_inv)

## Get n: 1817
#length(model_match_1_inv$residuals)


# Sample 2
model_match_2_inv <- glm(match_vote_outcome ~ vote + age + female + edu + emp + hhincome + east + religious + leftright + partyid_degree*partyid + inequality + immigration,
                   data=data_final_numeric_inv[data_final_numeric_inv$sample_no == 2, ],
                   family=binomial(link=logit))

## Get coeffs & stderrs
#summary(model_match_2_inv)
#coef(model_match_2_inv)

## Get n: 1817
#length(model_match_inv$residuals)


# Sample 3
model_match_3_inv <- glm(match_vote_outcome ~ vote + age + female + edu + emp + hhincome + east + religious + leftright + partyid_degree*partyid + inequality + immigration,
                   data=data_final_numeric_inv[data_final_numeric_inv$sample_no == 3, ],
                   family=binomial(link=logit))

## Get coeffs & stderrs
#summary(model_match_3_inv)
#coef(model_match_3_inv)

## Get n: 1817
#length(model_match_3_inv$residuals)


# Sample 4
model_match_4_inv <- glm(match_vote_outcome ~ vote + age + female + edu + emp + hhincome + east + religious + leftright + partyid_degree*partyid + inequality + immigration,
                   data=data_final_numeric_inv[data_final_numeric_inv$sample_no == 4, ],
                   family=binomial(link=logit))

## Get coeffs & stderrs
#summary(model_match_4_inv)
#coef(model_match_4_inv)

## Get n: 1817
#length(model_match_4_inv$residuals)


# Sample 5
model_match_5_inv <- glm(match_vote_outcome ~ vote + age + female + edu + emp + hhincome + east + religious + leftright + partyid_degree*partyid + inequality + immigration,
                   data=data_final_numeric_inv[data_final_numeric_inv$sample_no == 5, ],
                   family=binomial(link=logit))

## Get coeffs & stderrs
#summary(model_match_5_inv)
#coef(model_match_5_inv)

## Get n: 1817
#length(model_match_5_inv$residuals)


### Data transformation

# Store as 1 df per sample

## Sample 1
data_model_match_1_inv <- summary(model_match_1_inv)$coefficients %>%
                           as.data.frame() %>%
                           rownames_to_column("variable") %>%
                           mutate(variable = (ifelse(variable == "(Intercept)",
                                                     "intercept",
                                                     variable))) %>%
                           rename(coeff = Estimate) %>%
                           rename(stderr = "Std. Error") %>%
                           rename(z_value = "z value") %>%
                           rename(p_value = "Pr(>|z|)") %>%
                           mutate(sample = 1)

data_model_match_2_inv <- summary(model_match_2_inv)$coefficients %>%
                           as.data.frame() %>%
                           rownames_to_column("variable") %>%
                           mutate(variable = (ifelse(variable == "(Intercept)",
                                                     "intercept",
                                                     variable))) %>%
                           rename(coeff = Estimate) %>%
                           rename(stderr = "Std. Error") %>%
                           rename(z_value = "z value") %>%
                           rename(p_value = "Pr(>|z|)") %>%
                           mutate(sample = 2)


data_model_match_3_inv <- summary(model_match_3_inv)$coefficients %>%
                           as.data.frame() %>%
                           rownames_to_column("variable") %>%
                           mutate(variable = (ifelse(variable == "(Intercept)",
                                                     "intercept",
                                                     variable))) %>%
                           rename(coeff = Estimate) %>%
                           rename(stderr = "Std. Error") %>%
                           rename(z_value = "z value") %>%
                           rename(p_value = "Pr(>|z|)") %>%
                           mutate(sample = 3)

data_model_match_4_inv <- summary(model_match_4_inv)$coefficients %>%
                           as.data.frame() %>%
                           rownames_to_column("variable") %>%
                           mutate(variable = (ifelse(variable == "(Intercept)",
                                                     "intercept",
                                                     variable))) %>%
                           rename(coeff = Estimate) %>%
                           rename(stderr = "Std. Error") %>%
                           rename(z_value = "z value") %>%
                           rename(p_value = "Pr(>|z|)") %>%
                           mutate(sample = 4)

data_model_match_5_inv <- summary(model_match_5_inv)$coefficients %>%
                           as.data.frame() %>%
                           rownames_to_column("variable") %>%
                           mutate(variable = (ifelse(variable == "(Intercept)",
                                                     "intercept",
                                                     variable))) %>%
                           rename(coeff = Estimate) %>%
                           rename(stderr = "Std. Error") %>%
                           rename(z_value = "z value") %>%
                           rename(p_value = "Pr(>|z|)") %>%
                           mutate(sample = 5)

# Merge in one df across samples
data_model_match_all_inv <- bind_rows(data_model_match_1_inv, data_model_match_2_inv, data_model_match_3_inv, data_model_match_4_inv, data_model_match_5_inv)
data_model_match_all_inv <- data_model_match_all_inv %>% rename(sample_no = sample) # for consistency

### Aggregation

data_model_match_mean_inv <- data_model_match_all_inv %>%
    group_by(variable) %>%
    summarise(W_coeff = mean(stderr^2), # Within variance OF COEFFICIENT (mean)
              mean_coeff = mean(coeff), # Mean estimate (coefficient)
              B_coeff = var(coeff), # Between variance (coefficient)
              mean_stderr = mean(stderr), # Mean estimate (stderr)
              B_stderr = var(stderr), # Between variance (stderr)
              mean_p = mean(p_value), # Mean estimate (p-value)
              B_p = var(p_value)) %>% # Between variance (p-value)
    mutate(m = 5,
           T = W_coeff + (1 + 1/m) * B_coeff, # total variance (Rubin's rules) OF COEFFICIENT
           T_stderr= sqrt(T)) # standard error OF COEFFICIENT --> to be used for CIs



# Export
export_match_inv <- data_model_match_mean_inv %>%
                   select(variable, mean_coeff, mean_p, T_stderr) %>%
                   mutate(mean_coeff = round(mean_coeff, digits = 3)) %>%
                   mutate(mean_p = round(mean_p, digits = 3)) %>%
                   mutate(T_stderr = round(T_stderr, digits = 3))


### Plot

data_plot_match_inv <- export_match_inv %>%
                          filter(!(is.na(T_stderr))) %>%
                          mutate(lower = mean_coeff - 1.96*T_stderr,
                                 upper = mean_coeff + 1.96*T_stderr,
                                 oddsratio = exp(mean_coeff)) %>%
                          mutate(lower_or = exp(lower),
                                 upper_or = exp(upper)) %>%
                          mutate(sig = ifelse(lower_or > 1 | upper_or < 1, "Significant",
                                              "Not significant")) %>%
                          rename(category = variable) %>%
                          mutate(variable = ifelse(category == "intercept", "Incercept",
                                            ifelse(category == "voteAfD" | category == "voteAndere Partei" | category == "voteBündnis 90/Die Grünen" | category == "voteDie Linke" | category == "voteFDP" | category == "voteNicht gewählt" | category == "voteSPD", "GLES-Vote (Ref.: CDU/CSU)",
                                            ifelse(category == "age", "Age",
                                            ifelse(category == "femaleweiblich", "Gender (Ref.: male)",
                                            ifelse(category == "edu", "Education",
                                            ifelse(category == "empnicht berufstätig" | category == "empin Ausbildung", "Employment (Ref.: working)",
                                            ifelse(category == "hhincomemittleres" | category == "hhincomehohes", "Income (Ref.: low)",
                                            ifelse(category == "eastOstdeutschland", "Residence (Ref.: West Germany)",
                                            ifelse(category == "religiousnicht sehr religiös" | category == "religiousetwas religiös" | category == "religioussehr religiös", "Religiosity (Ref.: not at all)",
                                            ifelse(category == "leftright", "Ideology",
                                            ifelse(category == "partyidSPD"| category == "partyidFDP" | category == "partyidDie Grünen" | category == "partyidDie Linke" | category == "partyidAfD" | category == "partyidKleinpartei"| category == "partyidkeine Partei", "Party ID (Ref.: CDU/CSU)",
                                            ifelse(category == "partyid_degree", "Strength of Party ID",
                                            ifelse(category == "partyid_degree:partyidAfD" | category == "partyid_degree:partyidDie Grünen" | category == "partyid_degree:partyidDie Linke" | category == "partyid_degree:partyidFDP" | category == "partyid_degree:partyidKleinpartei" | category == "partyid_degree:partyidSPD", "Party ID x Strength (Ref.: CDU/CSU)",        
                                            ifelse(category == "inequalityhabe keine Meinung dazu" | category == "inequalitykeine Maßnahmen ergreifen", "Att. Inequality (Ref.: take measures)",         
                                            ifelse(category == "immigrationweder erleichtern noch einschränken" | category == "immigrationeinschränken", "Att. Immigration (Ref.: facilitate)",
                                            category)))))))))))))))) %>%
                          mutate(category = ifelse(category == "femaleweiblich", "female",
                                        ifelse(category == "edu", " ",
                                        ifelse(category == "age", " ",
                                        ifelse(category == "empnicht berufstätig", "not working",
                                        ifelse(category == "empin Ausbildung", "studying",
                                        ifelse(category == "hhincomemittleres", "medium",
                                        ifelse(category == "hhincomehohes", "high",
                                        ifelse(category == "eastOstdeutschland", "East Germany",
                                        ifelse(category == "religiousnicht sehr religiös", "not very",
                                        ifelse(category == "religiousetwas religiös", "somewhat",
                                        ifelse(category == "religioussehr religiös", "very",
                                        ifelse(category == "leftright", " ",
                                        ifelse(category == "partyidSPD", "SPD",
                                        ifelse(category == "partyidFDP", "FDP",
                                        ifelse(category == "partyidDie Grünen", "Greens",
                                        ifelse(category == "partyidDie Linke", "Left",
                                        ifelse(category == "partyidAfD", "AfD",
                                        ifelse(category == "partyidKleinpartei", "Small party",
                                        ifelse(category == "partyidkeine Partei", "none",
                                        ifelse(category == "partyid_degree", " ",
                                        ifelse(category == "inequalityhabe keine Meinung dazu", "no opinion",
                                        ifelse(category == "inequalitykeine Maßnahmen ergreifen", "don't take measures",
                                        ifelse(category == "immigrationweder erleichtern noch einschränken", "neither nor",
                                        ifelse(category == "immigrationeinschränken", "limit",
                                        ifelse(category == "intercept", " ",
                                        ifelse(category == "partyid_degree:partyidAfD", "AfD",
                                        ifelse(category == "partyid_degree:partyidDie Grünen", "Greens",
                                        ifelse(category == "partyid_degree:partyidDie Linke", "Left",
                                        ifelse(category == "partyid_degree:partyidFDP", "FDP",
                                        ifelse(category == "partyid_degree:partyidKleinpartei", "Small party",
                                        ifelse(category == "partyid_degree:partyidSPD", "SPD",
                                        ifelse(category == "voteAfD", "AfD",
                                        ifelse(category == "voteAndere Partei","Small party",
                                        ifelse(category == "voteBündnis 90/Die Grünen", "Greens",
                                        ifelse(category == "voteDie Linke", "Left",
                                        ifelse(category == "voteFDP", "FDP",
                                        ifelse(category == "voteNicht gewählt", "No vote",
                                        ifelse(category == "voteSPD", "SPD", category))))))))))))))))))))))))))))))))))))))) %>%
  mutate(interaction_cat_var = interaction(category, variable, sep = "&")) %>%
  mutate(interaction_cat_var = factor(interaction_cat_var,
                                      levels = c(" &Intercept",
                                                 "No vote&GLES-Vote (Ref.: CDU/CSU)", "Small party&GLES-Vote (Ref.: CDU/CSU)", "AfD&GLES-Vote (Ref.: CDU/CSU)", "Left&GLES-Vote (Ref.: CDU/CSU)", "FDP&GLES-Vote (Ref.: CDU/CSU)", "Greens&GLES-Vote (Ref.: CDU/CSU)", "SPD&GLES-Vote (Ref.: CDU/CSU)",
                                                 "limit&Att. Immigration (Ref.: facilitate)", "neither nor&Att. Immigration (Ref.: facilitate)",
                                                "don't take measures&Att. Inequality (Ref.: take measures)", "no opinion&Att. Inequality (Ref.: take measures)",
                                                "Small party&Party ID x Strength (Ref.: CDU/CSU)", "AfD&Party ID x Strength (Ref.: CDU/CSU)", "Left&Party ID x Strength (Ref.: CDU/CSU)", "FDP&Party ID x Strength (Ref.: CDU/CSU)", "Greens&Party ID x Strength (Ref.: CDU/CSU)", "SPD&Party ID x Strength (Ref.: CDU/CSU)",
                                                 " &Strength of Party ID",
                                                 "none&Party ID (Ref.: CDU/CSU)", "Small party&Party ID (Ref.: CDU/CSU)", "AfD&Party ID (Ref.: CDU/CSU)", "Left&Party ID (Ref.: CDU/CSU)", "FDP&Party ID (Ref.: CDU/CSU)", "Greens&Party ID (Ref.: CDU/CSU)", "SPD&Party ID (Ref.: CDU/CSU)",
                                                 " &Ideology",
                                                 "very&Religiosity (Ref.: not at all)", "somewhat&Religiosity (Ref.: not at all)", "not very&Religiosity (Ref.: not at all)",
                                                 "East Germany&Residence (Ref.: West Germany)",
                                                 "high&Income (Ref.: low)", "medium&Income (Ref.: low)",
                                                "not working&Employment (Ref.: working)", "studying&Employment (Ref.: working)",
                                                 " &Education",
                                                 "female&Gender (Ref.: male)",
                                                 " &Age")
  ))

plot_model_match_inv <- ggplot(drop_na(data_plot_match), 
       aes(y= interaction_cat_var,
           x = mean_coeff,
           xmin = lower,
           xmax = upper,
           color = sig)) + # legend colored by significance
  geom_vline(xintercept = 0,
             linetype = "solid",
             linewidth = 0.2) +
  geom_point(aes(color = sig), # point estimate
             size = 2) +
  geom_pointrange(linewidth = 0.5) + # error bars
  xlim(-7.5, 10) + # When using pure betas and removing Vote (GLES): Invalid
  guides(y = guide_axis_nested(delim = "&")) + 
  scale_color_manual(limits = c("Significant", "Not significant"),
                     values = c("Significant" = "#03A63C",
                                 "Not significant" = "#012340"),
                     labels = c("p < 0.05", "p > 0.05")) +
  theme_minimal() +
  labs(
    x = "ß (additive effect on log-odds)",
    y = "",
    title = "Determinants of Matching Vote Choice Between GLES and GPT") +
  theme(
        legend.position = "top",
        legend.title = element_blank(),
        plot.title.position = "plot"
        )

ggsave("model_match_inv.png", plot_model_match_inv, height = 6, width = 8)

plot_model_match_inv
```


# APPENDIX

## Summary Statistics

```{r}
data_final_numeric %>% filter(sample_no == 1) %>%
                       select(-c(id, id_sampleno, sample_no, party, prompt,
                                 starts_with(c("completion", "matched", "check_manually",
                                               "manipulated", "resampled")))) %>%
                       mutate(imputed = as.logical(imputed)) %>%
                       sumtable(vars = c("age", "female", "edu", "emp", "hhincome", "east", "religious", "leftright", "partyid", "partyid_degree", "inequality", "immigration", "vote", "imputed"),
                                add.median = TRUE,
                                out = "csv", file = "summarystats.csv",
                                title = "Summary Statistics: Prompt Variables",
                                digits = 2
                                )

data_final_numeric %>% select(c(imputed, vote, vote_gpt,
                                starts_with(c("manipulated", "resampled")))) %>%
                       mutate(imputed = as.logical(imputed)) %>%
                       mutate(across(starts_with("manipulated"), as.logical)) %>%
                       mutate(across(starts_with("resampled"), as.logical)) %>%
                       sumtable(vars = c("imputed", "vote", "vote_gpt", "manipulated",
                                         "resampled_1", "manipulated_1",
                                         "resampled_2", "manipulated_2"),
                                add.median = TRUE,
                                out = "csv", file = "stats_matching.csv",
                                title = "Summary Statistics: Matching",
                                digits = 2
                                )
```
